/*!
 * maptalks.three v0.20.0
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var r=i(e),o=i(n);const s=parseInt(o.REVISION.replace("dev",""));function a(t,e,n){return s>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function c(){return!o.VertexColors||o.VertexColors}console.log(`maptalks.three log: current three.js version is %c${s}`,"color:red;font-size: 16px;font-weight: bold;");class h extends o.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),a(this,"position",new o.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),a(this,"uv",new o.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new o.InstancedInterleavedBuffer(e,6,1);return a(this,"instanceStart",new o.InterleavedBufferAttribute(n,3,0)),a(this,"instanceEnd",new o.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new o.InstancedInterleavedBuffer(e,6,1);return a(this,"instanceColorStart",new o.InterleavedBufferAttribute(n,3,0)),a(this,"instanceColorEnd",new o.InterleavedBufferAttribute(n,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new o.WireframeGeometry(t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new o.Box3;null===this.boundingBox&&(this.boundingBox=new o.Box3);var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(n),this.boundingBox.union(t))}computeBoundingSphere(){var t=new o.Vector3;null===this.boundingSphere&&(this.boundingSphere=new o.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var i=this.boundingSphere.center;this.boundingBox.getCenter(i);for(var r=0,s=0,a=e.count;s<a;s++)t.fromBufferAttribute(e,s),r=Math.max(r,i.distanceToSquared(t)),t.fromBufferAttribute(n,s),r=Math.max(r,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}const l={},u={};l.line={linewidth:{value:1},resolution:{value:new o.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},u.line={uniforms:o.UniformsUtils.merge([o.UniformsLib.common,o.UniformsLib.fog,l.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class d extends o.ShaderMaterial{constructor(t){super({uniforms:o.UniformsUtils.clone(u.line.uniforms),vertexShader:u.line.vertexShader,fragmentShader:u.line.fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}class f extends o.Mesh{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new h,this.material=void 0!==e?e:new d({color:16777215*Math.random()})}computeLineDistances(){var t=new o.Vector3,e=new o.Vector3,n=this.geometry,i=n.attributes.instanceStart,r=n.attributes.instanceEnd;if(!i||!r)return this;for(var s=new Float32Array(2*i.data.count),c=0,h=0,l=i.data.count;c<l;c++,h+=2)t.fromBufferAttribute(i,c),e.fromBufferAttribute(r,c),s[h]=0===h?0:s[h-1],s[h+1]=s[h]+t.distanceTo(e);var u=new o.InstancedInterleavedBuffer(s,2,1);return a(n,"instanceDistanceStart",new o.InterleavedBufferAttribute(u,1,0)),a(n,"instanceDistanceEnd",new o.InterleavedBufferAttribute(u,1,1)),this}}class g extends h{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}class p extends f{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new g,this.material=void 0!==e?e:new d({color:16777215*Math.random()})}copy(t){return this}}const y={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1};function x(){}class v extends(r.Eventable(x)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=r.Util.GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:e,lineString:n,polygon:i}=t;if(e)return e instanceof r.Coordinate?e:new r.Coordinate(e);{const t=i||n;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(r.Util.isNumber(t)){const e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,n=this._baseObjects.length;t<n;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof o.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new r.ui.InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return(t=t||this.getCenter())instanceof r.Coordinate||(t=new r.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new r.ui.ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return(t=t||this.getCenter())instanceof r.Coordinate||(t=new r.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),r.Util.isFunction(t)&&(e=t={});const n=t.duration||1e3,i=t.easing||"out",o=this._showPlayer=r.animation.Animation.animate({scale:1},{duration:n,easing:i},(t=>{const n=t.styles.scale;n>0&&(this.getObject3d().scale.z=n),e&&e(t,n)}));return o.play(),o}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this}_initOptions(t){return this.options=r.Util.extend({},y,t),this}_createMesh(t,e){return this.object3d=new o.Mesh(t,e),this.object3d.__parent=this,this}_createGroup(){return this.object3d=new o.Group,this.object3d.__parent=this,this}_createLine(t,e){return this.object3d=new o.Line(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_createLine2(t,e){return this.object3d=new p(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this}_createPoints(t,e){return this.object3d=new o.Points(t,e),this.object3d.__parent=this,this}_createLineSegments(t,e){return this.object3d=new o.LineSegments(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this}_computeLineDistances(t){const e=t.attributes.position.array,n=t.attributes.position.count,i=new Float32Array(n);i[0]=0;const r=new o.Vector3(0,0,0),s=new o.Vector3(0,0,0);for(let t=1;t<n;t++){const n=3*(t-1);r.x=e[n],r.y=e[n+1],r.z=e[n+2];const o=3*t;s.x=e[o],s.y=e[o+1],s.z=e[o+2];const a=s.distanceTo(r);i[t]=i[t-1]+a}a(t,"lineDistance",new o.BufferAttribute(i,1))}}function m(t){const{position:e,normal:n,uv:i,indices:r}=b(t),s=new o.BufferGeometry,c=new Float32Array(e.length);return c.fill(1,0,e.length),a(s,"color",new o.BufferAttribute(c,3)),a(s,"normal",new o.BufferAttribute(n,3)),a(s,"position",new o.BufferAttribute(e,3)),i&&i.length&&a(s,"uv",new o.BufferAttribute(i,2)),s.setIndex(new o.BufferAttribute(r,1)),s}function b(t){const e={},n={};for(let i=0;i<t.length;++i){const r=t[i];for(const t in r)void 0===e[t]&&(e[t]=[],n[t]=0),e[t].push(r[t]),n[t]+=r[t].length}const i={};let r=0;const o=new Uint32Array(n.indices);for(const t in e)if("indices"===t){const n=e[t];let i=0;for(let t=0,s=n.length;t<s;t++){const s=n[t];for(let t=0,e=s.length;t<e;t++)o[i]=s[t]+r,i++;r+=e.position[t].length/3}}else{const r=_(e[t],n[t]);if(!r)return null;i[t]=r}return i.indices=o,i}function _(t,e){const n=new Float32Array(e);let i=0;for(let e=0;e<t.length;++e)n.set(t[e],i),i+=t[e].length;return n}function w(t){const{position:e,normal:n,uv:i,indices:r}=t,s=new o.BufferGeometry;return a(s,"normal",new o.BufferAttribute(new Float32Array(n),3)),a(s,"position",new o.BufferAttribute(new Float32Array(e),3)),a(s,"uv",new o.BufferAttribute(new Float32Array(i),2)),s.setIndex(new o.BufferAttribute(new Uint32Array(r),1)),s}function M(t){const e=new o.BufferGeometry;return a(e,"normal",t.getAttribute("normal")),a(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let O;function S(){if(!O){const t=1e-6;O=new o.BoxBufferGeometry(t,t,t)}return O}S();var A=Object.freeze({__proto__:null,mergeBufferGeometries:m,mergeBufferGeometriesAttribute:b,generateBufferGeometry:w,generatePickBufferGeometry:M,getDefaultBufferGeometry:S});const j={},C=new o.BoxBufferGeometry(1,1,1);C.translate(0,0,.5);const T=new o.Color("#fff"),L=new o.Color("#fff");function k(t){const{height:e,radialSegments:n,radius:i}=t,r=function(t=6){if(!j[t]){const e=new o.CylinderBufferGeometry(1,1,1,t,1);e.rotateX(Math.PI/2),e.translate(0,0,.5),e.rotateZ(Math.PI/6),j[t]=e}return j[t]}(n).clone();return r.scale(i,i,e),r}function P(t,e,n,i="y",r=0){let s=0;"y"===i?s=1:"z"===i&&(s=2);const c=t.attributes.position.array,h=c.length;L.setStyle(e),T.setStyle(n);const l=new Float32Array(h);for(let t=0;t<h;t+=3){c[t+s]>r?(l[t]=T.r,l[t+1]=T.g,l[t+2]=T.b):(l[t]=L.r,l[t+1]=L.g,l[t+2]=L.b)}return a(t,"color",new o.BufferAttribute(l,3,!0)),l}function B(t){const e=[],n=t.length;let i=0;for(let e=0;e<n;e++){const{color:n}=t[e].attributes;n&&(i+=n.array.length)}const r=new Float32Array(i);let s=0;for(let n=0,i=t.length;n<i;n++){const{color:i,normal:o,position:a,uv:c}=t[n].attributes,h=t[n].index;i&&(r.set(i.array,s),s+=i.array.length),e.push({normal:o.array,uv:c.array,position:a.array,indices:h.array})}const c=m(e);r.length&&a(c,"color",new o.BufferAttribute(r,3,!0));for(let e=0,n=t.length;e<n;e++)t[e].dispose();return c}function z(){return C}const E={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class V extends v{constructor(t,e,n,i){e=r.Util.extend({},E,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:o,radius:s,topColor:a,bottomColor:h,altitude:l}=e;e.height=i.distanceToVector3(o,o).x,e.radius=i.distanceToVector3(s,s).x,e._radius=this.options.radius,e._height=this.options.height;const u=k(e);a&&(P(u,h,a,"z",e.height/2),n.vertexColors=c()),this._createMesh(u,n);const d=i.distanceToVector3(l,l).x,f=i.coordinateToVector3(t,d);this.getObject3d().position.copy(f),this.type="Bar"}}const U=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function I(t){return t.geometry?t.geometry.type:null}function R(t){const e=I(t);if(e)for(let t=0,n=U.length;t<n;t++)if(U[t]===e)return!0;return!1}function F(t){const e=I(t);return!(!e||e!==U[4]&&e!==U[5])}function G(t){const e=I(t);return!(!e||e!==U[2]&&e!==U[3])}function Z(t){const e=I(t);return!(!e||e!==U[0]&&e!==U[1])}function D(t){const e=I(t);return!!(e&&e.indexOf("Multi")>-1)}function H(t){return t.geometry?t.geometry.coordinates:[]}function J(t,e){const n=I(t);if(!n||!t.geometry)return null;const i=t.geometry.coordinates;if(!i)return null;let o=0,s=0,a=0;switch(n){case"Point":o=i[0],s=i[1],a++;break;case"MultiPoint":case"LineString":for(let t=0,e=i.length;t<e;t++)o+=i[t][0],s+=i[t][1],a++;break;case"MultiLineString":case"Polygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)o+=i[t][e][0],s+=i[t][e][1],a++;break;case"MultiPolygon":for(let t=0,e=i.length;t<e;t++)for(let e=0,n=i[t].length;e<n;e++)for(let n=0,r=i[t][e].length;n<r;n++)o+=i[t][e][n][0],s+=i[t][e][n][1],a++}const c=o/a,h=s/a;return e?(e.x=c,e.y=h,e):new r.Coordinate(c,h)}function Q(t){const e=I(t);if(!e||!t.geometry)return null;const n=t.geometry,i=t.properties||{},r=n.coordinates;if(!r)return null;const o=[];let s;switch(e){case"MultiPoint":s="Point";break;case"MultiLineString":s="LineString";break;case"MultiPolygon":s="Polygon"}if(s)for(let t=0,e=r.length;t<e;t++)o.push({type:"Feature",geometry:{type:s,coordinates:r[t]},properties:i});else o.push(t);return o}var W=Object.freeze({__proto__:null,isGeoJSON:R,isGeoJSONPolygon:F,isGeoJSONLine:G,isGeoJSONPoint:Z,isGeoJSONMulti:D,getGeoJSONCoordinates:H,getGeoJSONCenter:J,spliteGeoJSONMulti:Q}),q={exports:{}};function N(t,e,n){n=n||2;var i,r,o,s,a,c,h,l=e&&e.length,u=l?e[0]*n:t.length,d=K(t,0,u,n,!0),f=[];if(!d||d.next===d.prev)return f;if(l&&(d=function(t,e,n,i){var r,o,s,a=[];for(r=0,o=e.length;r<o;r++)(s=K(t,e[r]*i,r<o-1?e[r+1]*i:t.length,i,!1))===s.next&&(s.steiner=!0),a.push(at(s));for(a.sort(it),r=0;r<a.length;r++)rt(a[r],n),n=X(n,n.next);return n}(t,e,d,n)),t.length>80*n){i=o=t[0],r=s=t[1];for(var g=n;g<u;g+=n)(a=t[g])<i&&(i=a),(c=t[g+1])<r&&(r=c),a>o&&(o=a),c>s&&(s=c);h=0!==(h=Math.max(o-i,s-r))?1/h:0}return $(d,f,n,i,r,h),f}function K(t,e,n,i,r){var o,s;if(r===bt(t,e,n,i)>0)for(o=e;o<n;o+=i)s=xt(o,t[o],t[o+1],s);else for(o=n-i;o>=e;o-=i)s=xt(o,t[o],t[o+1],s);return s&&ut(s,s.next)&&(vt(s),s=s.next),s}function X(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!ut(i,i.next)&&0!==lt(i.prev,i,i.next))i=i.next;else{if(vt(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function $(t,e,n,i,r,o,s){if(t){!s&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=st(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,o,s,a,c,h=1;do{for(n=t,t=null,o=null,s=0;n;){for(s++,i=n,a=0,e=0;e<h&&(a++,i=i.nextZ);e++);for(c=h;a>0||c>0&&i;)0!==a&&(0===c||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,c--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,h*=2}while(s>1)}(r)}(t,i,r,o);for(var a,c,h=t;t.prev!==t.next;)if(a=t.prev,c=t.next,o?tt(t,i,r,o):Y(t))e.push(a.i/n),e.push(t.i/n),e.push(c.i/n),vt(t),t=c.next,h=c.next;else if((t=c)===h){s?1===s?$(t=et(X(t),e,n),e,n,i,r,o,2):2===s&&nt(t,e,n,i,r,o):$(X(t),e,n,i,r,o,1);break}}}function Y(t){var e=t.prev,n=t,i=t.next;if(lt(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(ct(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&lt(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function tt(t,e,n,i){var r=t.prev,o=t,s=t.next;if(lt(r,o,s)>=0)return!1;for(var a=r.x<o.x?r.x<s.x?r.x:s.x:o.x<s.x?o.x:s.x,c=r.y<o.y?r.y<s.y?r.y:s.y:o.y<s.y?o.y:s.y,h=r.x>o.x?r.x>s.x?r.x:s.x:o.x>s.x?o.x:s.x,l=r.y>o.y?r.y>s.y?r.y:s.y:o.y>s.y?o.y:s.y,u=st(a,c,e,n,i),d=st(h,l,e,n,i),f=t.prevZ,g=t.nextZ;f&&f.z>=u&&g&&g.z<=d;){if(f!==t.prev&&f!==t.next&&ct(r.x,r.y,o.x,o.y,s.x,s.y,f.x,f.y)&&lt(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,g!==t.prev&&g!==t.next&&ct(r.x,r.y,o.x,o.y,s.x,s.y,g.x,g.y)&&lt(g.prev,g,g.next)>=0)return!1;g=g.nextZ}for(;f&&f.z>=u;){if(f!==t.prev&&f!==t.next&&ct(r.x,r.y,o.x,o.y,s.x,s.y,f.x,f.y)&&lt(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;g&&g.z<=d;){if(g!==t.prev&&g!==t.next&&ct(r.x,r.y,o.x,o.y,s.x,s.y,g.x,g.y)&&lt(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function et(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!ut(r,o)&&dt(r,i,i.next,o)&&pt(r,o)&&pt(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),vt(i),vt(i.next),i=t=o),i=i.next}while(i!==t);return X(i)}function nt(t,e,n,i,r,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&ht(s,a)){var c=yt(s,a);return s=X(s,s.next),c=X(c,c.next),$(s,e,n,i,r,o),void $(c,e,n,i,r,o)}a=a.next}s=s.next}while(s!==t)}function it(t,e){return t.x-e.x}function rt(t,e){if(e=function(t,e){var n,i=e,r=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>s){if(s=a,a===r){if(o===i.y)return i;if(o===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(r===s)return n;var c,h=n,l=n.x,u=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=l&&r!==i.x&&ct(o<u?r:s,o,l,u,o<u?s:r,o,i.x,i.y)&&(c=Math.abs(o-i.y)/(r-i.x),pt(i,t)&&(c<d||c===d&&(i.x>n.x||i.x===n.x&&ot(n,i)))&&(n=i,d=c)),i=i.next}while(i!==h);return n}(t,e)){var n=yt(e,t);X(e,e.next),X(n,n.next)}}function ot(t,e){return lt(t.prev,t,e.prev)<0&&lt(e.next,t,t.next)<0}function st(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function at(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function ct(t,e,n,i,r,o,s,a){return(r-s)*(e-a)-(t-s)*(o-a)>=0&&(t-s)*(i-a)-(n-s)*(e-a)>=0&&(n-s)*(o-a)-(r-s)*(i-a)>=0}function ht(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&dt(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(pt(t,e)&&pt(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(lt(t.prev,t,e.prev)||lt(t,e.prev,e))||ut(t,e)&&lt(t.prev,t,t.next)>0&&lt(e.prev,e,e.next)>0)}function lt(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function ut(t,e){return t.x===e.x&&t.y===e.y}function dt(t,e,n,i){var r=gt(lt(t,e,n)),o=gt(lt(t,e,i)),s=gt(lt(n,i,t)),a=gt(lt(n,i,e));return r!==o&&s!==a||(!(0!==r||!ft(t,n,e))||(!(0!==o||!ft(t,i,e))||(!(0!==s||!ft(n,t,i))||!(0!==a||!ft(n,e,i)))))}function ft(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function gt(t){return t>0?1:t<0?-1:0}function pt(t,e){return lt(t.prev,t,t.next)<0?lt(t,e,t.next)>=0&&lt(t,t.prev,e)>=0:lt(t,e,t.prev)<0||lt(t,t.next,e)<0}function yt(t,e){var n=new mt(t.i,t.x,t.y),i=new mt(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function xt(t,e,n,i){var r=new mt(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function vt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function mt(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function bt(t,e,n,i){for(var r=0,o=e,s=n-i;o<n;o+=i)r+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return r}q.exports=N,q.exports.default=N,N.deviation=function(t,e,n,i){var r=e&&e.length,o=r?e[0]*n:t.length,s=Math.abs(bt(t,0,o,n));if(r)for(var a=0,c=e.length;a<c;a++){var h=e[a]*n,l=a<c-1?e[a+1]*n:t.length;s-=Math.abs(bt(t,h,l,n))}var u=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,g=i[a+2]*n;u+=Math.abs((t[d]-t[g])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[g+1]-t[d+1]))}return 0===s&&0===u?0:Math.abs((u-s)/s)},N.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var s=0;s<e;s++)n.vertices.push(t[r][o][s]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var _t=q.exports;function wt(t,e,n){var i=e[0],r=e[1],o=n[0]-i,s=n[1]-r;if(0!==o||0!==s){var a=((t[0]-i)*o+(t[1]-r)*s)/(o*o+s*s);a>1?(i=n[0],r=n[1]):a>0&&(i+=o*a,r+=s*a)}return(o=t[0]-i)*o+(s=t[1]-r)*s}function Mt(t,e,n,i,r){for(var o,s=i,a=e+1;a<n;a++){var c=wt(t[a],t[e],t[n]);c>s&&(o=a,s=c)}s>i&&(o-e>1&&Mt(t,e,o,i,r),r.push(t[o]),n-o>1&&Mt(t,o,n,i,r))}function Ot(t,e){var n=t.length-1,i=[t[0]];return Mt(t,0,n,e,i),i.push(t[n]),i}function St(t,e,n){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=Ot(t=n?t:function(t,e){for(var n,i,r,o,s,a=t[0],c=[a],h=1,l=t.length;h<l;h++)n=t[h],r=a,o=void 0,s=void 0,o=(i=n)[0]-r[0],s=i[1]-r[1],o*o+s*s>e&&(c.push(n),a=n);return a!==n&&c.push(n),c}(t,i),i)}function At(t,e){return t[0]*e[0]+t[1]*e[1]}function jt(t,e){const n=e[0],i=e[1],r=Math.sqrt(n*n+i*i);return t[0]=n/r,t[1]=i/r,t}function Ct(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function Tt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Lt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function kt(t,e){const n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r);return t[0]=n/o,t[1]=i/o,t[2]=r/o,t}function Pt(t,e,n){var i=e[0],r=e[1],o=e[2],s=n[0],a=n[1],c=n[2];return t[0]=r*c-o*a,t[1]=o*s-i*c,t[2]=i*a-r*s,t}const Bt=[];function zt(t,e,n,i){const r=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(r)*i;return Ct(Bt,n,e,-r),function(t,e){const n=e[0],i=e[1],r=e[2],o=Math.sqrt(n*n+i*i+r*r);t[0]=n/o,t[1]=i/o,t[2]=r/o}(Bt,Bt),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),Ct(t,t,Bt,Math.sin(o)),t}function Et(t,e,n,i,r,o,s,a,c,h){const l=s-r,u=a-o,d=(l*(e-o)-u*(t-r))/(u*(n-t)-l*(i-e));return c&&(c[h=h||0]=t+d*(n-t),c[h+1]=e+d*(i-e)),d}function Vt(t,e,n){if(n-e<3)return 0;let i=0;for(let r=2*(n-1),o=2*e;o<2*n;){const e=t[r],n=t[r+1],s=t[o],a=t[o+1];r=o,o+=2,i+=e*a-s*n}return i}function Ut(t,e,n=2){return _t(t,e,n)}const It=[],Rt=[],Ft=[];function Gt(t,e,n,i,r,o,s,a,c){const h=null!=s;let l,u,d,f=r,g=null;h&&(g=new Uint32Array(i-n));let p=[];for(let r=n;r<i;r++){const y=r===i-1?n:r+1,x=r===n?i-1:r-1,v=t[2*x],m=t[2*x+1],b=t[2*r],_=t[2*r+1],w=t[2*y],M=t[2*y+1];It[0]=b-v,It[1]=_-m,Rt[0]=w-b,Rt[1]=M-_,jt(It,It),jt(Rt,Rt),h&&(g[r]=f);let O,S,A=!1;if(a||r!==n)if(a||r!==i-1){Tt(Ft,Rt,It);const t=Ft[1];Ft[1]=-Ft[0],Ft[0]=t,jt(Ft,Ft);const n=At(Ft,Rt),i=Math.sqrt(1-n*n),r=o*Math.min(10,1/i),a=o*n<0;if(h&&1/i>s&&a){const t=b+Ft[0]*o,n=_+Ft[1]*o,r=Math.acos(i)/2,s=Math.tan(r)*Math.abs(o);e[2*f]=t+Ft[1]*s,e[2*f+1]=n-Ft[0]*s,f++,e[2*f]=t-Ft[1]*s,e[2*f+1]=n+Ft[0]*s,f++}else O=b+Ft[0]*r,S=_+Ft[1]*r,A=!0;if(A){if(c&&null!=l){const t=Et(v,m,l,u,b,_,O,S,p,0);t>=-.01&&t<=1.01&&(e[2*d]=O=p[0],e[2*d+1]=S=p[1])}l=e[2*f]=O,u=e[2*f+1]=S,d=f,f++}}else Ft[0]=It[1],Ft[1]=-It[0],jt(Ft,Ft),O=b+Ft[0]*o,S=_+Ft[1]*o,A=!0;else Ft[0]=Rt[1],Ft[1]=-Rt[0],jt(Ft,Ft),l=e[2*f]=b+Ft[0]*o,u=e[2*f+1]=_+Ft[1]*o,d=f,f++}return g}function Zt(t,e,n,i,r,o,s,a){const c=null!=s;let h=r,l=null;c&&(l=new Uint32Array(i-n));for(let r=n;r<i;r++){const u=r===i-1?n:r+1,d=r===n?i-1:r-1,f=t[2*d],g=t[2*d+1],p=t[2*r],y=t[2*r+1],x=t[2*u],v=t[2*u+1];if(It[0]=p-f,It[1]=y-g,Rt[0]=x-p,Rt[1]=v-y,jt(It,It),jt(Rt,Rt),c&&(l[r]=h),a||r!==n)if(a||r!==i-1){Tt(Ft,Rt,It);const t=Ft[1];Ft[1]=-Ft[0],Ft[0]=t,jt(Ft,Ft);const n=At(Ft,Rt),i=Math.sqrt(1-n*n),r=o*Math.min(10,1/i),a=o*n<0;if(c&&1/i>s&&a){const t=p+Ft[0]*o,n=y+Ft[1]*o,r=Math.acos(i)/2,s=Math.tan(r)*Math.abs(o);e[2*h]=t+Ft[1]*s,e[2*h+1]=n-Ft[0]*s,h++,e[2*h]=t-Ft[1]*s,e[2*h+1]=n+Ft[0]*s,h++}else e[2*h]=p+Ft[0]*r,e[2*h+1]=y+Ft[1]*r,h++}else Ft[0]=It[1],Ft[1]=-It[0],jt(Ft,Ft),e[2*h]=p+Ft[0]*o,e[2*h+1]=y+Ft[1]*o,h++;else Ft[0]=Rt[1],Ft[1]=-Rt[0],jt(Ft,Ft),e[2*h]=p+Ft[0]*o,e[2*h+1]=y+Ft[1]*o,h++}return l}function Dt(t,e,n,i,r){const o=null!=i?[]:new Float32Array(t.length);if(Gt(t,o,0,e&&e.length?e[0]:t.length/2,0,n,i,r,!0),e)for(let s=0;s<e.length;s++){const a=e[s];Gt(t,o,a,e[s+1]||t.length/2,null!=i?o.length/2:a,n,i,r,!1)}return o}function Ht(t,e,n,i){for(let r=0;r<Math.floor((i-n)/2);r++)for(let o=0;o<e;o++){const s=(r+n)*e+o,a=(i-r-1)*e+o,c=t[s];t[s]=t[a],t[a]=c}return t}function Jt(t,e){let n=t.length/2,i=0,r=e&&e.length?e[0]:n;Vt(t,i,r)>0&&Ht(t,2,i,r);for(let o=1;o<(e?e.length:0)+1;o++)i=e[o-1],r=e[o]||n,Vt(t,i,r)<0&&Ht(t,2,i,r)}function Qt(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,null==t.smoothSide&&(t.smoothSide="auto"),null==t.smoothSideThreshold&&(t.smoothSideThreshold=.9),"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,i=null==t.fitRect.y?e.y||0:t.fitRect.y,r=t.fitRect.width,o=t.fitRect.height;null==r?null!=o?r=o/e.height*e.width:(r=e.width,o=e.height):null==o&&(o=r/e.width*e.height),t.scale=[r/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(i-e.y)*t.scale[1]]}}const Wt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function qt(t,e,n){let i=0,r=t[e],o=t[e+1];const s=r,a=o;for(let s=e+2;s<n;s+=2){const e=t[s],n=t[s+1];i+=Math.sqrt((e-r)*(e-r)+(n-o)*(n-o)),r=e,o=n}return i+=Math.sqrt((r-s)*(r-s)+(o-a)*(o-a)),i}function Nt(t,{vertices:e,topVertices:n,splittedMap:i,depth:r,rect:o},s,a,c,h){const l=a-s,u=h.smoothBevel?1:2,d=Math.min(r/2,h.bevelSize),f=h.bevelSegments,g=c.vertex,p=c.ringPerimeter,y=Math.max(o.width,o.height,r,p);function x(t){const n=(t+1)%l,i=e[2*t],r=e[2*t+1],o=e[2*n],s=e[2*n+1];return i===o&&r===s}if(d>0){const o=[0,0,1],a=[],h=[0,0,-1],p=[];let v=0,m=new Float32Array(l);for(let b=0;b<2;b++){const _=0===b?r-d:d;for(let r=0;r<=f*u;r++){let w,M,O=0;for(let S=0;S<l;S++){const A=2*(S%l+s),j=i?2*i[A/2]:A;a[0]=e[A]-n[j],a[1]=e[A+1]-n[j+1],a[2]=0;const C=Math.sqrt(a[0]*a[0]+a[1]*a[1]);a[0]/=C,a[1]/=C;const T=(Math.floor(r/u)+r%u)/f;0===b?zt(p,o,a,T):zt(p,a,h,T);const L=0===b?T:1-T,k=d*Math.sin(L*Math.PI/2),P=C*Math.cos(L*Math.PI/2),B=d*C/Math.sqrt(k*k+P*P),z=p[0]*B+n[j],E=p[1]*B+n[j+1],V=p[2]*B+_;if(t.position[3*c.vertex]=z,t.position[3*c.vertex+1]=E,t.position[3*c.vertex+2]=V,S>0&&(O+=Math.sqrt((w-z)*(w-z)+(M-E)*(M-E))),r>0||b>0){let e=3*(c.vertex-l),n=t.position[e],i=t.position[e+1],r=t.position[e+2];m[S]+=Math.sqrt((n-z)*(n-z)+(i-E)*(i-E)+(r-V)*(r-V))}if(t.uv[2*c.vertex]=O/y,t.uv[2*c.vertex+1]=m[S]/y,w=z,M=E,c.vertex++,!x(S)&&(u>1&&r%u||1===u&&r>=1))for(let e=0;e<6;e++){const n=(Wt[e][0]+S)%l,i=Wt[e][1]+v;t.indices[c.index++]=(i-1)*l+n+g}}v++}}}else for(let n=0;n<2;n++){const i=0===n?r-d:d;let o,a,h=0;for(let n=0;n<l;n++){const r=2*(n%l+s),u=e[r],d=e[r+1];t.position[3*c.vertex]=u,t.position[3*c.vertex+1]=d,t.position[3*c.vertex+2]=i,n>0&&(h+=Math.sqrt((o-u)*(o-u)+(a-d)*(a-d))),t.uv[2*c.vertex]=h/y,t.uv[2*c.vertex+1]=i/y,o=u,a=d,c.vertex++}}const v=d>0?f*u+1:1;for(let e=0;e<l;e++)if(!x(e))for(let n=0;n<6;n++){const i=(Wt[n][0]+e)%l,r=Wt[n][1]+v;t.indices[c.index++]=(r-1)*l+i+g}}function Kt({indices:t,topVertices:e,rect:n,depth:i},r,o,s){if(e.length<=4)return;const a=o.vertex,c=t.length;for(let e=0;e<c;e++)r.indices[o.index++]=a+t[e];const h=Math.max(n.width,n.height);for(let t=0;t<(s.excludeBottom?1:2);t++)for(let s=0;s<e.length;s+=2){const a=e[s],c=e[s+1];r.position[3*o.vertex]=a,r.position[3*o.vertex+1]=c,r.position[3*o.vertex+2]=(1-t)*i,r.uv[2*o.vertex]=(a-n.x)/h,r.uv[2*o.vertex+1]=(c-n.y)/h,o.vertex++}if(!s.excludeBottom){const n=e.length/2;for(let e=0;e<c;e+=3)for(let i=0;i<3;i++)r.indices[o.index++]=a+n+t[e+2-i]}}function Xt(t,e,n,i){const r=null==n||"auto"===n;if(!0===n)return{vertices:t,holes:e};const o=[],s=e&&[],a=t.length/2,c=[],h=[],l=[];let u=0,d=0;const f=(e?e.length:0)+1;for(let n=0;n<f;n++){0===n?d=e&&e.length?e[0]:a:(u=e[n-1],d=e[n]||a);for(let e=u;e<d;e++){const n=t[2*e],s=t[2*e+1],a=e===d-1?u:e+1,f=t[2*a],g=t[2*a+1];if(r){const r=e===u?d-1:e-1,a=t[2*r],p=t[2*r+1];c[0]=a-n,c[1]=p-s,h[0]=f-n,h[1]=g-s,jt(c,c),jt(h,h);1-(.5*At(c,h)+.5)>i?(o.push(n,s),l.push(e)):(o.push(n,s,n,s),l.push(e,e))}else o.push(n,s,n,s),l.push(e,e)}n<f-1&&s&&s.push(o.length/2)}return{vertices:new Float32Array(o),splittedMap:l,holes:s}}function $t(t,e){let n=0,i=0;for(let r=0;r<t.length;r++){const{indices:o,vertices:s,splittedMap:a,topVertices:c,depth:h}=t[r],l=Math.min(h/2,e.bevelSize)>0?e.bevelSegments:0,u=t[r].holes||[];n+=o.length*(e.excludeBottom?1:2),i+=c.length/2*(e.excludeBottom?1:2);const d=2+2*l;let f=0,g=0;for(let t=0;t<u.length+1;t++){0===t?g=u.length?u[0]:s.length/2:(f=u[t-1],g=u[t]||s.length/2);n+=6*((a?a[g-1]+1:g)-(a?a[f]:f))*(d-1);const r=g-f;i+=r*d+(e.smoothBevel?0:l*r*2)}}const r={position:new Float32Array(3*i),indices:new(i>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*i)},o={vertex:0,index:0,ringPerimeter:0};for(let n=0;n<t.length;n++)Kt(t[n],r,o,e);for(let n=0;n<t.length;n++){const{holes:i,vertices:s}=t[n],a=s.length/2;let c=0,h=i&&i.length?i[0]:a;if(o.ringPerimeter=qt(t[n].topVertices,c,h),Nt(r,t[n],c,h,o,e),i)for(let s=0;s<i.length;s++)c=i[s],h=i[s+1]||a,o.ringPerimeter=qt(t[n].topVertices,c,h),Nt(r,t[n],c,h,o,e)}for(let t=0;t<r.uv.length;t++){const e=r.uv[t];e>0&&Math.round(e)===e?r.uv[t]=1:r.uv[t]=e%1}return r.normal=function(t,e){function n(t,e,n,i){t[0]=e,t[1]=n,t[2]=i}const i=[],r=[],o=[],s=[],a=[],c=[],h=t.length,l=new Float32Array(e.length);for(let u=0;u<h;){const h=3*t[u++],d=3*t[u++],f=3*t[u++];n(i,e[h],e[h+1],e[h+2]),n(r,e[d],e[d+1],e[d+2]),n(o,e[f],e[f+1],e[f+2]),Lt(s,i,r),Lt(a,r,o),Pt(c,s,a);for(let t=0;t<3;t++)l[h+t]=l[h+t]+c[t],l[d+t]=l[d+t]+c[t],l[f+t]=l[f+t]+c[t]}for(var u=0;u<l.length;)n(c,l[u],l[u+1],l[u+2]),kt(c,c),l[u++]=c[0],l[u++]=c[1],l[u++]=c[2];return l}(r.indices,r.position),r.boundingRect=t[0]&&t[0].rect,r}function Yt(t,e,n){const i=n.lineWidth,r=t.length,o=new Float32Array(2*r),s=n.translate||[0,0],a=n.scale||[1,1];for(let e=0,n=0;e<r;e++)o[n++]=t[e][0]*a[0]+s[0],o[n++]=t[e][1]*a[1]+s[1];Vt(o,0,r)<0&&Ht(o,2,0,r);const c=[],h=[],l=n.miterLimit,u=Zt(o,h,0,r,0,-i/2,l,!1);Ht(o,2,0,r);const d=Zt(o,c,0,r,0,-i/2,l,!1),f=(c.length+h.length)/2,g=new Float32Array(2*f);let p=0;const y=h.length/2;for(let t=0;t<h.length;t++)g[p++]=h[t];for(let t=0;t<c.length;t++)g[p++]=c[t];const x=new(f>65535?Uint32Array:Uint16Array)(3*(2*(r-1)+(f-2*r)));let v=0;for(let t=0;t<r-1;t++){const e=t+1;x[v++]=y-1-u[t],x[v++]=y-1-u[t]-1,x[v++]=d[t]+1+y,x[v++]=y-1-u[t],x[v++]=d[t]+1+y,x[v++]=d[t]+y,d[e]-d[t]==2?(x[v++]=d[t]+2+y,x[v++]=d[t]+1+y,x[v++]=y-u[e]-1):u[e]-u[t]==2&&(x[v++]=d[e]+y,x[v++]=y-1-(u[t]+1),x[v++]=y-1-(u[t]+2))}const m=n.bevelSize>0?Dt(g,[],n.bevelSize,null,!0):g,b=n.boundingRect,_=Xt(g,null,n.smoothSide,n.smoothSideThreshold);return{vertices:_.vertices,rawVertices:m,splittedMap:_.splittedMap,indices:x,topVertices:m,rect:{x:b.x*a[0]+s[0],y:b.y*a[1]+s[1],width:b.width*a[0],height:b.height*a[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function te(t,e){const n=[];for(let i=0;i<t.length;i++){const r=t[i],o=[],s=r.length;let a=r[s-1][0],c=r[s-1][1],h=0;for(let t=0;t<s;t++){let n=r[t][0],i=r[t][1];const s=n-a,l=i-c;h+=Math.sqrt(s*s+l*l),h>e&&(o.push(r[t]),h=0),a=n,c=i}o.length>=3&&n.push(o)}return n.length>0?n:null}function ee(t,e){const n=[];for(let i=0;i<t.length;i++){let r=t[i];r=St(r,e,!0),r.length>=3&&n.push(r)}return n.length>0?n:null}function ne(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)re(t[e][0],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},Qt(e);const r=[],o=e.translate||[0,0],s=e.scale||[1,1],a=e.boundingRect,c={x:a.x*s[0]+o[0],y:a.y*s[1]+o[1],width:a.width*s[0],height:a.height*s[1]},h=Math.min(a.width,a.height)/1e5;for(let n=0;n<t.length;n++){let i=te(t[n],h);if(!i)continue;const a=e.simplify/Math.max(s[0],s[1]);if(a>0&&(i=ee(i,a)),!i)continue;const{vertices:l,holes:u,dimensions:d}=_t.flatten(i);for(let t=0;t<l.length;)l[t]=l[t++]*s[0]+o[0],l[t]=l[t++]*s[1]+o[1];if(Jt(l,u),2!==d)throw new Error("Only 2D polygon points are supported");const f=e.bevelSize>0?Dt(l,u,e.bevelSize,null,!0):l,g=Ut(f,u,d),p=Xt(l,u,e.smoothSide,e.smoothSideThreshold);r.push({indices:g,vertices:p.vertices,rawVertices:l,topVertices:f,holes:p.holes,splittedMap:p.splittedMap,rect:c,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return $t(r,e)}function ie(t,e){e=Object.assign({},e);const n=[1/0,1/0],i=[-1/0,-1/0];for(let e=0;e<t.length;e++)re(t[e],n,i);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:i[0]-n[0],height:i[1]-n[1]},Qt(e);const r=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const o=[];for(let n=0;n<t.length;n++){let i=t[n];const s=e.simplify/Math.max(r[0],r[1]);s>0&&(i=St(i,s,!0)),o.push(Yt(i,n,e))}return $t(o,e)}function re(t,e,n){for(let i=0;i<t.length;i++)e[0]=Math.min(t[i][0],e[0]),e[1]=Math.min(t[i][1],e[1]),n[0]=Math.max(t[i][0],n[0]),n[1]=Math.max(t[i][1],n[1])}var oe=Object.freeze({__proto__:null,triangulate:Ut,flatten:function(t){return _t.flatten(t)},offsetPolygon:Dt,extrudePolygon:ne,extrudePolyline:ie,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],i=[],r=[],o=[],s=[1/0,1/0],a=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const c=t.features[e].geometry;if(c&&c.coordinates)switch(c.type){case"LineString":n.push(c.coordinates),r.push(e),re(c.coordinates,s,a);break;case"MultiLineString":for(let t=0;t<c.coordinates.length;t++)n.push(c.coordinates[t]),r.push(e),re(c.coordinates[t],s,a);break;case"Polygon":i.push(c.coordinates),o.push(e),re(c.coordinates[0],s,a);break;case"MultiPolygon":for(let t=0;t<c.coordinates.length;t++)i.push(c.coordinates[t]),o.push(e),re(c.coordinates[t][0],s,a)}}e.boundingRect=e.boundingRect||{x:s[0],y:s[1],width:a[0]-s[0],height:a[1]-s[1]};const c=e.depth;return{polyline:ie(n,Object.assign(e,{depth:function(e){return"function"==typeof c?c(t.features[r[e]]):c}})),polygon:ne(i,Object.assign(e,{depth:function(e){return"function"==typeof c?c(t.features[o[e]]):c}}))}}});function se(t,e,n={}){return void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function ae(t=[]){let e=0,n=0;const i=t.length;for(let o=0;o<i;o++){const{coordinate:i,lnglat:s,lnglats:a,xy:c,xys:h}=t[o],l=i||s||a||c||h||t[o];let u,d;Array.isArray(l)?(u=l[0],d=l[1]):l instanceof r.Coordinate&&(u=l.x,d=l.y),e+=u,n+=d}return new r.Coordinate(e/i,n/i)}function ce(t,e,n,i){if(void 0===e||"number"!=typeof e||0===e)return 0;let r;r=t instanceof o.BufferGeometry?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position;let s=0;if(r){i?(void 0===i[e]&&(i[e]=n.distanceToVector3(e,e).x),s=i[e]):s=n.distanceToVector3(e,e).x;const t=r.length;if(r[0]instanceof o.Vector3)for(let e=0;e<t;e++)r[e].z+=s;else for(let e=0;e<t;e+=3)r[e+2]+=s}return s}function he(t){const e=t.length;let n=0;for(let i=0;i<e;i++){const{count:e}=t[i].position;n+=e}return new Float32Array(3*n)}function le(t=[]){const e=t.length,n=new Float64Array(2*e);for(let i=0;i<e;i++){let e,r;const o=t[i];o.x?(e=o.x,r=o.y):(e=o[0],r=o[1]),n[2*i]=e,n[2*i+1]=r}return n.buffer}const ue=new o.Color("#fff"),de=new o.Color("#fff");function fe(t,e,n,i){const{position:r,normal:s,uv:c,indices:h}=ge(t,e,n,i),l=new Float32Array(r.length);l.fill(1,0,r.length);const u=new o.BufferGeometry;return a(u,"color",new o.BufferAttribute(l,3)),a(u,"normal",new o.BufferAttribute(s,3)),a(u,"position",new o.BufferAttribute(r,3)),a(u,"uv",new o.BufferAttribute(c,2)),u.setIndex(new o.Uint32BufferAttribute(h,1)),u}function ge(t,e,n,i,r,o){const s=ye(t,n,i,r,!1);if(!s)return null;o?(null==o[e]&&(o[e]=n.distanceToVector3(e,e).x),e=o[e]):e=n.distanceToVector3(e,e).x;const{position:a,normal:c,uv:h,indices:l}=ne(s,{depth:e});return{position:a,normal:c,uv:h,indices:l}}function pe(t,e,n,i){void 0===i&&(i=0);const r=t.attributes.position.array,s=r.length;let c;if(de.setStyle(e),ue.setStyle(n),Array.isArray(i)){let t=0;for(let e=0,n=i.length;e<n;e++){const{count:n}=i[e].position;t+=3*n}c=new Float32Array(t)}else c=new Float32Array(r.length);if(Array.isArray(i))for(let t=0,e=i.length;t<e;t++){const{middleZ:e,start:n,end:o}=i[t].position;for(let t=n;t<o;t+=3){r[t+2]>e?(c[t]=ue.r,c[t+1]=ue.g,c[t+2]=ue.b):(c[t]=de.r,c[t+1]=de.g,c[t+2]=de.b)}}else for(let t=0;t<s;t+=3){r[t+2]>i?(c[t]=ue.r,c[t+1]=ue.g,c[t+2]=ue.b):(c[t]=de.r,c[t+1]=de.g,c[t+2]=de.b)}return a(t,"color",new o.BufferAttribute(c,3,!0)),c}function ye(t,e,n,i,o=!1){if(!t)return null;let s=[];if(t instanceof r.MultiPolygon)s=t.getGeometries().map((r=>xe(r,e,n||t.getCenter(),i,o)));else if(t instanceof r.Polygon){const r=xe(t,e,n||t.getCenter(),i,o);s.push(r)}else if(F(t))if(D(t)){const r=Q(t);for(let a=0,c=r.length;a<c;a++)s.push(xe(r[a],e,n||J(t),i,o))}else{const r=xe(t,e,n||J(t),i,o);s.push(r)}return s}function xe(t,e,n,i,o=!1){let s,a,c;if(F(t)){const e=H(t);s=e[0],a=e.slice(1,e.length),n=n||J(t)}else t instanceof r.Polygon&&(s=t.getShell(),a=t.getHoles(),n=n||t.getCenter());i=i||e.coordinateToVector3(n),c=o?e.coordinatiesToGLFloatArray(s,i).positons2d:e.coordinatiesToGLArray(s,i);const h=[o?c.buffer:c];if(a&&a.length>0)for(let t=0,n=a.length;t<n;t++){let n;n=o?e.coordinatiesToGLFloatArray(a[t],i).positons2d:e.coordinatiesToGLArray(a[t],i),h.push(o?n.buffer:n)}return h}function ve(t){if(!t)return null;let e=[];if(t instanceof r.MultiPolygon)e=t.getGeometries().map((t=>me(t,!1)));else if(t instanceof r.Polygon){const n=me(t,!1);e.push(n)}else if(F(t))if(D(t)){const n=Q(t);for(let t=0,i=n.length;t<i;t++)e.push(me(n[t],!0))}else{const n=me(t,!0);e.push(n)}return e}function me(t,e){let n,i;if(e){const e=H(t);n=e[0],i=e.slice(1,e.length)}else t instanceof r.Polygon&&(n=t.getShell(),i=t.getHoles());const o=[le(n)];if(i&&i.length>0)for(let t=0,e=i.length;t<e;t++){const e=le(i[t]);o.push(e)}return o}var be=Object.freeze({__proto__:null,getExtrudeGeometry:fe,getExtrudeGeometryParams:ge,initVertexColors:pe,getPolygonPositions:ye,getSinglePolygonPositions:xe,getPolygonArrayBuffer:ve,getSinglePolygonArrayBuffer:me});function _e(t,e,n,i=!0){const s=[];let a,c;if(Array.isArray(t)&&t[0]instanceof o.Vector3)for(let e=0,n=t.length;e<n;e++){const n=t[e];s.push(n)}else{Array.isArray(t)&&(t=new r.LineString(t));const o=0;let h,l;R(t)?(h=H(t),n||(l=J(t))):t instanceof r.LineString&&(h=t.getCoordinates(),n||(l=t.getCenter()));const u=e.coordinateToVector3(n||l);if(i)for(let t=0,n=h.length;t<n;t++){const n=h[t],i=e.coordinateToVector3(n,o).sub(u);s.push(i)}else{const t=e.coordinatiesToGLFloatArray(h,u);a=t.positions,c=t.positons2d}}if(!i)return{positions:a,positionsV:s,positions2d:c,arrayBuffer:c.buffer};c=new Float32Array(2*s.length),a=new Float32Array(3*s.length);for(let t=0,e=s.length;t<e;t++){const e=3*t,n=s[t];a[e]=n.x,a[e+1]=n.y,a[e+2]=n.z;const i=2*t;c[i]=n.x,c[i+1]=n.y}return{positions:a,positionsV:s,positions2d:c,arrayBuffer:c.buffer}}function we(t,e,n,i){const r=[],o=[],s=[];for(let e=0,n=t.length;e<n;e++){const n=t[e];for(let t=0,e=n.length;t<e;t++){const e=n[t];if(s.length>0){e.join(",").toString()!==s[s.length-1].join(",").toString()&&s.push(e)}else s.push(e)}}for(let t=0,a=s.length;t<a;t++){const a=s[t];let c;const h=a.join(",").toString();c=n&&n[h]?n[h]:e.coordinateToVector3(a,0).sub(i),o.push(c),r.push(c.x,c.y,c.z)}return{positions:r,positionsV:o,lnglats:s}}function Me(t,e=1,n=1,i,r){const o=_e(t,i,r).positionsV,s=[];for(let t=0,e=o.length;t<e;t++){const e=o[t];s.push([e.x,e.y])}const{indices:a,position:c,normal:h,uv:l}=ie([s],{lineWidth:e,depth:n});return{position:c,normal:h,indices:a,uv:l}}function Oe(t){let e,n=[];return t instanceof r.MultiLineString?(n=t.getGeometries(),e=t.getCenter()):t instanceof r.LineString?(n.push(t),e=t.getCenter()):R(t)&&(e=J(t),D(t)?n=Q(t):n.push(t)),{lineStrings:n,center:e}}function Se(t){const e=new Float32Array(2*t.length-6);let n=0;for(let i=0,r=t.length/3;i<r;i++){const o=t[3*i],s=t[3*i+1],a=t[3*i+2];if(i>0&&i<r-1){const t=3*n;e[t]=o,e[t+1]=s,e[t+2]=a,n++}const c=3*n;e[c]=o,e[c+1]=s,e[c+2]=a,n++}return e}function Ae(t){let e=0;const n=t.length;if(1===n)return t[0];for(let i=0;i<n;i++)e+=t[i].length;const i=new Float32Array(e);let r=0;for(let e=0;e<n;e++)i.set(t[e],r),r+=t[e].length;return i}function je(t){return t instanceof r.LineString?le(t.getCoordinates()):G(t)?le(t.geometry.coordinates):void 0}let Ce;function Te(){return Ce||(Ce=new o.BufferGeometry,a(Ce,"position",new o.BufferAttribute(new Float32Array(3),3))),Ce}var Le=Object.freeze({__proto__:null,getLinePosition:_e,getExtrudeLineGeometry:function(t,e=1,n=1,i,r){const{indices:s,position:c,normal:h,uv:l}=Me(t,e,n,i,r),u=new o.BufferGeometry;return a(u,"position",new o.BufferAttribute(c,3)),a(u,"normal",new o.BufferAttribute(h,3)),a(u,"uv",new o.BufferAttribute(l,2)),u.setIndex(new o.BufferAttribute(s,1)),u},getChunkLinesPosition:we,getExtrudeLineParams:Me,LineStringSplit:Oe,setLineSegmentPosition:function(t,e){for(let n=0,i=e.length;n<i;n++){const r=e[n];n>0&&n<i-1&&t.push(r.x,r.y,r.z),t.push(r.x,r.y,r.z)}},getLineSegmentPosition:Se,mergeLinePositions:Ae,getLineArrayBuffer:je,getDefaultLineGeometry:Te});let ke;var Pe;function Be(){return r.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),!Pe&&ke&&(Pe=new ke("__maptalks.three__")),Pe}function ze(t,e,n={}){return void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]):0}function Ee(t,e,n,i,r=[]){const o=n.isMercator();let s,a,c;if(o){const t=n.getMap();s=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(c=n.coordinateToVector3(e));const h=[],l=[],u={},d=t.length;for(let s=0;s<d;s++){const a=t[s],d=r[s]?r[s]:G(i[s])?i[s].properties:i[s].getProperties()||{};e||(c=n.coordinateToVector3(d.center));let f=d.width||1,g=d.height||1,p=d.bottomHeight||0;f=ze(f,n,u),g=ze(g,n,u),p=ze(p,n,u);const y=[];for(let t=0,i=a.length;t<i;t++){const i=a[t];let r;r=o?je(i):_e(i,n,e,!1).arrayBuffer,l.push(r),y.push(r)}const x={id:d.id,data:y,height:g,width:f,bottomHeight:p};o&&(x.center=[c.x,c.y]),h.push(x)}return{datas:h,transfer:l,glRes:s,matrix:a,center:o?[c.x,c.y]:null}}function Ve(t,e,n,i,r=[]){const o=n.isMercator();let s,a,c;if(o){const t=n.getMap();s=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(c=n.coordinateToVector3(e));const h=[],l=[],u={},d=t.length;for(let s=0;s<d;s++){const a=t[s],d=r[s]?r[s]:G(i[s])?i[s].properties:i[s].getProperties()||{};e||(c=n.coordinateToVector3(d.center));let f=d.bottomHeight||0;f=ze(f,n,u);const g=[];for(let t=0,i=a.length;t<i;t++){const i=a[t];if(o){const t=je(i);g.push(t),g.push(t)}else{const t=_e(i,n,e,!1).arrayBuffer;l.push(t),g.push(t)}}const p={id:d.id,data:g,bottomHeight:f};o&&(p.center=[c.x,c.y]),h.push(p)}return{datas:h,transfer:l,glRes:s,matrix:a,center:o?[c.x,c.y]:null}}function Ue(t){return t.map((t=>t.data))}function Ie(t){return t.map((t=>t.baseObject.getOptions()))}r.worker&&(ke=class extends r.worker.Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:n,callback:i,layer:r,key:o,center:s,lineStrings:a,options:c,id:h}=t;let l;e.indexOf("ExtrudePolygon")>-1?l=function(t=[],e,n,i=[]){const r=n.isMercator();let o,s,a;if(r){const t=n.getMap();o=t.getGLRes(),s=t.getSpatialReference().getTransformation().matrix}e&&(a=n.coordinateToVector3(e));const c=t.length,h=[],l=[],u={};for(let o=0;o<c;o++){const s=t[o],c=s,d=i[o]?i[o]:F(c)?c.properties:c.getProperties()||{};let f;e||(a=n.coordinateToVector3(d.center)),f=r?ve(s):ye(s,n,d.center||e,a,!0);for(let t=0,e=f.length;t<e;t++){const e=f[t];for(let t=0,n=e.length;t<n;t++)l.push(e[t])}let g=d.height||1,p=d.bottomHeight||0;g=ze(g,n,u),p=ze(p,n,u);const y={id:d.id,data:f,height:g,bottomHeight:p};r&&(y.center=[a.x,a.y]),h.push(y),c._properties&&delete c._properties}return{datas:h,transfer:l,glRes:o,matrix:s,center:r?[a.x,a.y]:null}}(n,s,r,c):"ExtrudeLines"===e?l=Ee(n,s,r,a):"Point"===e||("Line"===e||"FatLine"===e?l=Ve(n,s,r,a,c):"Lines"===e||"FatLines"===e?l=Ve(n,s,r,a):"ExtrudeLine"===e&&(l=Ee(n,s,r,a,c))),l?this.send({type:e,datas:l.datas,glRes:l.glRes,matrix:l.matrix,center:l.center},l.transfer,(function(t,e){t&&console.error(t),e.key=o,e.id=h,i(e)})):console.error(`not support '${e}' worker`)}});class Re{constructor(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}getCurrentTime(){return r.Util.now()}loop(){this.deQueue()}push(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this}reset(){return this.time=this.getCurrentTime(),this.tempQueue=[],this}pushResult(t){if(t)return Array.isArray(t)||(t=[t]),t.forEach((t=>{this.resultQueue.push(t)})),this}deQueue(){if(!this.resultQueue.length)return this;const t=this.deQueueCount;return(this.resultQueue.slice(0,t)||[]).forEach((t=>{const{id:e}=t;if(this.queueMap[e]){const{baseObject:n}=this.queueMap[e];n&&n._workerLoad&&n._workerLoad(t),delete this.queueMap[e]}})),this.resultQueue.splice(0,t),this}}const Fe=new class extends Re{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Be().pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:Ue(this.tempQueue),options:Ie(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Ge=new class extends Re{loop(){if(this.tempQueue.length){const t=Be();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudePolygons",layer:e.layer,data:e.data,key:e.key,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Ze=new class extends Re{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Be().pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:Ue(this.tempQueue),options:Ie(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},De=new class extends Re{loop(){if(this.tempQueue.length){const t=Be();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"ExtrudeLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},He=new class extends Re{constructor(){super(),this.deQueueCount=200}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Be().pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:Ue(this.tempQueue),options:Ie(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},Je=new class extends Re{loop(){if(this.tempQueue.length){const t=Be();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"Lines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},Qe=new class extends Re{constructor(){super(),this.deQueueCount=100}loop(){if((this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){Be().pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:Ue(this.tempQueue),options:Ie(this.tempQueue),lineStrings:this.tempQueue.map((t=>t.lineString)),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}},We=new class extends Re{loop(){if(this.tempQueue.length){const t=Be();this.tempQueue.forEach((e=>{t.pushQueue({id:e.id,type:"FatLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,callback:t=>{this.pushResult(t)}})})),this.reset()}super.loop()}},qe={isRunning:!1,loop(){Fe.loop(),Ge.loop(),Ze.loop(),De.loop(),He.loop(),Je.loop(),Qe.loop(),We.loop(),r.Util.requestAnimFrame(qe.loop)},star(){qe.isRunning||(qe.isRunning=!0,qe.loop())}};function Ne(t){const e=[];return t&&t.length&&t.forEach((t=>{t=t instanceof o.Color?t:new o.Color(t),e.push(t.r,t.g,t.b)})),e}const Ke={altitude:0,bottomHeight:0,colors:null};class Xe extends v{constructor(t,e,n,i){e=r.Util.extend({},Ke,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{lineStrings:s,center:h}=Oe(t),{asynchronous:l}=e;let u;if(l){u=Te();const n=r.Util.GUID();this.getOptions().id=n,this.getOptions().center=h,He.push({id:n,data:s,layer:i,key:e.key,lineString:t,baseObject:this})}else{const t=[];for(let e=0,n=s.length;e<n;e++){const n=s[e],{positions:r}=_e(n,i,h,!1);t.push(Se(r))}const r=Ae(t);u=new o.BufferGeometry,a(u,"position",new o.BufferAttribute(r,3)),ce(u,e.bottomHeight,i);const l=Ne(e.colors);l&&l.length&&(a(u,"color",new o.Float32BufferAttribute(l,3)),n.vertexColors=c())}this._createLineSegments(u,n);const{altitude:d}=e,f=i.distanceToVector3(d,d).x,g=i.coordinateToVector3(h,f);this.getObject3d().position.copy(g),this.type="Line"}_workerLoad(t){const e=new o.BufferGeometry;a(e,"position",new o.BufferAttribute(new Float32Array(t.position),3));const n=Ne(this.getOptions().colors),i=this.getObject3d(),r=i.material;n&&n.length&&(a(e,"color",new o.Float32BufferAttribute(n,3)),r.vertexColors=c()),this._computeLineDistances(e),i.geometry=e,i.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const $e={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class Ye extends v{constructor(t,e,n,i){e=r.Util.extend({},$e,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{height:o,width:s,bottomColor:a,topColor:h,bottomHeight:l,altitude:u,asynchronous:d}=e,f=i.distanceToVector3(o,o).x,g=i.distanceToVector3(s,s).x,{lineStrings:p,center:y}=Oe(t);let x;if(d){x=S();const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=y,Ze.push({id:e,data:p,layer:i,center:y,lineString:t,baseObject:this})}else{const t=[];let e=0;const r={};for(let n=0,o=p.length;n<o;n++){const o=Me(p[n],g,f,i,y);e=ce(o,l,i,r),t.push(o)}x=m(t),h&&(pe(x,a,h,e+f/2),n.vertexColors=c())}this._createMesh(x,n);const v=i.distanceToVector3(u,u).x,b=i.coordinateToVector3(y,v);this.getObject3d().position.copy(b),this.type="ExtrudeLine"}_workerLoad(t){const e=w(t),{topColor:n,bottomColor:i,bottomHeight:r,height:o}=this.getOptions(),s=this.getObject3d(),a=s.material;if(n){const t=this.getLayer();pe(e,i,n,t.distanceToVector3(r,r).x+t.distanceToVector3(o,o).x/2),a.vertexColors=c()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const tn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"};class en extends v{constructor(t,e,n,i){e=r.Util.extend({},tn,e,{layer:i,polygon:t}),super(),this._initOptions(e);const{height:o,topColor:s,bottomColor:a,altitude:h,bottomHeight:l,asynchronous:u}=e;let d;const f=F(t)?J(t):t.getCenter();if(u){d=S();const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=f,Fe.push({data:t,layer:i,id:e,baseObject:this})}else{d=fe(t,o,i);const e=ce(d,l,i);if(s){pe(d,a,s,e+i.distanceToVector3(o,o).x/2),n.vertexColors=c()}}this._createMesh(d,n);const g=i.distanceToVector3(h,h).x,p=i.coordinateToVector3(f,g);this.getObject3d().position.copy(p),this.type="ExtrudePolygon"}_workerLoad(t){const e=w(t),{topColor:n,bottomColor:i,bottomHeight:r,height:o}=this.getOptions(),s=this.getObject3d(),a=s.material;if(n){const t=this.getLayer();pe(e,i,n,t.distanceToVector3(r,r).x+t.distanceToVector3(o,o).x/2),a.vertexColors=c()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}const nn={altitude:0,coordinate:null};class rn extends v{constructor(t,e={},n){e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=r.Util.extend({},nn,e,{layer:n,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:i,coordinate:o}=e,s=n.distanceToVector3(i,i).x,a=n.coordinateToVector3(o,s);this.getObject3d().position.copy(a),this.type="Model"}}const on=Math.PI/180;function sn(t){return t.getCoordinates().map((t=>t.toArray()))}function an(t){return t*on}function cn(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let n=an(t[1]);const i=an(e[1]),r=n-i,o=an(t[0])-an(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(o/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function hn(t,e){const{len:n,c1:i,c2:r}=t,o=r[0]-i[0],s=r[1]-i[1],a=e/n;return[i[0]+a*o,i[1]+a*s]}function ln(t,e=10){e=Math.max(e,1),Array.isArray(t)||(t=sn(t));const n=t.length;let i=[],r=0;for(let e=0;e<n-1;e++){const n=cn(t[e],t[e+1]),o=Math.floor(n);i.push({c1:t[e],len:o,c2:t[e+1]}),r+=o}if(r<=e){return i.map((t=>[t.c1,t.c2]))}if(1===i.length&&i[0].len<=e)return[[i[0].c1,i[0].c2]];const o=i.length;let s,a=0,c=0;const h=[];let l=[i[0].c1];for(;a<o;){const{len:t,c2:n}=i[a];if(c+=t,c<e&&(l.push(n),a===o-1&&h.push(l),a++),c===e&&(l.push(n),c=0,h.push(l),l=[n],a++),c>e){const n=t-c+e;s=hn(i[a],n),l.push(s),h.push(l),c=0,i[a].c1=s,i[a].len=t-n,l=[],l.push(s)}}return h}var un=Object.freeze({__proto__:null,distance:cn,lineLength:function(t){let e=t;Array.isArray(t)||(e=sn(t));let n=0;for(let t=0,i=e.length;t<i-1;t++)n+=cn(e[t],e[t+1]);return n},lineSlice:ln});const dn=1e3;function fn(t,e,n,i){const r=e.length;t.attributes.normal.count=r,t.attributes.position.count=r;const o=t.attributes.position.array,s=t.attributes.normal.array;for(let t=0;t<r;t++)o[t]=e[t],s[t]=n[t];t.index.count=i.length;for(let e=0,n=i.length;e<n;e++)t.index.array[e]=i[e]}const gn={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1};class pn extends v{constructor(t,e,n,i){e=r.Util.extend({},gn,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:s,height:c,altitude:h,speed:l,chunkLength:u,trail:d}=e;let f,g;R(t)?(f=J(t),g=H(t)):(f=t.getCenter(),g=t);const p=ln(g,u),y=i.coordinateToVector3(f),x={};for(let t=0,e=p.length;t<e;t++){const e=p[t];for(let t=0,n=e.length;t<n;t++){const n=e[t],r=n.join(",").toString();x[r]||(x[r]=i.coordinateToVector3(n).sub(y))}}const v=we(p.slice(0,1),i,x,y).positionsV,m=new o.BufferGeometry,b=new Float32Array(3e3),_=new Float32Array(3e3),w=new Uint16Array(dn);a(m,"position",new o.BufferAttribute(b,3)),a(m,"normal",new o.BufferAttribute(_,3)),m.setIndex(new o.BufferAttribute(w,1));const M=i.distanceToVector3(s,s).x,O=i.distanceToVector3(c,c).x,S=Me(v,M,O,i);fn(m,S.position,S.normal,S.indices),this._createMesh(m,n);const A=i.distanceToVector3(h,h).x,j=i.coordinateToVector3(f,A);this.getObject3d().position.copy(j),this._params={index:0,chunkLines:p,geometries:[],layer:i,trail:Math.max(1,d),lineWidth:M,depth:O,speed:Math.min(1,l),idx:0,loaded:!1,positionMap:x,centerPt:y},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:n,lineWidth:i,depth:r,chunkLines:o,positionMap:s,centerPt:a}=t,c=o.length,h=[];for(let t=0;t<c;t++){const c=we(o.slice(t,t+n),e,s,a).positionsV;h.push(Me(c,i,r,e))}this._params.geometries=h,this._params.loaded=!0}_animation(){const{index:t,geometries:e,speed:n,idx:i,chunkLines:r,trail:o,lineWidth:s,depth:a,loaded:c,layer:h,positionMap:l,centerPt:u}=this._params;if(!c)return;const d=Math.round(t);if(d>i){this._params.idx++;let t=e[d];if(!t){t=Me(we(r.slice(d,d+o),h,l,u).positionsV,s,a,h),e[d]=t}const n=this.getObject3d();fn(n.geometry,t.position,t.normal,t.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0}t>=r.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}}const yn=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),xn=new o.MeshBasicMaterial;xn.vertexColors=c();const vn=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,n=t.length;e<n;e++){const n=t[e];this._proxyEvent(n)}return this}_proxyEvent(t){t.on("add",(t=>{this._showGeometry(t.target,!0)})),t.on("remove",(t=>{this._showGeometry(t.target,!1)})),t.on("mouseout",(t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})),t.on(yn,(t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}))}_getHideGeometryIndex(t){const e=[];let n=0;for(let i=0,r=this._geometriesAttributes.length;i<r;i++)!0===this._geometriesAttributes[i].hide&&(e.push(i),n+=this._geometriesAttributes[i][t].count);return{indexs:e,count:n}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];let s=NaN;this.getObject3d()instanceof o.LineSegments&&(s=0);for(let i=0;i<n.length;i++){const r=n[i],{start:o,end:a}=this._geometriesAttributes[r][e];for(let e=o;e<a;e++)t.array[e]=s}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.position,"position"),r.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setPickObject3d(){const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=he(n);let s=0;for(let t=0;t<i;t++){const i=e.getColor(),o=i.getHex();this._colorMap[o]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=o;for(let t=0;t<a;t++)r[s]=i.r,r[s+1]=i.g,r[s+2]=i.b,s+=3}a(t,"color",new o.BufferAttribute(r,3,!0));const c=e.getColor().getHex(),h=new o.Mesh(t,xn);h.position.copy(this.getObject3d().position),h._colorIndex=c,this.setPickObject3d(h)}},mn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},bn=new r.Coordinate(0,0);class _n extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=t.length;0===o&&console.error("polygons is empty");let s=1/0,a=1/0,h=-1/0,l=-1/0;for(let e=0;e<o;e++){const n=t[e],i=n.getCenter?n.getCenter():J(n,bn);let o,c;Array.isArray(i)?(o=i[0],c=i[1]):i instanceof r.Coordinate&&(o=i.x,c=i.y),s=Math.min(s,o),a=Math.min(a,c),h=Math.max(h,o),l=Math.max(l,c)}const u=new r.Coordinate((s+h)/2,(a+l)/2);e=r.Util.extend({},mn,e,{layer:i,polygons:t,coordinate:u});const{topColor:d,bottomColor:f,altitude:g,asynchronous:p}=e;let y;const x=[],v=[],b=[];if(super(),p)y=S(),Ge.push({id:r.Util.GUID(),layer:i,key:e.key,center:u,data:t,baseObject:this});else{const e=i.coordinateToVector3(u),r=[];let s=0,a=0,h=0,l=0;const g={};for(let n=0;n<o;n++){const o=t[n],c=F(o)?o.properties:o.getProperties()||{},d=c.height||1,f=c.bottomHeight||0,p=ge(o,d,i,u,e,g);r.push(p);const y=ce(p,f,i,g),{position:x,normal:m,uv:_,indices:w}=p,M=w.length/3;v[n]=[s+1,s+M],s+=M;const O=x.length/3,S=m.length/3,A=_.length/2;b[n]={position:{middleZ:y+g[d]/2,count:O,start:a,end:a+3*O},normal:{count:S,start:h,end:h+3*S},uv:{count:A,start:l,end:l+2*A},hide:!1},a+=3*O,h+=3*S,l+=2*A}y=m(r),d&&(pe(y,f,d,b),n.vertexColors=c())}this._initOptions(e),this._createMesh(y,n);const _=i.distanceToVector3(g,g).x,w=i.coordinateToVector3(u,_);this.getObject3d().position.copy(w),this._faceMap=v,this._baseObjects=x,this._datas=t,this._geometriesAttributes=b,this.faceIndex=null,this._geometryCache=y.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(x),p||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,F(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new en(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const i=w(t);this._geometryCache=M(i);const{topColor:r,bottomColor:o}=this.getOptions(),s=this.getObject3d(),a=s.material;if(r&&(pe(i,o,r,n),a.vertexColors=c()),s.geometry=i,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}function wn(t,e,n){const i=t.project(n),r=e.width/2,o=e.height/2;return{x:Math.round(i.x*r+r),y:Math.round(-i.y*o+o)}}var Mn=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,n,i=0,r){return t[0]instanceof o.Vector3||(t=function(t,e=0,n){const i=[],r={};for(let s=0,a=t.length;s<a;s+=3){let a=t[s],c=t[s+1],h=t[s+2];e>0&&(h+=se(e,n,r)),i.push(new o.Vector3(a,c,h))}return i}(t,i,r)),t.map((t=>wn(t,e,n)))},vector2Pixel:wn});const On={altitude:0,height:0,color:null},Sn=new o.Vector3;class An extends v{constructor(t,e,n,i){e=r.Util.extend({},On,e,{layer:i,coordinate:t}),super();let{height:s,altitude:c,color:h,size:l}=e;const u=[],d=[];h&&(h=h instanceof o.Color?h:new o.Color(h),d.push(h.r,h.g,h.b));const f=i.distanceToVector3(s,s).x,g=i.coordinateToVector3(t,f);u.push(0,0,g.z);const p=new o.BufferGeometry;a(p,"position",new o.Float32BufferAttribute(u,3,!0)),d.length&&a(p,"color",new o.Float32BufferAttribute(d,3,!0)),void 0!==l&&a(p,"size",new o.Float32BufferAttribute([l],1,!0)),e.positions=g,this._initOptions(e),this._createPoints(p,n);const y=i.distanceToVector3(c,c).x,x=new o.Vector3(g.x,g.y,y);this.getObject3d().position.copy(x),this.type="Point"}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().positions,o=this.getOptions().altitude;let s=this.getObject3d().material.size;void 0===s&&(s=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),c=e.distanceToVector3(o,o).x;Sn.x=r.x,Sn.y=r.y,Sn.z=r.z+c;const h=wn(Sn,n,i);return Math.sqrt(Math.pow(a.x-h.x,2)+Math.pow(a.y-h.y,2))<=s/2}}function jn(t,e){const{minx:n,miny:i,maxx:r,maxy:o}=t,[s,a]=e;return n<=s&&s<=r&&i<=a&&a<=o}class Cn{constructor(t,e,n,i){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=i,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let e=1/0,n=1/0,i=-1/0,o=-1/0;const{minlng:s,minlat:a,maxlng:c,maxlat:h}=this;return[[s,a],[s,h],[c,a],[c,h]].map((t=>new r.Coordinate(t))).map((e=>t.coordToContainerPoint(e))).forEach((t=>{e=Math.min(e,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),o=Math.max(o,t.y)})),this.minx=e,this.miny=n,this.maxx=i,this.maxy=o,this}containsCoordinate(t){let e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof r.Coordinate&&(e=t.x,n=t.y);const{minlng:i,minlat:o,maxlng:s,maxlat:a}=this;return i<=e&&e<=s&&o<=n&&n<=a}isRecCross(t,e){const{x:n,y:i}=t,r={minx:n-e/2,miny:i-e/2,maxx:n+e/2,maxy:i+e/2},{minx:o,miny:s,maxx:a,maxy:c}=r;return!!(jn(this,[o,s])||jn(this,[o,c])||jn(this,[a,s])||jn(this,[a,c])||jn(r,[this.minx,this.miny])||jn(r,[this.minx,this.maxy])||jn(r,[this.maxx,this.miny])||jn(r,[this.maxx,this.maxy]))}static initGrids(t,e,n,i){const r=[],o=(n-t)/30,s=(i-e)/30;let a=t,c=e;for(let n=0;n<30;n++){a=t+n*o;for(let t=0;t<30;t++){c=e+t*s;const i=new Cn(a,c,a+o,c+s);i.key=t+"-"+n,r.push(i)}}return{grids:r,averageX:o,averageY:s,ROWS:30,COLS:30}}}const Tn={altitude:0},Ln=new o.Vector3;function kn(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}class Pn extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]),e=r.Util.extend({},Tn,e,{layer:i,points:t});let s=1/0,c=1/0,h=-1/0,l=-1/0;for(let e=0,n=t.length;e<n;e++){const{coordinate:n}=t[e];let i,o;Array.isArray(n)?(i=n[0],o=n[1]):n instanceof r.Coordinate&&(i=n.x,o=n.y),t[e].coords=[i,o],s=Math.min(s,i),c=Math.min(c,o),h=Math.max(h,i),l=Math.max(l,o)}const u=i.coordinateToVector3([(s+h)/2,(c+l)/2]),{grids:d,averageX:f,averageY:g,ROWS:p,COLS:y}=Cn.initGrids(s,c,h,l);d.length;const x=new Float32Array(3*t.length),v=[],m=new Float32Array(3*t.length),b=new Float32Array(t.length),_=[],w=[],M={};let O=0,S=!1,A=!1;const j=new o.Vector3(0,0,0);for(let e=0,n=t.length;e<n;e++){let{coordinate:n,height:r,color:a,size:h,coords:l}=t[e];const y=3*e;a&&(S=!0,a=a instanceof o.Color?a:new o.Color(a),m[y]=a.r,m[y+1]=a.g,m[y+2]=a.b),h&&(A=!0,b[e]=h,O=Math.max(O,h));const _=se(r,i,M),C=i.coordinateToVector3(n,_);j.x=C.x,j.y=C.y,j.z=C.z,j.sub(u),x[y]=j.x,x[y+1]=j.y,x[y+2]=j.z,v.push(C),w[e]={position:{count:1,start:3*e,end:3*e+3},hide:!1};let T=kn((l[1]-c)/g,4),L=kn((l[0]-s)/f,4);T-=1,L-=1,T=Math.max(0,T),L=Math.max(0,L),T=Math.ceil(T),L=Math.ceil(L);const k=L*p+T;d[k]&&(d[k].positions.push(C),d[k].indexs.push(e))}const C=new o.BufferGeometry;a(C,"position",new o.BufferAttribute(x,3,!0)),S&&a(C,"color",new o.BufferAttribute(m,3,!0)),A&&a(C,"size",new o.BufferAttribute(b,1,!0)),e.positions=v,super(),this._initOptions(e),this._createPoints(C,n);const T=e.altitude,L=i.distanceToVector3(T,T).x,k=u.clone();k.z=L,this.getObject3d().position.copy(k),this._baseObjects=_,this._datas=t,this.faceIndex=null,this._geometriesAttributes=w,this._geometryCache=C.clone(),this.isHide=!1,this._initBaseObjectsEvent(_),this._grids=d,this._bindMapEvents(),this.type="Points",this.maxSize=O}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(()=>{this._updateGrids(),t.on(e,this._updateGrids,this)})),this.on("remove",(()=>{t.off(e,this._updateGrids,this)}))}_updateGrids(){const t=this.getMap();this._grids.forEach((e=>{e.indexs.length&&e.updateBBoxPixel(t)}))}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:n,height:i,color:r,size:o}=e;this._baseObjects[t]=new An(n,{height:i,index:t,color:r,size:o},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),i=this.getLayer().getCamera(),r=this.getOptions().altitude,o=this.getMap(),s=e.distanceToVector3(r,r).x;let a=this.getObject3d().material.size;const c=void 0===a,h=o.coordToContainerPoint(t),l=[];if(this._grids.forEach((t=>{t.indexs.length&&t.isRecCross(h,c?this.maxSize:a)&&l.push(t)})),l.length<1)return!1;for(let t=0,e=l.length;t<e;t++)for(let e=l[t].positions.length-1;e>=0;e--){c&&(a=this._datas[l[t].indexs[e]].size||1);const r=l[t].positions[e];Ln.x=r.x,Ln.y=r.y,Ln.z=r.z+s;const o=wn(Ln,n,i);if(Math.sqrt(Math.pow(h.x-o.x,2)+Math.pow(h.y-o.y,2))<=a/2)return this.faceIndex=l[t].indexs[e],!0}return!1}}const Bn={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class zn extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=t.length,s=ae(t),a=i.coordinateToVector3(s),h=[],l=[],u=[],d=[];let f=0,g=0,p=0,y=0;const x={};for(let e=0;e<o;e++){const o=r.Util.extend({index:e},Bn,t[e]),{radius:s,radialSegments:v,altitude:m,topColor:b,bottomColor:_,height:w,coordinate:M}=o,O=se(s,i,x),S=se(w,i,x),A=se(m,i,x),j=k({radius:O,height:S,radialSegments:v});b&&(P(j,_,b,"z",S/2),n.vertexColors=c());const C=i.coordinateToVector3(M).sub(a),T=j.attributes.position.array;for(let t=0,e=T.length;t<e;t+=3)T[t+2]+=A,T[t]+=C.x,T[t+1]+=C.y,T[t+2]+=C.z;h.push(j);const L=new V(M,o,n,i);l.push(L);const B=j.index.count/3;d[e]=[f+1,f+B],f+=B;const z=j.attributes.position.count,E=j.attributes.normal.count,U=j.attributes.uv.count;u[e]={position:{count:z,start:g,end:g+3*z},normal:{count:E,start:p,end:p+3*E},uv:{count:U,start:y,end:y+2*U},hide:!1},g+=3*z,p+=3*E,y+=2*U}super(),e=r.Util.extend({},{altitude:0,layer:i,points:t},e),this._initOptions(e);const v=B(h);this._createMesh(v,n);const m=e.altitude,b=i.distanceToVector3(m,m).x,_=a.clone();_.z=b,this.getObject3d().position.copy(_),this._faceMap=d,this._baseObjects=l,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=v.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Bars"}identify(){return this.picked}}const En={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class Vn extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=[],s=[],a=t.length;for(let e=0;e<a;e++){const n=Oe(t[e]);o.push(n.center),s.push(n.lineStrings)}const h=ae(o);e=r.Util.extend({},En,e,{layer:i,lineStrings:t,coordinate:h});const{altitude:l,topColor:u,bottomColor:d,asynchronous:f}=e;let g;const p=[],y=[];if(super(),f)g=S(),De.push({id:r.Util.GUID(),layer:i,key:e.key,center:h,data:s,lineStrings:t,baseObject:this});else{const e=[];let o=0,l=[],f=0,p=0;const x={};for(let n=0;n<a;n++){const a=t[n],c=r.Util.extend({},En,R(a)?a.properties:a.getProperties(),{index:n}),{height:u,width:d,bottomHeight:g}=c,v=se(d,i,x),m=se(u,i,x),_=s[n],w=[];let M=0;for(let t=0,e=_.length;t<e;t++){const e=Me(_[t],v,m,i,h);M=ce(e,g,i,x),w.push(e)}const O=b(w);e.push(O);const{position:S,normal:A,indices:j}=O,C=j.length/3;l[n]=[o+1,o+C],o+=C;const T=S.length/3,L=A.length/3;y[n]={position:{middleZ:M+m/2,count:T,start:f,end:f+3*T},normal:{count:L,start:p,end:p+3*L},hide:!1},f+=3*T,p+=3*L}g=m(e),u&&(pe(g,d,u,y),n.vertexColors=c())}this._initOptions(e),this._createMesh(g,n);const x=i.distanceToVector3(l,l).x,v=i.coordinateToVector3(h,x);this.getObject3d().position.copy(v),this._faceMap=[],this._baseObjects=p,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this._geometryCache=g.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(p),f||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,G(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new Ye(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const i=w(t);this._geometryCache=M(i);const{topColor:r,bottomColor:o,bottomHeight:s,height:a}=this.getOptions(),h=this.getObject3d().material;if(r&&(pe(i,o,r,n),h.vertexColors=c()),this.getObject3d().geometry=i,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Un={altitude:0,colors:null};class In extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],c=[],h=t.length;for(let e=0;e<h;e++){const n=Oe(t[e]);s.push(n.center),c.push(n.lineStrings)}const l=ae(s);e=r.Util.extend({},Un,e,{layer:i,lineStrings:t,coordinate:l}),super(),this._initOptions(e);const{asynchronous:u}=e;let d;const f=[],g={};let p=0,y=[],x=[],v=0,m=[];if(u)d=Te(),Je.push({id:r.Util.GUID(),layer:i,key:e.key,center:l,data:c,lineStrings:t,baseObject:this});else{for(let t=0;t<h;t++){const e=c[t];let n=0;for(let t=0,r=e.length;t<r;t++){const r=G(e[t])?e[t].properties:e[t].getProperties()||{},{positions:o}=_e(e[t],i,l,!1);ce(o,r.bottomHeight,i,g),n+=o.length/3*2-2,m.push(Se(o))}const r=n;y[t]=[p,p+r],p+=r,x[t]={position:{count:n,start:v,end:v+3*n},hide:!1},v+=3*n}const t=Ae(m);d=new o.BufferGeometry,a(d,"position",new o.BufferAttribute(t,3))}this._createLineSegments(d,n);const{altitude:b}=e,_=i.distanceToVector3(b,b).x,w=i.coordinateToVector3(l,_);this.getObject3d().position.copy(w),this._faceMap=y,this._baseObjects=f,this._datas=t,this._geometriesAttributes=x,this.faceIndex=null,this.index=null,this._geometryCache=d.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(f),u||(this._setPickObject3d(),this._init()),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=r.Util.extend({},this.getOptions(),{index:t},G(e)?e.properties:e.getProperties());this._baseObjects[t]=new Xe(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,i=n.length,r=he(n);let s=0;for(let t=0;t<i;t++){const i=e.getColor(),o=i.getHex();this._colorMap[o]=t;const{count:a}=n[t].position;this._datas[t].colorIndex=o;for(let t=0;t<a;t++)r[s]=i.r,r[s+1]=i.g,r[s+2]=i.b,s+=3}a(t,"color",new o.BufferAttribute(r,3,!0));const h=this.getObject3d().material.clone();h.color.set("#fff"),h.vertexColors=c();const l=e.getColor().getHex(),u=new o.LineSegments(t,h);u.position.copy(this.getObject3d().position),u._colorIndex=l,this.setPickObject3d(u)}identify(t){return this.picked}_workerLoad(t){const{position:e,faceMap:n,geometriesAttributes:i}=t;this._faceMap=n,this._geometriesAttributes=i;const r=new o.BufferGeometry;if(a(r,"position",new o.BufferAttribute(new Float32Array(e),3)),this._computeLineDistances(r),this._geometryCache=r.clone(),this.getObject3d().geometry=r,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const Rn=[],Fn=[];function Gn(){return{waitingQueue:Rn,currentQueue:Fn}}function Zn(t,e){for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i){const{key:r,callback:o}=i;if(e===r)return t.splice(n,1),o}}return null}const Dn=document.createElement("canvas"),Hn=256;function Jn(t,e=!1){const n=Dn.getContext("2d");if(n.clearRect(0,0,Hn,Hn),n.save(),e){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;const e=t||"tile";n.font="18px sans-serif",n.rect(0,0,Hn,Hn),n.stroke(),n.fillText(e,15,128)}return Dn.toDataURL()}function Qn(t=1,e=1){let n;return"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}Dn.width=Dn.height=Hn;class Wn extends r.TileLayer{constructor(t,e={}){super(r.Util.GUID(),r.Util.extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let n in t){const t=this._baseObjectKeys[n];if(t&&Array.isArray(t)&&t.length)for(let n=0,i=t.length;n<i;n++)e.push(t[n])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:e,url:n,callback:i,img:o}=t;r.Ajax.getJSON(n,{},(function(t,n){t?(console.error(t),i(e,null,o)):i(e,n,o)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],n={};for(let i=0,r=t.length;i<r;i++){const r=t[i].tiles||[];for(let t=0,i=r.length;t<i;t++){const{id:i}=r[t];e.push(i),n[i]=!0}}return{keys:e,keysMap:n}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime();if(t-this._layerLaodTime<20)return;this._layerLaodTime=t;const e=this._renderer.tilesInView,n=this._loadTiles,i=this._layer,r=this._baseObjectKeys,o=Object.keys(e).length,s=Object.keys(n).length,a=[];if(o&&s)for(let t in n)e[t]||r[t]&&(r[t]||[]).forEach((t=>{a.push(t)}));if(a.length&&i.removeMesh(a,!1),o&&s)for(let t in e)if(!n[t])if(r[t]){const e=r[t];i.addMesh(e)}else{const{x:e,y:n,z:i}=this._getXYZOfIndex(t);this.getTileUrl(e,n,i)}this._loadTiles=Object.assign({},e),this._diffCache()}_init(){}_workerLoad(t){const e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=Jn(e._key,this._opts.debug))}_generateBaseObjects(t,e,n){if(e&&n){const{keysMap:i}=this._getCurentTileKeys();if(!i[t])return void(n.src=Jn(t,this._opts.debug));const r=this.formatBaseObjects(t,e);if(r.length){n.needCount=r.length,n.currentCount=0;for(let e=0,i=r.length;e<i;e++){const i=r[e];i._img=n,i._vt=this,this.isVisible()||i.hide(),this._cachetile(t,i),i.isAsynchronous()||n.currentCount++}this._layer.addMesh(r,!1),n.needCount===n.currentCount&&(n.src=Jn(t,this._opts.debug)),this.isAsynchronous()?r.filter((t=>t.isAsynchronous())).forEach((t=>{t.on("workerload",this._workerLoad,this)})):n.src=Jn(t,this._opts.debug)}else n.src=Jn(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=Jn(t,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(let i in this._baseObjectKeys)t[i]||e[i]||((this._baseObjectKeys[i]||[]).forEach((t=>{t.isAdd&&n.push(t)})),this._diposeBaseObject(i),delete this._baseObjectKeys[i]);n.length&&this._layer.removeMesh(n,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach((t=>{t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[n,i,r]=t.split(e).slice(1,4);return{x:parseInt(i),y:parseInt(n),z:parseInt(r)}}_getTileExtent(t,e,n){const i=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,i)}_getTileLngLatExtent(t,e,n){const i=this._getTileExtent(t,e,n);let o=i.getMax(),s=i.getMin();const a=this.getMap().getProjection();return s=a.unproject(s),o=a.unproject(o),new r.Extent(s,o)}}const qn={worker:!1};class Nn extends Wn{constructor(t,e={},n,i){super(r.Util.GUID(),r.Util.extend({urlTemplate:t},qn,e)),this._opts=e,this._layer=i,this.getMaterial=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,e){const n=this._opts,i=[],s=this.isAsynchronous();for(let a in e){const c=e[a]||{};let h;if(Array.isArray(c)?h=c:"FeatureCollection"===c.type&&(h=c.features),h&&h.length){const e=[],l=[],u=[];for(let t=0,n=h.length;t<n;t++){const n=h[t];if(F(n))e.push(n);else if(G(n)){const t=Q(n);for(let e=0,n=t.length;e<n;e++)l.push(t[e])}else if(Z(n)){const t=Q(n);for(let e=0,n=t.length;e<n;e++)u.push(r.Util.extend({},t[e].properties,t[e],{coordinate:H(t[e])}))}}if(e.length){const o=this._getMaterial(a,e,t,c);if(o){const c=this._layer.toExtrudePolygons(e,r.Util.extend({},{topColor:"#fff",layerName:a,asynchronous:s,key:t},n),o);i.push(c)}}if(l.length){const e=this._getMaterial(a,l,t,c);if(e&&(e instanceof o.LineBasicMaterial||e instanceof o.LineDashedMaterial)){const t=this._layer.toLines(l,r.Util.extend({},{layerName:a,asynchronous:s},n),e);i.push(t)}}if(u.length){const e=this._getMaterial(a,u,t,c);if(e&&e instanceof o.PointsMaterial){const t=this._layer.toPoints(u,r.Util.extend({},{layerName:a,asynchronous:s},n),e);i.push(t)}}}}return i}loopMessage(t){const{currentQueue:e}=Gn();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;!function(t){const e=Zn(Rn,t);e&&e(t)}((t.info||{}).id)},t.renderer.loadTileImage=(t,e,n)=>{t._key=n,function(t,e,n,i,r){const o={key:t,url:e,callback:n,img:i,vt:r};Fn.length<10?(Fn.push(o),r.loopMessage(o)):Rn.push(o)}(n,e,((t,e,n)=>{this._generateBaseObjects(t,e,n),function(t,e){if(Zn(Fn,t),Rn.length){Fn.push(Rn[0]),Rn.splice(0,1);const t=Fn[Fn.length-1];e.loopMessage(t)}}(t,this)}),t,this)}}))}_getMaterial(t,e,n,i){return this.getMaterial&&r.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,i):null}}function Kn(t,e,n,i){const{position:r,uv:s,normal:c,indexs:h}=function(t,e,n,i){const r=t/n,o=e/i,s=-t/2,a=e/2,c=-e/2,h=(n+1)*(i+1),l=new Float32Array(3*h),u=new Float32Array(2*h),d=new Float32Array(3*h),f=new Uint32Array(10*h);let g=0,p=0,y=0;for(let h=0;h<=i;h++)for(let x=0;x<=n;x++){const v=s+r*x,m=a-o*h;l[g]=v,l[g+1]=m,l[g+2]=0,d[g]=0,d[g+1]=0,d[g+2]=1;const b=(v-s)/t,_=(m-c)/e;if(u[p]=b,u[p+1]=_,g+=3,p+=2,x<n&&h<i){const t=h*(n+1)+x,e=t+1,i=(n+1)*(h+1)+x,r=i+1;f[y]=t,f[y+1]=i,f[y+2]=e,f[y+3]=i,f[y+4]=r,f[y+5]=e,y+=6}}const x=new Uint32Array(y);for(let t=0,e=x.length;t<e;t++)x[t]=f[t];return{position:l,uv:u,normal:d,indexs:x}}(t,e,n,i),l=new o.BufferGeometry;return a(l,"position",new o.BufferAttribute(r,3)),a(l,"normal",new o.BufferAttribute(c,3)),a(l,"uv",new o.BufferAttribute(s,2)),l.setIndex(new o.BufferAttribute(h,1)),l}const Xn=new o.TextureLoader,$n=document.createElement("canvas");function Yn(t){if(!t)return null;let e;return"string"==typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const ti={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null};class ei extends v{constructor(t,e,n,i){e=r.Util.extend({},ti,e,{layer:i,extent:t});const{texture:o,image:s,altitude:a,imageHeight:c,imageWidth:h}=e;s||console.error("not find image"),t instanceof r.Extent||(t=new r.Extent(t));const{xmin:l,ymin:u,xmax:d,ymax:f}=t;let g=1/0,p=1/0,y=-1/0,x=-1/0;[[l,u],[l,f],[d,f],[d,u]].forEach((t=>{const e=i.coordinateToVector3(t),{x:n,y:r}=e;g=Math.min(n,g),p=Math.min(r,p),y=Math.max(n,y),x=Math.max(r,x)}));const v=Math.abs(y-g),m=Math.abs(x-p),b=Yn(s),_=Yn(o),w=Kn(v,m,h-1,c-1);super(),this._initOptions(e),this._createMesh(w,n);const M=i.distanceToVector3(a,a).x,O=i.coordinateToVector3(t.getCenter(),M);this.getObject3d().position.copy(O),n.transparent=!0,b&&(n.opacity=0,b.onload=()=>{const t=function(t,e=256,n=256){$n.width=e,$n.height=n;const i=$n.getContext("2d");return i.drawImage(t,0,0,e,n),i.getImageData(0,0,e,n).data}(b,h,c);let e=0;const r={};for(let n=0,o=t.length;n<o;n+=4){const o=se(.1*(256*t[n]*256+256*t[n+1]+t[n+2])-1e4,i,r);w.attributes.position.array[3*e+2]=o,e++}w.attributes.position.needsUpdate=!0,_?Xn.load(_.src,(t=>{n.map=t,n.opacity=1,n.needsUpdate=!0})):n.opacity=1},b.onerror=function(){console.error(`not load ${b.src}`)}),this.type="Terrain"}}const ni={scale:1,tileDivisor:4};class ii extends Wn{constructor(t,e={},n,i){super(r.Util.GUID(),r.Util.extend({urlTemplate:t},ni,e)),this._opts=e,this._layer=i,this.material=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const n=this.options,i=[],{scale:r,tileDivisor:o}=n,{x:s,y:a,z:c}=this._getXYZOfIndex(t),h=this.getMap().getZoom(),l=this.getTileUrl(s,a,c),[u,d]=this.options.tileSize,f=this._getTileLngLatExtent(s,a,c),g=this.material.clone();if(c+1>=Math.round(h)){const t=new ei(f,{image:e,imageWidth:u/o,imageHeight:d/o,texture:l},g,this._layer);t.getObject3d().scale.set(r,r,1),i.push(t)}return i}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",(()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval((()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")}),1e3)})),this.on("remove",(()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)})),this.on("show",(()=>{this.getBaseObjects().forEach((t=>{t.show()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.show()}))}})),this.on("hide",(()=>{this.getBaseObjects().forEach((t=>{t.hide()}));for(let t in this._baseObjectKeys){(this._baseObjectKeys[t]||[]).forEach((t=>{t.hide()}))}})),this.on("renderercreate",(t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},n=this._imgQueue[e.id];n&&(n.src="",n.onload=null,n.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,n)=>{t._key=n;const i=new Image;this._imgQueue[n]=i;const r={key:n,url:e,rgbImage:i,callback:(t,e,n)=>{this._generateBaseObjects(t,e,n)},img:t,vt:this};this.loopMessage(r)}}))}}
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */function ri(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function oi(t,e,n){var i=si(n),r=function(t){return t.min||0}(n),o=i-r,s=n.range||null,a=0,c=1024;s&&2===s.length&&(a=(s[0]-r)/o*1024),s&&2===s.length&&(c=(s[1]-r)/o*1024);for(var h,l=n.maxOpacity||.8,u=n.minOpacity||0,d=3,f=t.length;d<f;d+=4)h=4*t[d],t[d]/256>l&&(t[d]=256*l),t[d]/256<u&&(t[d]=256*u),h&&h>=a&&h<=c?(t[d-3]=e[h],t[d-2]=e[h+1],t[d-1]=e[h+2]):t[d]=0}function si(t){return t.max||100}function ai(t,e,n){var i=si(n),r=
/*!
     * Code from baidu mapv
     * License: BSD-3
     * https://github.com/huiyan-fe/mapv
     *
     */
function(t){var e=t/2,n=t+e,i=1e4,r=Qn(2*n,2*n),o=r.getContext("2d");return o.shadowBlur=e,o.shadowColor="black",o.shadowOffsetX=o.shadowOffsetY=i,o.beginPath(),o.arc(n-i,n-i,t,0,2*Math.PI,!0),o.closePath(),o.fill(),r}(n._size||n.size||13),o=r.width/2,s=r.height/2,a=e,c={};for(var h in a.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/i).toFixed(2);c[n]=c[n]||[],c[n].push(t)})),c)if(!isNaN(h)){var l=c[h];t.beginPath(),n.withoutAlpha||(t.globalAlpha=h),l.forEach((function(e){var n=e.coordinate,a=void 0===e.count?1:e.count;t.globalAlpha=a/i,t.drawImage(r,n[0]-o,n[1]-s)}))}}ri.prototype.setMax=function(t){this.max=t||100},ri.prototype.setMin=function(t){this.min=t||0},ri.prototype.setMaxSize=function(t){this.maxSize=t||35},ri.prototype.setMinSize=function(t){this.minSize=t||0},ri.prototype.initPalette=function(){var t=this.gradient,e=Qn(256,1),n=this.paletteCtx=e.getContext("2d"),i=n.createLinearGradient(0,0,256,1);for(var r in t)i.addColorStop(parseFloat(r),t[r]);n.fillStyle=i,n.fillRect(0,0,256,1)},ri.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},ri.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,i=this.min;t>n&&(t=n),t<i&&(t=i);var r=4*Math.floor((t-i)/(n-i)*255);return[e[r],e[r+1],e[r+2],e[r+3]]},ri.prototype.getSize=function(t){var e=this.max,n=this.min,i=this.maxSize,r=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?r+(t-n)/(e-n)*(i-r):i},ri.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,i=t.height||180,r=Qn(n,i),o=r.getContext("2d"),s=o.createLinearGradient(0,i,0,0);for(var a in e)s.addColorStop(parseFloat(a),e[a]);return o.fillStyle=s,o.fillRect(0,0,n,i),r};var ci={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var i=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+i+")";var r=Qn(t.canvas.width,t.canvas.height),o=r.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var s=new ri({gradient:n.gradient});if(ai(o,e,n),!n.absolute){var a=o.getImageData(0,0,t.canvas.width,t.canvas.height);oi(a.data,s.getImageData(),n),t.putImageData(a,0,0),t.restore()}s=null,r=null}},drawGray:ai,colorize:oi};const hi={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},li=2048;class ui extends v{constructor(t,e,n,i){Array.isArray(t)||(t=[t]);let s=1/0,h=1/0,l=-1/0,u=-1/0;const d=[];for(let e=0,n=t.length;e<n;e++){const{coordinate:n,lnglat:r,xy:o}=t[e],a=n||r||o;if(!a){console.warn("not find coordinate");continue}const c=i.coordinateToVector3(a);d.push(c);const{x:f,y:g}=c;s=Math.min(s,f),h=Math.min(h,g),l=Math.max(l,f),u=Math.max(u,g)}e=r.Util.extend({},hi,e,{layer:i,points:t});let{gridScale:f,altitude:g}=e;const p=Math.abs(l-s),y=Math.abs(u-h),x=Math.max(p*f,y*f);if(x>li){console.warn(`gridScale: ${f} it's too big. I hope it's a smaller value,canvas max size is 2048* 2048`);f=li/(x/f)}const v=Math.ceil(p*f),m=Math.ceil(y*f),b=v/p,_=m/y,w=[];for(let e=0,n=d.length;e<n;e++){const n=d[e];n.x-=s,n.y-=h,n.x*=b,n.y*=_,n.y=m-n.y,w.push({coordinate:[n.x,n.y],count:t[e].count})}let M=Qn(v,m),O=M.getContext("2d");ci.drawGray(O,w,e);const S=O.getImageData(0,0,O.canvas.width,O.canvas.height);let A=-1/0;const j=new Float32Array(S.data.length/4),C=new Float32Array(S.data.length/4);for(let t=3,e=S.data.length,n=0;t<e;t+=4){const e=S.data[t];A=Math.max(A,e),C[n]=e,e<=0&&(j[n]=1),n++}const T=new ri({gradient:e.gradient});ci.colorize(S.data,T.getImageData(),e),M=null,O=null;const L=Kn(p,y,v-1,m-1),k=L.getIndex().array,P=L.attributes.position.array,B=new Float32Array(P.length),z=new Uint32Array(6*P.length),E=new o.Color;let V=0;for(let t=0,e=P.length,n=0,i=k.length,r=0,o=S.data.length,s=0;t<Math.max(e,i,o);t+=3){if(t<e){const e=C[s];e>0&&(P[t+2]=e/A)}if(n<i){const t=k[n],e=k[n+1],i=k[n+2];j[t]&&j[e]&&j[i]||(z[V]=t,z[V+1]=e,z[V+2]=i,V+=3)}if(r<o){const t=`rgb(${S.data[r]},${S.data[r+1]},${S.data[r+2]})`;E.setStyle(t),B[n]=E.r,B[n+1]=E.g,B[n+2]=E.b}n+=3,r+=4,s++}const U=new Uint32Array(V);for(let t=0;t<V;t++)U[t]=z[t];L.setIndex(new o.BufferAttribute(U,1)),a(L,"color",new o.BufferAttribute(B,3,!0)),n.vertexColors=c(),super(),this._initOptions(e),this._createMesh(L,n);const I=i.distanceToVector3(g,g).x;this.getObject3d().position.copy(new o.Vector3((s+l)/2,(h+u)/2,I)),this.type="HeatMap"}}const di=new o.Color;let fi=1;class gi{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new o.WebGLRenderTarget(1,1),this.pickingScene=new o.Scene}getColor(){return di.setHex(fi),fi++,di}add(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e.__parent;if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:n,pickingTexture:i,pickingScene:r,object3ds:o,layer:s}=this,a=this.pickingScene.children.length;for(let t=0;t<a;t++){const e=this.pickingScene.children[t];e&&e.__parent&&(e.__parent.picked=!1)}const{width:c,height:h}=s._getRenderer().canvas,l=i.width,u=i.height;c===l&&h===u||i.setSize(c,h),n.setRenderTarget(i),n.clear(),n.render(r,e);const d=new Uint8Array(4),{x:f,y:g}=t,p=window.devicePixelRatio,y=f*p,x=i.height-g*p;n.readRenderTargetPixels(i,Math.round(y),Math.round(x),1,1,d);const v=d[0]<<16|d[1]<<8|d[2],m=o[v];if(m)m.__parent&&(o[v].__parent.picked=!0);else for(let t=0;t<a;t++){const e=this.pickingScene.children[t];if(e&&e.__parent){const t=e.__parent;if(t._colorMap&&null!=t._colorMap[v]){t.picked=!0,t.index=t._colorMap[v];break}}}n.setRenderTarget(null)}}const pi={bottomHeight:0,altitude:0};class yi extends v{constructor(t,e,n,i){e=r.Util.extend({},pi,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{asynchronous:o}=e,{lineStrings:s,center:a}=Oe(t),c=new g;let h;if(o){const e=r.Util.GUID();this.getOptions().id=e,this.getOptions().center=a,Qe.push({id:e,data:s,lineString:t,center:a,layer:i,baseObject:this})}else{const t=[],n={};for(let r=0,o=s.length;r<o;r++){const o=_e(s[r],i,a,!1).positions;ce(o,e.bottomHeight,i,n),t.push(Se(o))}h=Ae(t),c.setPositions(h)}this._setMaterialRes(i,n),this._createLine2(c,n);const{altitude:l}=e,u=i.distanceToVector3(l,l).x,d=i.coordinateToVector3(a,u);this.getObject3d().position.copy(d),o||(this._setPickObject3d(h,n.linewidth),this._init()),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",(()=>{t.add(this.pickObject3d)})),this.on("remove",(()=>{t.remove(this.pickObject3d)}))}_setMaterialRes(t,e){const n=t.getMap().getSize(),i=n.width,r=n.height;e.resolution.set(i,r)}_setPickObject3d(t,e){const n=new g;n.setPositions(t);const i=this.getLayer().getPick().getColor(),r=[];for(let e=0,n=t.length/3;e<n;e++)r.push(i.r,i.g,i.b);n.setColors(r);const o=new d({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),o);const s=i.getHex(),a=new p(n,o);a.position.copy(this.getObject3d().position),a._colorIndex=s,this.setPickObject3d(a)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof o.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}_workerLoad(t){const e=new Float32Array(t.position),n=this.getObject3d();if(n.geometry.setPositions(e),n.computeLineDistances(),this._setPickObject3d(e,n.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const xi={altitude:0,colors:null};class vi extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=[],s=[],a=t.length;for(let e=0;e<a;e++){const n=Oe(t[e]);o.push(n.center),s.push(n.lineStrings)}const c=ae(o);e=r.Util.extend({},xi,e,{layer:i,lineStrings:t,coordinate:c}),super(),this._initOptions(e);const{asynchronous:h}=e,l=new g,u=[],d={};let f,p,y=0,x=[],v=[],m=0,b=[];if(h)We.push({id:r.Util.GUID(),data:s,key:e.key,center:c,layer:i,baseObject:this,lineStrings:t});else{for(let t=0;t<a;t++){const e=s[t];let n=0;for(let t=0,r=e.length;t<r;t++){const r=G(e[t])?e[t].properties:e[t].getProperties()||{},{positions:o}=_e(e[t],i,c,!1);ce(o,r.bottomHeight,i,d),n+=o.length/3*2-2,b.push(Se(o))}const r=n;x[t]=[y,y+r],y+=r,v[t]={position:{count:n,start:m,end:m+3*n},instanceStart:{count:n,start:m,end:m+3*n},instanceEnd:{count:n,start:m,end:m+3*n},hide:!1},m+=3*n}f=Ae(b),l.setPositions(f)}this._setMaterialRes(i,n),this._createLine2(l,n);const{altitude:_}=e,w=i.distanceToVector3(_,_).x,M=i.coordinateToVector3(c,w);this.getObject3d().position.copy(M),this._faceMap=x,this._baseObjects=u,this._datas=t,this._geometriesAttributes=v,this.faceIndex=null,this.index=null,this._geometryCache=new g,h||(p=new Float32Array(f),this._geometryCache.setPositions(p)),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(u),h||(this._setPickObject3d(p,n.linewidth),this._init()),this.type="FatLines"}_setMaterialRes(t,e){const n=t.getMap().getSize(),i=n.width,r=n.height;e.resolution.set(i,r)}_setPickObject3d(t,e){const n=this._geometryCache||new g;n.setPositions(t);const i=this.getLayer().getPick(),{_geometriesAttributes:r}=this,o=he(r);let s=0;for(let t=0,e=r.length;t<e;t++){const e=i.getColor(),n=e.getHex();this._colorMap[n]=t;const{count:a}=r[t].position;this._datas[t].colorIndex=n;for(let t=0;t<a;t++)o[s]=e.r,o[s+1]=e.g,o[s+2]=e.b,s+=3}n.setColors(o);const a=new d({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),a);const h=i.getColor().getHex(),l=new p(n,a);l.position.copy(this.getObject3d().position),l._colorIndex=h,this.setPickObject3d(l)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof o.Material){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,i=e.height;t.resolution.set(n,i),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=r.Util.extend({},this.getOptions(),{index:t},G(e)?e.properties:e.getProperties());this._baseObjects[t]=new yi(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),i=this._geometryCache.attributes[e].array,r=i.length;for(let e=0;e<r;e++)t.array[e]=i[e];for(let i=0;i<n.length;i++){const r=n[i],{start:o,end:s}=this._geometriesAttributes[r][e];for(let e=o;e<s;e++)t.array[e]=-1e5}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:i}=t;if(i===e)return this;t.hide=e;const r=this.getObject3d().geometry;this._updateAttribute(r.attributes.instanceStart,"instanceStart"),this._updateAttribute(r.attributes.instanceEnd,"instanceEnd"),r.attributes.instanceStart.data.needsUpdate=!0,r.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}_workerLoad(t){const{faceMap:e,geometriesAttributes:n}=t;this._faceMap=e,this._geometriesAttributes=n;const i=this.getObject3d(),r=new Float32Array(t.position),o=new Float32Array(r);if(i.geometry.setPositions(new Float32Array(r)),this._geometryCache.setPositions(o),this._setPickObject3d(o,i.material.linewidth),this._init(),this.isAdd){this.getLayer().getPick().add(this.pickObject3d)}this._fire("workerload",{target:this})}}const mi={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61"};class bi extends v{constructor(t,e,n,i){e=r.Util.extend({},mi,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:o,radius:s,topColor:a,bottomColor:h,altitude:l}=e,u=i.distanceToVector3(o,o).x,d=i.distanceToVector3(s,s).x,f=z().clone();f.scale(2*d,2*d,u),a&&(P(f,h,a,"z",u/2),n.vertexColors=c()),this._createMesh(f,n);const g=i.distanceToVector3(l,l).x,p=i.coordinateToVector3(t,g);this.getObject3d().position.copy(p),this.type="Box"}}const _i={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"};class wi extends(vn(v)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const o=t.length,s=ae(t),a=i.coordinateToVector3(s),h=[],l=[],u=[],d=[];let f=0,g=0,p=0,y=0;const x={};for(let e=0;e<o;e++){const o=r.Util.extend({index:e},_i,t[e]),{radius:s,altitude:v,topColor:m,bottomColor:b,height:_,coordinate:w}=o,M=se(s,i,x),O=se(_,i,x),S=se(v,i,x),A=z().clone();A.scale(2*M,2*M,O),m&&(P(A,b,m,"z",O/2),n.vertexColors=c());const j=i.coordinateToVector3(w).sub(a),C=A.attributes.position.array;for(let t=0,e=C.length;t<e;t+=3)C[t+2]+=S,C[t]+=j.x,C[t+1]+=j.y,C[t+2]+=j.z;h.push(A);const T=new bi(w,o,n,i);l.push(T);const L=A.index.count/3;d[e]=[f+1,f+L],f+=L;const k=A.attributes.position.count,B=A.attributes.normal.count,E=A.attributes.uv.count;u[e]={position:{count:k,start:g,end:g+3*k},normal:{count:B,start:p,end:p+3*B},uv:{count:E,start:y,end:y+2*E},hide:!1},g+=3*k,p+=3*B,y+=2*E}super(),e=r.Util.extend({},{altitude:0,layer:i,points:t},e),this._initOptions(e);const v=B(h);this._createMesh(v,n);const m=e.altitude,b=i.distanceToVector3(m,m).x,_=a.clone();_.z=b,this.getObject3d().position.copy(_),this._faceMap=d,this._baseObjects=l,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=v.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(l),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}const Mi=Math.PI/180,Oi=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],Si=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Ai=new r.Coordinate(0,0),ji=new r.Point(0,0),Ci="__webglFramebuffer";class Ti extends r.CanvasLayer{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._baseObjects=[],this._delayMeshes=[],this.type="ThreeLayer"}isMercator(){const t=this.getMap();if(!t)return!1;const e=t.getSpatialReference(),n=e._projection,i=e._resolutions;return!!(n&&"EPSG:3857"===n.code&&i&&i.length&&156543===Math.floor(i[0])&&t.getGLRes)}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(t,e,n,i,r,o){this.renderScene(o,this)}drawOnInteracting(t,e,n,i,r,o,s){this.renderScene(s,this)}coordinateToVector3(t,e=0){const n=this.getMap();if(!n)return null;const i=Array.isArray(t);i?(Ai.x=t[0],Ai.y=t[1]):t instanceof r.Coordinate||(t=new r.Coordinate(t));const s=ki(n),a=Pi(n,i?Ai:t,s,ji);return new o.Vector3(a.x,a.y,e)}coordinatiesToGLFloatArray(t,e){const n=this.getMap();if(!n)return null;const i=ki(n),o=t.length,s=new Float32Array(2*o),a=new Float32Array(3*o);for(let c=0;c<o;c++){let o=t[c];const h=Array.isArray(o);h?(Ai.x=o[0],Ai.y=o[1]):o instanceof r.Coordinate||(o=new r.Coordinate(o));const l=Pi(n,h?Ai:o,i,ji);l.x-=e.x,l.y-=e.y;const u=2*c;s[u]=l.x,s[u+1]=l.y;const d=3*c;a[d]=l.x,a[d+1]=l.y,a[d+2]=0}return{positions:a,positons2d:s}}coordinatiesToGLArray(t,e){const n=this.getMap();if(!n)return null;const i=ki(n),o=t.length,s=new Array(o);for(let a=0;a<o;a++){let o=t[a];const c=Array.isArray(o);c?(Ai.x=o[0],Ai.y=o[1]):o instanceof r.Coordinate||(o=new r.Coordinate(o));const h=Pi(n,c?Ai:o,i,ji);h.x-=e.x,h.y-=e.y,s[a]=[h.x,h.y]}return s}distanceToVector3(t,e,n){if(0===t&&0===e||!r.Util.isNumber(t)||!r.Util.isNumber(e))return new o.Vector3(0,0,0);const i=this.getMap(),s=ki(i);let a=n||i.getCenter();a instanceof r.Coordinate||(a=new r.Coordinate(a));const c=i.locate(a,t,e),h=Pi(i,a,s),l=Pi(i,c,s),u=Math.abs(l.x-h.x)*r.Util.sign(t),d=Math.abs(l.y-h.y)*r.Util.sign(e);return new o.Vector3(u,d,0)}toShape(t){if(!t)return null;if(t instanceof r.MultiPolygon)return t.getGeometries().map((t=>this.toShape(t)));const e=t.getCenter(),n=this.coordinateToVector3(e),i=t.getShell().map((t=>{const e=this.coordinateToVector3(t).sub(n);return new o.Vector2(e.x,e.y)})),s=new o.Shape(i),a=t.getHoles();return a&&a.length>0&&(s.holes=a.map((t=>{const e=t.map((t=>{const e=this.coordinateToVector3(t).sub(n);return new o.Vector2(e.x,e.y)}));return new o.Shape(e)}))),s}toExtrudeMesh(t,e,n,i){if(!t)return null;if(t instanceof r.MultiPolygon)return t.getGeometries().map((t=>this.toExtrudeMesh(t,e,n,i)));const s=t.getCoordinates();s.forEach((t=>{for(let e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(s);const a=this.toShape(t),c=this.coordinateToVector3(t.getCenter());i=r.Util.isNumber(i)?i:e,i=this.distanceToVector3(i,i).x;const h=this.distanceToVector3(e,e).x,l={bevelEnabled:!1,bevelSize:1};l[parseInt(o.REVISION)>=93?"depth":"amount"]=i;const u=new o.ExtrudeGeometry(a,l);let d=u;o.BufferGeometry.prototype.fromGeometry&&(d=new o.BufferGeometry,d.fromGeometry(u));const f=new o.Mesh(d,n);return f.position.set(c.x,c.y,h-i),f}toExtrudePolygon(t,e,n){return new en(t,e,n,this)}toBar(t,e,n){return new V(t,e,n,this)}toLine(t,e,n){return new Xe(t,e,n,this)}toExtrudeLine(t,e,n){return new Ye(t,e,n,this)}toModel(t,e){return new rn(t,e,this)}toExtrudeLineTrail(t,e,n){return new pn(t,e,n,this)}toExtrudePolygons(t,e,n){return new _n(t,e,n,this)}toPoint(t,e,n){return new An(t,e,n,this)}toPoints(t,e,n){return new Pn(t,e,n,this)}toBars(t,e,n){return new zn(t,e,n,this)}toExtrudeLines(t,e,n){return new Vn(t,e,n,this)}toLines(t,e,n){return new In(t,e,n,this)}toThreeVectorTileLayer(t,e,n){return new Nn(t,e,n,this)}toTerrain(t,e,n){return new ei(t,e,n,this)}toTerrainVectorTileLayer(t,e,n){return new ii(t,e,n,this)}toHeatMap(t,e,n){return new ui(t,e,n,this)}toFatLine(t,e,n){return new yi(t,e,n,this)}toFatLines(t,e,n){return new vi(t,e,n,this)}toBox(t,e,n){return new bi(t,e,n,this)}toBoxs(t,e,n){return new wi(t,e,n,this)}getBaseObjects(){return this.getMeshes().filter((t=>t instanceof v))}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let n=0,i=t.children.length;n<i;n++){const i=t.children[n];i instanceof o.Object3D&&!(i instanceof o.Camera)&&e.push(i.__parent||i)}return e}clear(){return this.clearMesh()}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const n=t.children[e];if(n instanceof o.Object3D&&!(n instanceof o.Camera)){t.remove(n);const e=n.__parent;e&&e instanceof v&&(e.isAdd=!1,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[n.uuid])}}return this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(t,e){const n=this._getRenderer();return n&&(n.clearCanvas(),n.renderScene(t),e||n.setToRedraw()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const n=this.getMap();if(!n||n.isAnimating()||n.isInteracting())return;const i=this.options.loopRenderCount||50,r=e.slice(0,i);r&&this.addMesh(r,t),e.splice(0,i)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{t instanceof v?(n.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&r.Util.isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof o.Object3D&&n.add(t)})),this._zoomend(),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach((t=>{if(t instanceof v){n.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&r.Util.isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let n=0,i=e.length;n<i;n++)if(e[n]===t){e.splice(n,1);break}}else t instanceof o.Object3D&&n.remove(t)})),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}_initRaycaster(){return this._raycaster||(this._raycaster=new o.Raycaster,this._mouse=new o.Vector2),this}identify(t,e){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new r.Coordinate(t)),!(t instanceof r.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];const n=this.getMap().coordToContainerPoint(t);this._containerPoint=n;const{x:i,y:a}=n;this._initRaycaster();const c=this._raycaster,h=this._mouse,l=this.getCamera(),u=this.getScene(),d=this.getMap().getSize();if(!u)return[];const f=d.width,g=d.height;h.x=i/f*2-1,h.y=-a/g*2+1,c.setFromCamera(h,l),function(t,e){s>113?t.params.Line.threshold=e:t.linePrecision=e}(c,this._getLinePrecision(this.getMap().getResolution()));const p=[],y=[];u.children.forEach((t=>{const e=t.__parent;if(e&&e.getOptions){const n=e;n.getOptions().interactive&&n.isVisible()&&(n.identify&&r.Util.isFunction(n.identify)?y.push(n):p.push(t))}else(t instanceof o.Mesh||t instanceof o.Group)&&p.push(t)}));let x=[];const v=c.intersectObjects(p,!0);v&&Array.isArray(v)&&v.length&&(x=v.map((t=>{let e=t.object;e=this._recursionMesh(e)||{};const n=e.__parent||e;return n.faceIndex=t.faceIndex,n.index=t.index,n}))),this.renderPickScene(),y.length&&y.forEach((e=>{e.identify(t)&&x.push(e)}));const m=x.length;for(let t=0;t<m;t++)if(x[t])for(let e=t+1;e<m;e++)x[t]===x[e]&&x.splice(e,1);const b=(e=r.Util.extend({},e)).count;return r.Util.isNumber(b)&&b>0?x.slice(0,b):x}_recursionMesh(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,n=Oi.length;e<n;e++){const[n,i]=Oi[e];if(t>n)return i}return.01}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents)return this;const{type:n,coordinate:i}=t,o=r.Util.now();if(this._mousemoveTimeOut&&"mousemove"===n&&o-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=o,e.resetCursor("default");const s=this.options.identifyCountOnEvent;let a=Math.max(0,r.Util.isNumber(s)?s:0);0===a&&(a=1/0);const c=this.identify(i,{count:a}),h=this.getScene();if(0===c.length&&h)for(let e=0,n=h.children.length;e<n;e++){const n=(h.children[e]||{}).__parent;n&&n.fire("empty",Object.assign({},t,{target:n}))}if("mousemove"===n){c.length&&e.setCursor("pointer");const r=[];this._baseObjects&&this._baseObjects.forEach((t=>{let e=!0;c.forEach((n=>{t===n&&(e=!1)})),e&&r.push(t)})),r.forEach((e=>{e&&e instanceof v&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout"})),e.closeToolTip()))})),c.forEach((e=>{if(e instanceof v){e._mouseover||(e.fire("mouseover",Object.assign({},t,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(n,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));const r=e.getToolTip();r&&!r._owner&&r.addTo(e),e.openToolTip(i)}})),this._baseObjects=c}else c.forEach((e=>{if(e instanceof v&&(e.fire(n,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===n)){const t=e.getInfoWindow();t&&!t._owner&&t.addTo(e),e.openInfoWindow(i)}}));return this}_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach((t=>{const n=t.__parent;if(n&&n.getOptions){const t=n;t.zoomChange&&r.Util.isFunction(t.zoomChange)&&t.zoomChange(e);const i=t.getMinZoom(),o=t.getMaxZoom();e<i||e>o?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):i<=e&&e<=o&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}}))}onAdd(){super.onAdd();const t=this.map||this.getMap();return t?(Si.forEach((e=>{t.on(e,this._identifyBaseObjectEvents,this)})),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomend,this),this):this}onRemove(){super.onRemove();const t=this.map||this.getMap();return t?(Si.forEach((e=>{t.off(e,this._identifyBaseObjectEvents,this)})),t.off("zooming zoomend",this._zoomend,this),this):this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this}_getFovRatio(){const t=this.getMap().getFov();return Math.tan(t/2*Mi)}}Ti.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});class Li extends r.renderer.CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0,this._renderTarget=null}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new o.Matrix4;const t=new o.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new o.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new o.Scene,n=this.layer.getMap(),i=n.getFov()*Math.PI/180,r=this.camera=new o.PerspectiveCamera(i,n.width/n.height,n.cameraNear,n.cameraFar);r.matrixAutoUpdate=!1,this._syncCamera(),e.add(r),this.pick=new gi(this.layer),qe.star()}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,n=this.getMap();e=t||n.getSize();const i=n.getDevicePixelRatio?n.getDevicePixelRatio():r.Browser.retina?2:1,o=this.canvas;o.height=i*e.height,o.width=i*e.width,this.layer._canvas&&o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.context.setSize(o.width,o.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(t){const e=r.Util.now();if(e-this._renderTime>=16&&(this.layer._callbackBaseObjectAnimation(),this._renderTime=e),this._syncCamera(),t&&t.renderTarget){const{width:e,height:n}=t.renderTarget.fbo;this._renderTarget?(this._renderTarget.viewport.set(0,0,e,n),this._renderTarget.scissor.set(0,0,e,n)):(this._renderTarget=new o.WebGLRenderTarget(e,n,{depthBuffer:!1}),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));const i=this.context.properties.get(this._renderTarget),r=i[Ci];i[Ci]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera),i[Ci]=r}else this.context.render(this.scene,this.camera);this.context.setRenderTarget(null),this.completeRender()}remove(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements}_createGLContext(t,e){const n=["webgl2","webgl","experimental-webgl"];let i=null;for(let r=0;r<n.length;++r){try{i=t.getContext(n[r],e)}catch(t){}if(i)break}return i}}function ki(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function Pi(t,e,n,i){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,i):t.coordinateToPoint(e,n,i)}Ti.registerRenderer("gl",Li),r.registerWorkerAdapter&&r.registerWorkerAdapter("__maptalks.three__",'(function(e){"use strict";var t=r,n=r;function r(e,t,n){n=n||2;var r,v,h,u,l,x,c,d=t&&t.length,g=d?t[0]*n:e.length,y=i(e,0,g,n,!0),m=[];if(!y||y.next===y.prev)return m;if(d&&(y=function(e,t,n,r){var o,v,h,u=[];for(o=0,v=t.length;o<v;o++)(h=i(e,t[o]*r,o<v-1?t[o+1]*r:e.length,r,!1))===h.next&&(h.steiner=!0),u.push(p(h));for(u.sort(f),o=0;o<u.length;o++)s(u[o],n),n=a(n,n.next);return n}(e,t,y,n)),e.length>80*n){r=h=e[0],v=u=e[1];for(var M=n;M<g;M+=n)(l=e[M])<r&&(r=l),(x=e[M+1])<v&&(v=x),l>h&&(h=l),x>u&&(u=x);c=0!==(c=Math.max(h-r,u-v))?1/c:0}return o(y,m,n,r,v,c),m}function i(e,t,n,r,i){var a,o;if(i===R(e,t,n,r)>0)for(a=t;a<n;a+=r)o=A(a,e[a],e[a+1],o);else for(a=n-r;a>=t;a-=r)o=A(a,e[a],e[a+1],o);return o&&m(o,o.next)&&(z(o),o=o.next),o}function a(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!m(r,r.next)&&0!==y(r.prev,r,r.next))r=r.next;else{if(z(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function o(e,t,n,r,i,f,s){if(e){!s&&f&&function(e,t,n,r){var i=e;do{null===i.z&&(i.z=c(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,a,o,v,h,u=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,r=n,v=0,t=0;t<u&&(v++,r=r.nextZ);t++);for(h=u;v>0||h>0&&r;)0!==v&&(0===h||!r||n.z<=r.z)?(i=n,n=n.nextZ,v--):(i=r,r=r.nextZ,h--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;n=r}a.nextZ=null,u*=2}while(o>1)}(i)}(e,r,i,f);for(var x,p,d=e;e.prev!==e.next;)if(x=e.prev,p=e.next,f?h(e,r,i,f):v(e))t.push(x.i/n),t.push(e.i/n),t.push(p.i/n),z(e),e=p.next,d=p.next;else if((e=p)===d){s?1===s?o(e=u(a(e),t,n),t,n,r,i,f,2):2===s&&l(e,t,n,r,i,f):o(a(e),t,n,r,i,f,1);break}}}function v(e){var t=e.prev,n=e,r=e.next;if(y(t,n,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(d(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&y(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function h(e,t,n,r){var i=e.prev,a=e,o=e.next;if(y(i,a,o)>=0)return!1;for(var v=i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,h=i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,u=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,l=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,f=c(v,h,t,n,r),s=c(u,l,t,n,r),x=e.prevZ,p=e.nextZ;x&&x.z>=f&&p&&p.z<=s;){if(x!==e.prev&&x!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,x.x,x.y)&&y(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,p!==e.prev&&p!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;x&&x.z>=f;){if(x!==e.prev&&x!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,x.x,x.y)&&y(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;p&&p.z<=s;){if(p!==e.prev&&p!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function u(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!m(i,o)&&M(i,r,r.next,o)&&S(i,o)&&S(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),z(r),z(r.next),r=e=o),r=r.next}while(r!==e);return a(r)}function l(e,t,n,r,i,v){var h=e;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&g(h,u)){var l=Z(h,u);return h=a(h,h.next),l=a(l,l.next),o(h,t,n,r,i,v),void o(l,t,n,r,i,v)}u=u.next}h=h.next}while(h!==e)}function f(e,t){return e.x-t.x}function s(e,t){if(t=function(e,t){var n,r=t,i=e.x,a=e.y,o=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var v=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(v<=i&&v>o){if(o=v,v===i){if(a===r.y)return r;if(a===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===o)return n;var h,u=n,l=n.x,f=n.y,s=1/0;r=n;do{i>=r.x&&r.x>=l&&i!==r.x&&d(a<f?i:o,a,l,f,a<f?o:i,a,r.x,r.y)&&(h=Math.abs(a-r.y)/(i-r.x),S(r,e)&&(h<s||h===s&&(r.x>n.x||r.x===n.x&&x(n,r)))&&(n=r,s=h)),r=r.next}while(r!==u);return n}(e,t)){var n=Z(t,e);a(t,t.next),a(n,n.next)}}function x(e,t){return y(e.prev,e,t.prev)<0&&y(t.next,e,e.next)<0}function c(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function d(e,t,n,r,i,a,o,v){return(i-o)*(t-v)-(e-o)*(a-v)>=0&&(e-o)*(r-v)-(n-o)*(t-v)>=0&&(n-o)*(a-v)-(i-o)*(r-v)>=0}function g(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&M(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(S(e,t)&&S(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&n.next.y!==n.y&&i<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(y(e.prev,e,t.prev)||y(e,t.prev,t))||m(e,t)&&y(e.prev,e,e.next)>0&&y(t.prev,t,t.next)>0)}function y(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function m(e,t){return e.x===t.x&&e.y===t.y}function M(e,t,n,r){var i=w(y(e,t,n)),a=w(y(e,t,r)),o=w(y(n,r,e)),v=w(y(n,r,t));return i!==a&&o!==v||(!(0!==i||!b(e,n,t))||(!(0!==a||!b(e,r,t))||(!(0!==o||!b(n,e,r))||!(0!==v||!b(n,t,r)))))}function b(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function w(e){return e>0?1:e<0?-1:0}function S(e,t){return y(e.prev,e,e.next)<0?y(e,t,e.next)>=0&&y(e,e.prev,t)>=0:y(e,t,e.prev)<0||y(e,e.next,t)<0}function Z(e,t){var n=new F(e.i,e.x,e.y),r=new F(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,a.next=r,r.prev=a,r}function A(e,t,n,r){var i=new F(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function z(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function F(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(e,t,n,r){for(var i=0,a=t,o=n-r;a<n;a+=r)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}function q(e,t,n){var r=t[0],i=t[1],a=n[0]-r,o=n[1]-i;if(0!==a||0!==o){var v=((e[0]-r)*a+(e[1]-i)*o)/(a*a+o*o);v>1?(r=n[0],i=n[1]):v>0&&(r+=a*v,i+=o*v)}return(a=e[0]-r)*a+(o=e[1]-i)*o}function P(e,t,n,r,i){for(var a,o=r,v=t+1;v<n;v++){var h=q(e[v],e[t],e[n]);h>o&&(a=v,o=h)}o>r&&(a-t>1&&P(e,t,a,r,i),i.push(e[a]),n-a>1&&P(e,a,n,r,i))}function L(e,t){var n=e.length-1,r=[e[0]];return P(e,0,n,t,r),r.push(e[n]),r}function V(e,t,n){if(e.length<=2)return e;var r=void 0!==t?t*t:1;return e=L(e=n?e:function(e,t){for(var n,r,i,a,o,v=e[0],h=[v],u=1,l=e.length;u<l;u++)n=e[u],i=v,a=void 0,o=void 0,a=(r=n)[0]-i[0],o=r[1]-i[1],a*a+o*o>t&&(h.push(n),v=n);return v!==n&&h.push(n),h}(e,r),r)}function B(e,t){return e[0]*t[0]+e[1]*t[1]}function E(e,t){var n=t[0],r=t[1],i=Math.sqrt(n*n+r*r);return e[0]=n/i,e[1]=r/i,e}function U(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function H(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function I(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function O(e,t){var n=t[0],r=t[1],i=t[2],a=Math.sqrt(n*n+r*r+i*i);return e[0]=n/a,e[1]=r/a,e[2]=i/a,e}function T(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],v=n[1],h=n[2];return e[0]=i*h-a*v,e[1]=a*o-r*h,e[2]=r*v-i*o,e}r.deviation=function(e,t,n,r){var i=t&&t.length,a=i?t[0]*n:e.length,o=Math.abs(R(e,0,a,n));if(i)for(var v=0,h=t.length;v<h;v++){var u=t[v]*n,l=v<h-1?t[v+1]*n:e.length;o-=Math.abs(R(e,u,l,n))}var f=0;for(v=0;v<r.length;v+=3){var s=r[v]*n,x=r[v+1]*n,c=r[v+2]*n;f+=Math.abs((e[s]-e[c])*(e[x+1]-e[s+1])-(e[s]-e[x])*(e[c+1]-e[s+1]))}return 0===o&&0===f?0:Math.abs((f-o)/o)},r.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var a=0;a<e[i].length;a++)for(var o=0;o<t;o++)n.vertices.push(e[i][a][o]);i>0&&(r+=e[i-1].length,n.holes.push(r))}return n},t.default=n;var W=[];function j(e,t,n,r){var i=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(t,n),a=Math.acos(i)*r;return U(W,n,t,-i),function(e,t){var n=t[0],r=t[1],i=t[2],a=Math.sqrt(n*n+r*r+i*i);e[0]=n/a,e[1]=r/a,e[2]=i/a}(W,W),function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n}(e,t,Math.cos(a)),U(e,e,W,Math.sin(a)),e}function k(e,t,n,r,i,a,o,v,h,u){var l=o-i,f=v-a,s=(l*(t-a)-f*(e-i))/(f*(n-e)-l*(r-t));return h&&(h[u=u||0]=e+s*(n-e),h[u+1]=t+s*(r-t)),s}function _(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),a=2*t;a<2*n;){var o=e[i],v=e[i+1],h=e[a],u=e[a+1];i=a,a+=2,r+=o*u-h*v}return r}function D(e,n,r){return void 0===r&&(r=2),t(e,n,r)}var C=[],G=[],J=[];function K(e,t,n,r,i,a,o,v,h){var u,l,f,s=null!=o,x=i,c=null;s&&(c=new Uint32Array(r-n));for(var p=[],d=n;d<r;d++){var g=d===r-1?n:d+1,y=d===n?r-1:d-1,m=e[2*y],M=e[2*y+1],b=e[2*d],w=e[2*d+1],S=e[2*g],Z=e[2*g+1];C[0]=b-m,C[1]=w-M,G[0]=S-b,G[1]=Z-w,E(C,C),E(G,G),s&&(c[d]=x);var A=!1,z=void 0,F=void 0;if(v||d!==n)if(v||d!==r-1){H(J,G,C);var R=J[1];J[1]=-J[0],J[0]=R,E(J,J);var q=B(J,G),P=Math.sqrt(1-q*q),L=a*Math.min(10,1/P);if(s&&1/P>o&&a*q<0){var V=b+J[0]*a,U=w+J[1]*a,I=Math.acos(P)/2,O=Math.tan(I)*Math.abs(a);t[2*x]=V+J[1]*O,t[2*x+1]=U-J[0]*O,t[2*++x]=V-J[1]*O,t[2*x+1]=U+J[0]*O,x++}else z=b+J[0]*L,F=w+J[1]*L,A=!0;if(A){if(h&&null!=u){var T=k(m,M,u,l,b,w,z,F,p,0);T>=-.01&&T<=1.01&&(t[2*f]=z=p[0],t[2*f+1]=F=p[1])}u=t[2*x]=z,l=t[2*x+1]=F,f=x,x++}}else J[0]=C[1],J[1]=-C[0],E(J,J),z=b+J[0]*a,F=w+J[1]*a,A=!0;else J[0]=G[1],J[1]=-G[0],E(J,J),u=t[2*x]=b+J[0]*a,l=t[2*x+1]=w+J[1]*a,f=x,x++}return c}function N(e,t,n,r,i,a,o,v){var h=null!=o,u=i,l=null;h&&(l=new Uint32Array(r-n));for(var f=n;f<r;f++){var s=f===r-1?n:f+1,x=f===n?r-1:f-1,c=e[2*x],p=e[2*x+1],d=e[2*f],g=e[2*f+1],y=e[2*s],m=e[2*s+1];if(C[0]=d-c,C[1]=g-p,G[0]=y-d,G[1]=m-g,E(C,C),E(G,G),h&&(l[f]=u),v||f!==n)if(v||f!==r-1){H(J,G,C);var M=J[1];J[1]=-J[0],J[0]=M,E(J,J);var b=B(J,G),w=Math.sqrt(1-b*b),S=a*Math.min(10,1/w);if(h&&1/w>o&&a*b<0){var Z=d+J[0]*a,A=g+J[1]*a,z=Math.acos(w)/2,F=Math.tan(z)*Math.abs(a);t[2*u]=Z+J[1]*F,t[2*u+1]=A-J[0]*F,t[2*++u]=Z-J[1]*F,t[2*u+1]=A+J[0]*F,u++}else t[2*u]=d+J[0]*S,t[2*u+1]=g+J[1]*S,u++}else J[0]=C[1],J[1]=-C[0],E(J,J),t[2*u]=d+J[0]*a,t[2*u+1]=g+J[1]*a,u++;else J[0]=G[1],J[1]=-G[0],E(J,J),t[2*u]=d+J[0]*a,t[2*u+1]=g+J[1]*a,u++}return l}function Q(e,t,n,r,i){var a=null!=r?[]:new Float32Array(e.length);if(K(e,a,0,t&&t.length?t[0]:e.length/2,0,n,r,i,!0),t)for(var o=0;o<t.length;o++){var v=t[o];K(e,a,v,t[o+1]||e.length/2,null!=r?a.length/2:v,n,r,i,!1)}return a}function X(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var a=0;a<t;a++){var o=(i+n)*t+a,v=(r-i-1)*t+a,h=e[o];e[o]=e[v],e[v]=h}return e}function Y(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;_(e,r,i)>0&&X(e,2,r,i);for(var a=1;a<(t?t.length:0)+1;a++)_(e,r=t[a-1],i=t[a]||n)<0&&X(e,2,r,i)}function $(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,null==e.smoothSide&&(e.smoothSide="auto"),null==e.smoothSideThreshold&&(e.smoothSideThreshold=.9),"number"==typeof e.depth&&(e.bevelSize=Math.min(e.bevelSegments>0?e.bevelSize:0,e.depth/2)),e.bevelSize>0||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t=e.boundingRect;if(e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect){var n=null==e.fitRect.x?t.x||0:e.fitRect.x,r=null==e.fitRect.y?t.y||0:e.fitRect.y,i=e.fitRect.width,a=e.fitRect.height;null==i?null!=a?i=a/t.height*t.width:(i=t.width,a=t.height):null==a&&(a=i/t.width*t.height),e.scale=[i/t.width,a/t.height],e.translate=[(n-t.x)*e.scale[0],(r-t.y)*e.scale[1]]}}var ee=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function te(e,t,n){for(var r=0,i=e[t],a=e[t+1],o=i,v=a,h=t+2;h<n;h+=2){var u=e[h],l=e[h+1];r+=Math.sqrt((u-i)*(u-i)+(l-a)*(l-a)),i=u,a=l}return r+=Math.sqrt((i-o)*(i-o)+(a-v)*(a-v))}function ne(e,t,n,r,i,a){var o=t.vertices,v=t.topVertices,h=t.splittedMap,u=t.depth,l=t.rect,f=r-n,s=a.smoothBevel?1:2,x=Math.min(u/2,a.bevelSize),c=a.bevelSegments,p=i.vertex,d=i.ringPerimeter,g=Math.max(l.width,l.height,u,d);function y(e){var t=(e+1)%f,n=o[2*e],r=o[2*e+1],i=o[2*t],a=o[2*t+1];return n===i&&r===a}if(x>0)for(var m=[0,0,1],M=[],b=[0,0,-1],w=[],S=0,Z=new Float32Array(f),A=0;A<2;A++)for(var z=0===A?u-x:x,F=0;F<=c*s;F++){for(var R=0,q=void 0,P=void 0,L=0;L<f;L++){var V=2*(L%f+n),B=h?2*h[V/2]:V;M[0]=o[V]-v[B],M[1]=o[V+1]-v[B+1],M[2]=0;var E=Math.sqrt(M[0]*M[0]+M[1]*M[1]);M[0]/=E,M[1]/=E;var U=(Math.floor(F/s)+F%s)/c;0===A?j(w,m,M,U):j(w,M,b,U);var H=0===A?U:1-U,I=x*Math.sin(H*Math.PI/2),O=E*Math.cos(H*Math.PI/2),T=x*E/Math.sqrt(I*I+O*O),W=w[0]*T+v[B],k=w[1]*T+v[B+1],_=w[2]*T+z;if(e.position[3*i.vertex]=W,e.position[3*i.vertex+1]=k,e.position[3*i.vertex+2]=_,L>0&&(R+=Math.sqrt((q-W)*(q-W)+(P-k)*(P-k))),F>0||A>0){var D=3*(i.vertex-f),C=e.position[D],G=e.position[D+1],J=e.position[D+2];Z[L]+=Math.sqrt((C-W)*(C-W)+(G-k)*(G-k)+(J-_)*(J-_))}if(e.uv[2*i.vertex]=R/g,e.uv[2*i.vertex+1]=Z[L]/g,q=W,P=k,i.vertex++,!y(L)&&(s>1&&F%s||1===s&&F>=1))for(var K=0;K<6;K++){var N=(ee[K][0]+L)%f,Q=ee[K][1]+S;e.indices[i.index++]=(Q-1)*f+N+p}}S++}else for(var X=0;X<2;X++)for(var Y=0===X?u-x:x,$=0,te=void 0,ne=void 0,re=0;re<f;re++){var ie=2*(re%f+n),ae=o[ie],oe=o[ie+1];e.position[3*i.vertex]=ae,e.position[3*i.vertex+1]=oe,e.position[3*i.vertex+2]=Y,re>0&&($+=Math.sqrt((te-ae)*(te-ae)+(ne-oe)*(ne-oe))),e.uv[2*i.vertex]=$/g,e.uv[2*i.vertex+1]=Y/g,te=ae,ne=oe,i.vertex++}for(var ve=x>0?c*s+1:1,he=0;he<f;he++)if(!y(he))for(var ue=0;ue<6;ue++){var le=(ee[ue][0]+he)%f,fe=ee[ue][1]+ve;e.indices[i.index++]=(fe-1)*f+le+p}}function re(e,t,n,r){var i=e.indices,a=e.topVertices,o=e.rect,v=e.depth;if(!(a.length<=4)){for(var h=n.vertex,u=i.length,l=0;l<u;l++)t.indices[n.index++]=h+i[l];for(var f=Math.max(o.width,o.height),s=0;s<(r.excludeBottom?1:2);s++)for(var x=0;x<a.length;x+=2){var c=a[x],p=a[x+1];t.position[3*n.vertex]=c,t.position[3*n.vertex+1]=p,t.position[3*n.vertex+2]=(1-s)*v,t.uv[2*n.vertex]=(c-o.x)/f,t.uv[2*n.vertex+1]=(p-o.y)/f,n.vertex++}if(!r.excludeBottom)for(var d=a.length/2,g=0;g<u;g+=3)for(var y=0;y<3;y++)t.indices[n.index++]=h+d+i[g+2-y]}}function ie(e,t,n,r){var i=null==n||"auto"===n;if(!0===n)return{vertices:e,holes:t};for(var a=[],o=t&&[],v=e.length/2,h=[],u=[],l=[],f=0,s=0,x=(t?t.length:0)+1,c=0;c<x;c++){0===c?s=t&&t.length?t[0]:v:(f=t[c-1],s=t[c]||v);for(var p=f;p<s;p++){var d=e[2*p],g=e[2*p+1],y=p===s-1?f:p+1,m=e[2*y],M=e[2*y+1];if(i){var b=p===f?s-1:p-1,w=e[2*b],S=e[2*b+1];h[0]=w-d,h[1]=S-g,u[0]=m-d,u[1]=M-g,E(h,h),E(u,u),1-(.5*B(h,u)+.5)>r?(a.push(d,g),l.push(p)):(a.push(d,g,d,g),l.push(p,p))}else a.push(d,g,d,g),l.push(p,p)}c<x-1&&o&&o.push(a.length/2)}return{vertices:new Float32Array(a),splittedMap:l,holes:o}}function ae(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var a=e[i],o=a.indices,v=a.vertices,h=a.splittedMap,u=a.topVertices,l=a.depth,f=Math.min(l/2,t.bevelSize)>0?t.bevelSegments:0,s=e[i].holes||[];n+=o.length*(t.excludeBottom?1:2),r+=u.length/2*(t.excludeBottom?1:2);for(var x=2+2*f,c=0,p=0,d=0;d<s.length+1;d++){0===d?p=s.length?s[0]:v.length/2:(c=s[d-1],p=s[d]||v.length/2),n+=6*((h?h[p-1]+1:p)-(h?h[c]:c))*(x-1);var g=p-c;r+=g*x+(t.smoothBevel?0:f*g*2)}}for(var y={position:new Float32Array(3*r),indices:new(r>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},m={vertex:0,index:0,ringPerimeter:0},M=0;M<e.length;M++)re(e[M],y,m,t);for(var b=0;b<e.length;b++){var w=e[b],S=w.holes,Z=w.vertices.length/2,A=0,z=S&&S.length?S[0]:Z;if(m.ringPerimeter=te(e[b].topVertices,A,z),ne(y,e[b],A,z,m,t),S)for(var F=0;F<S.length;F++)A=S[F],z=S[F+1]||Z,m.ringPerimeter=te(e[b].topVertices,A,z),ne(y,e[b],A,z,m,t)}for(var R=0;R<y.uv.length;R++){var q=y.uv[R];q>0&&Math.round(q)===q?y.uv[R]=1:y.uv[R]=q%1}return y.normal=function(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r=[],i=[],a=[],o=[],v=[],h=[],u=e.length,l=new Float32Array(t.length),f=0;f<u;){var s=3*e[f++],x=3*e[f++],c=3*e[f++];n(r,t[s],t[s+1],t[s+2]),n(i,t[x],t[x+1],t[x+2]),n(a,t[c],t[c+1],t[c+2]),I(o,r,i),I(v,i,a),T(h,o,v);for(var p=0;p<3;p++)l[s+p]=l[s+p]+h[p],l[x+p]=l[x+p]+h[p],l[c+p]=l[c+p]+h[p]}for(var d=0;d<l.length;)n(h,l[d],l[d+1],l[d+2]),O(h,h),l[d++]=h[0],l[d++]=h[1],l[d++]=h[2];return l}(y.indices,y.position),y.boundingRect=e[0]&&e[0].rect,y}function oe(e,t,n){for(var r=n.lineWidth,i=e.length,a=new Float32Array(2*i),o=n.translate||[0,0],v=n.scale||[1,1],h=0,u=0;h<i;h++)a[u++]=e[h][0]*v[0]+o[0],a[u++]=e[h][1]*v[1]+o[1];_(a,0,i)<0&&X(a,2,0,i);var l=[],f=[],s=n.miterLimit,x=N(a,f,0,i,0,-r/2,s,!1);X(a,2,0,i);for(var c=N(a,l,0,i,0,-r/2,s,!1),p=(l.length+f.length)/2,d=new Float32Array(2*p),g=0,y=f.length/2,m=0;m<f.length;m++)d[g++]=f[m];for(var M=0;M<l.length;M++)d[g++]=l[M];for(var b=new(p>65535?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i))),w=0,S=0;S<i-1;S++){var Z=S+1;b[w++]=y-1-x[S],b[w++]=y-1-x[S]-1,b[w++]=c[S]+1+y,b[w++]=y-1-x[S],b[w++]=c[S]+1+y,b[w++]=c[S]+y,c[Z]-c[S]==2?(b[w++]=c[S]+2+y,b[w++]=c[S]+1+y,b[w++]=y-x[Z]-1):x[Z]-x[S]==2&&(b[w++]=c[Z]+y,b[w++]=y-1-(x[S]+1),b[w++]=y-1-(x[S]+2))}var A=n.bevelSize>0?Q(d,[],n.bevelSize,null,!0):d,z=n.boundingRect,F=ie(d,null,n.smoothSide,n.smoothSideThreshold);return{vertices:F.vertices,rawVertices:A,splittedMap:F.splittedMap,indices:b,topVertices:A,rect:{x:z.x*v[0]+o[0],y:z.y*v[1]+o[1],width:z.width*v[0],height:z.height*v[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}function ve(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],a=[],o=i.length,v=i[o-1][0],h=i[o-1][1],u=0,l=0;l<o;l++){var f=i[l][0],s=i[l][1],x=f-v,c=s-h;(u+=Math.sqrt(x*x+c*c))>t&&(a.push(i[l]),u=0),v=f,h=s}a.length>=3&&n.push(a)}return n.length>0?n:null}function he(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];(i=V(i,t,!0)).length>=3&&n.push(i)}return n.length>0?n:null}function ue(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}var le={x:0,y:0},fe={x:0,y:0};function se(e,t,n,r){for(var i=e.length,a=0;a<i;a++){var o=e[a].data;t=e[a].center||t;for(var v=0,h=o.length;v<h;v++)for(var u=o[v],l=0,f=u.length;l<f;l++)e[a].data[v][l]=xe(u[l],t,n,r)}}function xe(e,t,n,r){for(var i,a=[],o=0,v=(i=n?new Float64Array(e):new Float32Array(e)).length;o<v;o+=2){var h=i[o],u=i[o+1];if(t&&n&&r){le.x=h,le.y=u;var l=be(le,fe);le.x=l.x,le.y=l.y,h=(l=we(r,le,n,fe)).x,u=l.y,h-=t[0],u-=t[1]}a.push([h,u])}return a}function ce(e,t){void 0===t&&(t=!1);for(var n=e.length,r=[],i=[],a=[],o=0,v=0,h=0,u=0,l=0;l<n;l++){var f=t?de(e[l]):pe(e[l]),s=e[l].bottomHeight||0,x=f.position,c=f.normal,p=f.uv,d=f.indices;i.push(f);var g=d.length/3;a[l]=[o+1,o+g],o+=g;var y=x.length/3,m=c.length/3,M=p.length/2;r[l]={position:{middleZ:s+(e[l].height||0)/2,count:y,start:v,end:v+3*y},normal:{count:m,start:h,end:h+3*m},uv:{count:M,start:u,end:u+2*M},hide:!1},v+=3*y,h+=3*m,u+=2*M}var b=function(e){for(var t={},n={},r=0;r<e.length;++r){var i=e[r];for(var a in i)void 0===t[a]&&(t[a]=[],n[a]=0),t[a].push(i[a]),n[a]+=i[a].length}var o={},v=0,h=[];for(var u in t)if("indices"===u)for(var l=t[u],f=0,s=l.length;f<s;f++){for(var x=l[f],c=0,p=x.length;c<p;c++)h.push(x[c]+v);v+=t.position[f].length/3}else{var d=ge(t[u],n[u]);if(!d)return null;o[u]=d}return o.indices=new Uint32Array(h),o}(i),w=b.position,S=b.normal,Z=b.uv,A=b.indices;return{position:w.buffer,normal:S.buffer,uv:Z.buffer,indices:A.buffer,faceMap:a,geometriesAttributes:r}}function pe(e){var n=e.data,r=e.height,i=e.bottomHeight,a=function(e,n){n=Object.assign({},n);for(var r=[1/0,1/0],i=[-1/0,-1/0],a=0;a<e.length;a++)ue(e[a][0],r,i);n.boundingRect=n.boundingRect||{x:r[0],y:r[1],width:i[0]-r[0],height:i[1]-r[1]},$(n);for(var o=[],v=n.translate||[0,0],h=n.scale||[1,1],u=n.boundingRect,l={x:u.x*h[0]+v[0],y:u.y*h[1]+v[1],width:u.width*h[0],height:u.height*h[1]},f=Math.min(u.width,u.height)/1e5,s=0;s<e.length;s++){var x=ve(e[s],f);if(x){var c=n.simplify/Math.max(h[0],h[1]);if(c>0&&(x=he(x,c)),x){for(var p=t.flatten(x),d=p.vertices,g=p.holes,y=p.dimensions,m=0;m<d.length;)d[m]=d[m++]*h[0]+v[0],d[m]=d[m++]*h[1]+v[1];if(Y(d,g),2!==y)throw new Error("Only 2D polygon points are supported");var M=n.bevelSize>0?Q(d,g,n.bevelSize,null,!0):d,b=D(M,g,y),w=ie(d,g,n.smoothSide,n.smoothSideThreshold);o.push({indices:b,vertices:w.vertices,rawVertices:d,topVertices:M,holes:w.holes,splittedMap:w.splittedMap,rect:l,depth:"function"==typeof n.depth?n.depth(s):n.depth})}}}return ae(o,n)}(n,{depth:r}),o=a.position,v=a.normal,h=a.uv,u=a.indices;return ye(o,i),{position:o,normal:v,uv:h,indices:u}}function de(e){var t=e.data,n=e.height,r=e.width,i=e.bottomHeight,a=function(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)ue(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},$(t);var a=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var o=[],v=0;v<e.length;v++){var h=e[v],u=t.simplify/Math.max(a[0],a[1]);u>0&&(h=V(h,u,!0)),o.push(oe(h,v,t))}return ae(o,t)}(t,{lineWidth:r,depth:n}),o=a.position,v=a.normal,h=a.uv,u=a.indices;return ye(o,i),{position:o,normal:v,uv:h,indices:u}}function ge(e,t){for(var n=new Float32Array(t),r=0,i=0;i<e.length;++i)n.set(e[i],r),r+=e[i].length;return n}function ye(e,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var n=0,r=e.length;n<r;n+=3)e[n+2]+=t}var me=Math.PI/180,Me=6378137*Math.PI/180;function be(e,t){var n,r=85.0511287798,i=e.x,a=Math.max(Math.min(r,e.y),-r);n=0===a?0:Math.log(Math.tan((90+a)*me/2))/me;var o=i*Me,v=n*Me;return t?(t.x=o,t.y=v,t):{x:o,y:v}}function we(e,t,n,r){var i=e[0]*(t.x-e[2])/n,a=-e[1]*(t.y-e[3])/n;return r?(r.x=i,r.y=a,r):{x:i,y:a}}function Se(e){void 0===e&&(e=[]);for(var t=e.length,n=new Float32Array(3*t),r=0;r<t;r++){var i=e[r],a=3*r;n[a]=i[0],n[a+1]=i[1]}return n}function Ze(e){for(var t=new Float32Array(2*e.length-6),n=0,r=0,i=e.length/3;r<i;r++){var a=e[3*r],o=e[3*r+1],v=e[3*r+2];if(r>0&&r<i-1){var h=3*n;t[h]=a,t[h+1]=o,t[h+2]=v,n++}var u=3*n;t[u]=a,t[u+1]=o,t[u+2]=v,n++}return t}function Ae(e){var t=0,n=e.length;if(1===n)return e[0];for(var r=0;r<n;r++)t+=e[r].length;for(var i=new Float32Array(t),a=0,o=0;o<n;o++)i.set(e[o],a),a+=e[o].length;return i}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,r=n.type,i=n.datas,a=n.glRes,o=n.matrix,v=n.center;if("ExtrudePolygons"===r){se(i,v,a,o);var h=ce(i);t(null,h,[h.position,h.normal,h.uv,h.indices])}else if("ExtrudeLines"===r){for(var u=0,l=i.length;u<l;u++)for(var f=0,s=i[u].data.length;f<s;f++)i[u].data[f]=xe(i[u].data[f],i[u].center||v,a,o);var x=ce(i,!0);t(null,x,[x.position,x.normal,x.uv,x.indices])}else if("ExtrudePolygon"===r){var c=[],p=[];i.forEach((function(e){var t=[e];se(t,v,a,o);var n=ce(t),r=n.position,i=n.normal,h=n.uv,u=n.indices;c.push({id:e.id,position:r,normal:i,uv:h,indices:u}),p.push(r,i,h,u)})),t(null,c,p)}else if("Line"===r||"FatLine"===r){for(var d=[],g=[],y=0,m=i.length;y<m;y++){for(var M=[],b=0,w=i[y].data.length;b<w;b++){i[y].data[b]=xe(i[y].data[b],i[y].center||v,a,o);var S=Se(i[y].data[b]);M.push(Ze(S))}var Z=Ae(M);ye(Z,i[y].bottomHeight),d.push({id:i[y].id,position:Z.buffer}),g.push(Z.buffer)}t(null,d,g)}else if("Lines"===r||"FatLines"===r){for(var A=0,z=[],F=[],R=0,q=[],P=0,L=i.length;P<L;P++){for(var V=0,B=0,E=i[P].data.length;B<E;B++){i[P].data[B]=xe(i[P].data[B],i[P].center||v,a,o);var U=Se(i[P].data[B]);ye(U,i[P].bottomHeight),V+=U.length/3*2-2,q.push(Ze(U))}var H=V;z[P]=[A,A+H],A+=H,F[P]={position:{count:V,start:R,end:R+3*V},hide:!1},"FatLines"===r&&(F[P].instanceStart={count:V,start:R,end:R+3*V},F[P].instanceEnd={count:V,start:R,end:R+3*V}),R+=3*V}var I=Ae(q);t(null,{id:i.id,position:I.buffer,geometriesAttributes:F,faceMap:z},[I.buffer])}else if("ExtrudeLine"===r){for(var O=0,T=i.length;O<T;O++)for(var W=0,j=i[O].data.length;W<j;W++)i[O].data[W]=xe(i[O].data[W],i[O].center||v,a,o);var k=[],_=[];i.forEach((function(e){var t=ce([e],!0),n=t.position,r=t.normal,i=t.uv,a=t.indices;k.push({id:e.id,position:n,normal:r,uv:i,indices:a}),_.push(n,r,i,a)})),t(null,k,_)}},Object.defineProperty(e,"__esModule",{value:!0})})'),t.BaseObject=v,t.ExtrudeUtil=be,t.GeoJSONUtil=W,t.GeoUtil=un,t.IdentifyUtil=Mn,t.LineMaterial=d,t.LineUtil=Le,t.MergeGeometryUtil=A,t.MergedMixin=vn,t.ThreeLayer=Ti,t.ThreeRenderer=Li,t.geometryExtrude=oe,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.20.0")}));
