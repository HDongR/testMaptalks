/*!
 * maptalks.three v0.20.0
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("three")):"function"==typeof define&&define.amd?define(["exports","maptalks","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).maptalks=t.maptalks||{},t.maptalks,t.THREE)}(this,(function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var i=r(e),o=r(n);function a(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,s(t,e)}function s(t,e){return(s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var c=parseInt(o.REVISION.replace("dev",""));function l(t,e,n){return c>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function h(){return!o.VertexColors||o.VertexColors}console.log("maptalks.three log: current three.js version is %c"+c,"color:red;font-size: 16px;font-weight: bold;");var f=function(t){function e(){var e;(e=t.call(this)||this).isLineSegmentsGeometry=!0,e.type="LineSegmentsGeometry";return e.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),l(u(e),"position",new o.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),l(u(e),"uv",new o.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2)),e}a(e,t);var n=e.prototype;return n.applyMatrix=function(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},n.setPositions=function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new o.InstancedInterleavedBuffer(e,6,1);return l(this,"instanceStart",new o.InterleavedBufferAttribute(n,3,0)),l(this,"instanceEnd",new o.InterleavedBufferAttribute(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},n.setColors=function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new o.InstancedInterleavedBuffer(e,6,1);return l(this,"instanceColorStart",new o.InterleavedBufferAttribute(n,3,0)),l(this,"instanceColorEnd",new o.InterleavedBufferAttribute(n,3,3)),this},n.fromWireframeGeometry=function(t){return this.setPositions(t.attributes.position.array),this},n.fromEdgesGeometry=function(t){return this.setPositions(t.attributes.position.array),this},n.fromMesh=function(t){return this.fromWireframeGeometry(new o.WireframeGeometry(t.geometry)),this},n.fromLineSegements=function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},n.computeBoundingBox=function(){var t=new o.Box3;null===this.boundingBox&&(this.boundingBox=new o.Box3);var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(n),this.boundingBox.union(t))},n.computeBoundingSphere=function(){var t=new o.Vector3;null===this.boundingSphere&&(this.boundingSphere=new o.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var r=this.boundingSphere.center;this.boundingBox.getCenter(r);for(var i=0,a=0,s=e.count;a<s;a++)t.fromBufferAttribute(e,a),i=Math.max(i,r.distanceToSquared(t)),t.fromBufferAttribute(n,a),i=Math.max(i,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}},n.toJSON=function(){},n.copy=function(t){return this},e}(o.InstancedBufferGeometry),d={},v={};d.line={linewidth:{value:1},resolution:{value:new o.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},v.line={uniforms:o.UniformsUtils.merge([o.UniformsLib.common,o.UniformsLib.fog,d.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};var p=function(t){function e(e){var n;return(n=t.call(this,{uniforms:o.UniformsUtils.clone(v.line.uniforms),vertexShader:v.line.vertexShader,fragmentShader:v.line.fragmentShader})||this).dashed=!0,n.isLineMaterial=!0,n.type="LineMaterial",Object.defineProperties(u(n),{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),n.setValues(e),n}return a(e,t),e}(o.ShaderMaterial),g=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).isLineSegments2=!0,r.type="LineSegments2",r.geometry=void 0!==e?e:new f,r.material=void 0!==n?n:new p({color:16777215*Math.random()}),r}return a(e,t),e.prototype.computeLineDistances=function(){var t=new o.Vector3,e=new o.Vector3,n=this.geometry,r=n.attributes.instanceStart,i=n.attributes.instanceEnd;if(!r||!i)return this;for(var a=new Float32Array(2*r.data.count),s=0,u=0,c=r.data.count;s<c;s++,u+=2)t.fromBufferAttribute(r,s),e.fromBufferAttribute(i,s),a[u]=0===u?0:a[u-1],a[u+1]=a[u]+t.distanceTo(e);var h=new o.InstancedInterleavedBuffer(a,2,1);return l(n,"instanceDistanceStart",new o.InterleavedBufferAttribute(h,1,0)),l(n,"instanceDistanceEnd",new o.InterleavedBufferAttribute(h,1,1)),this},e}(o.Mesh),y=function(t){function e(){var e;return(e=t.call(this)||this).isLineGeometry=!0,e.type="LineGeometry",e}return a(e,t),e.prototype.fromLine=function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},e}(f),x=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).isLine2=!0,r.type="Line2",r.geometry=void 0!==e?e:new y,r.material=void 0!==n?n:new p({color:16777215*Math.random()}),r}return a(e,t),e.prototype.copy=function(t){return this},e}(g),m={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1};var b,_=function(t){function e(e){var n;return(n=t.call(this)||this).isAdd=!1,n._mouseover=!1,n._visible=!0,n._zoomVisible=!0,n.picked=!1,n.isBaseObject=!0,void 0===e&&(e=i.Util.GUID()),n.id=e,n}a(e,t);var n=e.prototype;return n.addTo=function(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this},n.remove=function(){var t=this.getLayer();return t&&t.removeMesh([this]),this},n.getObject3d=function(){return this.object3d},n.getId=function(){return this.id},n.setId=function(t){var e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this},n.getType=function(){return this.type},n.getOptions=function(){return this.options},n.getProperties=function(){return(this.options||{}).properties},n.setProperties=function(t){var e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this},n.getLayer=function(){return this.options.layer},n.getMap=function(){var t=this.getLayer();if(t)return t.getMap()},n.getCenter=function(){var t=this.getOptions(),e=t.coordinate,n=t.lineString,r=t.polygon;if(e)return e instanceof i.Coordinate?e:new i.Coordinate(e);var o=r||n;return o&&o.getCenter?o.getCenter():void 0},n.getAltitude=function(){return this.getOptions().altitude},n.setAltitude=function(t){if(i.Util.isNumber(t)){var e=this.getLayer().distanceToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(var n=0,r=this._baseObjects.length;n<r;n++)this._baseObjects[n]&&(this._baseObjects[n].getObject3d().position.z=e)}return this},n.show=function(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this},n.hide=function(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this},n.isVisible=function(){return!!this.getObject3d().visible},n.getSymbol=function(){return this.getObject3d().material},n.setSymbol=function(t){if(t&&t instanceof o.Material){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;var e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this},n.setInfoWindow=function(t){return this.removeInfoWindow(),this.infoWindow=new i.ui.InfoWindow(t),this.infoWindow.addTo(this),this},n.getInfoWindow=function(){return this.infoWindow},n.openInfoWindow=function(t){return(t=t||this.getCenter())instanceof i.Coordinate||(t=new i.Coordinate(t)),t&&this.infoWindow&&this.infoWindow.show(t),this},n.closeInfoWindow=function(){return this.infoWindow&&this.infoWindow.hide(),this},n.removeInfoWindow=function(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this},n.setToolTip=function(t,e){return this.removeToolTip(),this.toolTip=new i.ui.ToolTip(t,e),this.toolTip.addTo(this),this},n.getToolTip=function(){return this.toolTip},n.openToolTip=function(t){return(t=t||this.getCenter())instanceof i.Coordinate||(t=new i.Coordinate(t)),t&&this.toolTip&&this.toolTip.show(t),this},n.closeToolTip=function(){return this.toolTip&&this.toolTip.hide(),this},n.removeToolTip=function(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this},n.animateShow=function(t,e){var n=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.cancel(),i.Util.isFunction(t)&&(e=t={});var r=t.duration||1e3,o=t.easing||"out",a=this._showPlayer=i.animation.Animation.animate({scale:1},{duration:r,easing:o},(function(t){var r=t.styles.scale;r>0&&(n.getObject3d().scale.z=r),e&&e(t,r)}));return a.play(),a},n.getMinZoom=function(){return this.getOptions().minZoom},n.getMaxZoom=function(){return this.getOptions().maxZoom},n.isAsynchronous=function(){return this.getOptions().asynchronous},n.fire=function(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this},n.config=function(){return this},n.setPickObject3d=function(t){return this.pickObject3d=t,this.pickObject3d.__parent=this,this},n._initOptions=function(t){return this.options=i.Util.extend({},m,t),this},n._createMesh=function(t,e){return this.object3d=new o.Mesh(t,e),this.object3d.__parent=this,this},n._createGroup=function(){return this.object3d=new o.Group,this.object3d.__parent=this,this},n._createLine=function(t,e){return this.object3d=new o.Line(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this},n._createLine2=function(t,e){return this.object3d=new x(t,e),this.object3d.computeLineDistances(),this.object3d.__parent=this,this},n._createPoints=function(t,e){return this.object3d=new o.Points(t,e),this.object3d.__parent=this,this},n._createLineSegments=function(t,e){return this.object3d=new o.LineSegments(t,e),this._computeLineDistances(t),this.object3d.__parent=this,this},n._computeLineDistances=function(t){var e=t.attributes.position.array,n=t.attributes.position.count,r=new Float32Array(n);r[0]=0;for(var i=new o.Vector3(0,0,0),a=new o.Vector3(0,0,0),s=1;s<n;s++){var u=3*(s-1);i.x=e[u],i.y=e[u+1],i.z=e[u+2];var c=3*s;a.x=e[c],a.y=e[c+1],a.z=e[c+2];var h=a.distanceTo(i);r[s]=r[s-1]+h}l(t,"lineDistance",new o.BufferAttribute(r,1))},e}(i.Eventable((function(){})));function w(t){var e=M(t),n=e.position,r=e.normal,i=e.uv,a=e.indices,s=new o.BufferGeometry,u=new Float32Array(n.length);return u.fill(1,0,n.length),l(s,"color",new o.BufferAttribute(u,3)),l(s,"normal",new o.BufferAttribute(r,3)),l(s,"position",new o.BufferAttribute(n,3)),i&&i.length&&l(s,"uv",new o.BufferAttribute(i,2)),s.setIndex(new o.BufferAttribute(a,1)),s}function M(t){for(var e={},n={},r=0;r<t.length;++r){var i=t[r];for(var o in i)void 0===e[o]&&(e[o]=[],n[o]=0),e[o].push(i[o]),n[o]+=i[o].length}var a={},s=0,u=new Uint32Array(n.indices);for(var c in e)if("indices"===c)for(var l=e[c],h=0,f=0,d=l.length;f<d;f++){for(var v=l[f],p=0,g=v.length;p<g;p++)u[h]=v[p]+s,h++;s+=e.position[f].length/3}else{var y=O(e[c],n[c]);if(!y)return null;a[c]=y}return a.indices=u,a}function O(t,e){for(var n=new Float32Array(e),r=0,i=0;i<t.length;++i)n.set(t[i],r),r+=t[i].length;return n}function S(t){var e=t.position,n=t.normal,r=t.uv,i=t.indices,a=new o.BufferGeometry;return l(a,"normal",new o.BufferAttribute(new Float32Array(n),3)),l(a,"position",new o.BufferAttribute(new Float32Array(e),3)),l(a,"uv",new o.BufferAttribute(new Float32Array(r),2)),a.setIndex(new o.BufferAttribute(new Uint32Array(i),1)),a}function A(t){var e=new o.BufferGeometry;return l(e,"normal",t.getAttribute("normal")),l(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}function j(){if(!b){var t=1e-6;b=new o.BoxBufferGeometry(t,t,t)}return b}j();var C=Object.freeze({__proto__:null,mergeBufferGeometries:w,mergeBufferGeometriesAttribute:M,generateBufferGeometry:S,generatePickBufferGeometry:A,getDefaultBufferGeometry:j}),T={},L=new o.BoxBufferGeometry(1,1,1);L.translate(0,0,.5);var k=new o.Color("#fff"),P=new o.Color("#fff");function B(t){var e=t.height,n=t.radialSegments,r=t.radius,i=function(t){if(void 0===t&&(t=6),!T[t]){var e=new o.CylinderBufferGeometry(1,1,1,t,1);e.rotateX(Math.PI/2),e.translate(0,0,.5),e.rotateZ(Math.PI/6),T[t]=e}return T[t]}(n).clone();return i.scale(r,r,e),i}function z(t,e,n,r,i){void 0===r&&(r="y"),void 0===i&&(i=0);var a=0;"y"===r?a=1:"z"===r&&(a=2);var s=t.attributes.position.array,u=s.length;P.setStyle(e),k.setStyle(n);for(var c=new Float32Array(u),h=0;h<u;h+=3){s[h+a]>i?(c[h]=k.r,c[h+1]=k.g,c[h+2]=k.b):(c[h]=P.r,c[h+1]=P.g,c[h+2]=P.b)}return l(t,"color",new o.BufferAttribute(c,3,!0)),c}function E(t){for(var e=[],n=t.length,r=0,i=0;i<n;i++){var a=t[i].attributes.color;a&&(r+=a.array.length)}for(var s=new Float32Array(r),u=0,c=0,h=t.length;c<h;c++){var f=t[c].attributes,d=f.color,v=f.normal,p=f.position,g=f.uv,y=t[c].index;d&&(s.set(d.array,u),u+=d.array.length),e.push({normal:v.array,uv:g.array,position:p.array,indices:y.array})}var x=w(e);s.length&&l(x,"color",new o.BufferAttribute(s,3,!0));for(var m=0,b=t.length;m<b;m++)t[m].dispose();return x}function V(){return L}var U={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"},I=function(t){function e(e,n,r,o){var a;n=i.Util.extend({},U,n,{layer:o,coordinate:e}),(a=t.call(this)||this)._initOptions(n);var s=n,u=s.height,c=s.radius,l=s.topColor,f=s.bottomColor,d=s.altitude;n.height=o.distanceToVector3(u,u).x,n.radius=o.distanceToVector3(c,c).x,n._radius=a.options.radius,n._height=a.options.height;var v=B(n);l&&(z(v,f,l,"z",n.height/2),r.vertexColors=h()),a._createMesh(v,r);var p=o.distanceToVector3(d,d).x,g=o.coordinateToVector3(e,p);return a.getObject3d().position.copy(g),a.type="Bar",a}return a(e,t),e}(_),R=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function F(t){return t.geometry?t.geometry.type:null}function G(t){var e=F(t);if(e)for(var n=0,r=R.length;n<r;n++)if(R[n]===e)return!0;return!1}function Z(t){var e=F(t);return!(!e||e!==R[4]&&e!==R[5])}function D(t){var e=F(t);return!(!e||e!==R[2]&&e!==R[3])}function H(t){var e=F(t);return!(!e||e!==R[0]&&e!==R[1])}function J(t){var e=F(t);return!!(e&&e.indexOf("Multi")>-1)}function Q(t){return t.geometry?t.geometry.coordinates:[]}function W(t,e){var n=F(t);if(!n||!t.geometry)return null;var r=t.geometry.coordinates;if(!r)return null;var o=0,a=0,s=0;switch(n){case"Point":o=r[0],a=r[1],s++;break;case"MultiPoint":case"LineString":for(var u=0,c=r.length;u<c;u++)o+=r[u][0],a+=r[u][1],s++;break;case"MultiLineString":case"Polygon":for(var l=0,h=r.length;l<h;l++)for(var f=0,d=r[l].length;f<d;f++)o+=r[l][f][0],a+=r[l][f][1],s++;break;case"MultiPolygon":for(var v=0,p=r.length;v<p;v++)for(var g=0,y=r[v].length;g<y;g++)for(var x=0,m=r[v][g].length;x<m;x++)o+=r[v][g][x][0],a+=r[v][g][x][1],s++}var b=o/s,_=a/s;return e?(e.x=b,e.y=_,e):new i.Coordinate(b,_)}function q(t){var e=F(t);if(!e||!t.geometry)return null;var n=t.geometry,r=t.properties||{},i=n.coordinates;if(!i)return null;var o,a=[];switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon"}if(o)for(var s=0,u=i.length;s<u;s++)a.push({type:"Feature",geometry:{type:o,coordinates:i[s]},properties:r});else a.push(t);return a}var N=Object.freeze({__proto__:null,isGeoJSON:G,isGeoJSONPolygon:Z,isGeoJSONLine:D,isGeoJSONPoint:H,isGeoJSONMulti:J,getGeoJSONCoordinates:Q,getGeoJSONCenter:W,spliteGeoJSONMulti:q}),K={exports:{}};function X(t,e,n){n=n||2;var r,i,o,a,s,u,c,l=e&&e.length,h=l?e[0]*n:t.length,f=Y(t,0,h,n,!0),d=[];if(!f||f.next===f.prev)return d;if(l&&(f=function(t,e,n,r){var i,o,a,s=[];for(i=0,o=e.length;i<o;i++)(a=Y(t,e[i]*r,i<o-1?e[i+1]*r:t.length,r,!1))===a.next&&(a.steiner=!0),s.push(ct(a));for(s.sort(ot),i=0;i<s.length;i++)at(s[i],n),n=$(n,n.next);return n}(t,e,f,n)),t.length>80*n){r=o=t[0],i=a=t[1];for(var v=n;v<h;v+=n)(s=t[v])<r&&(r=s),(u=t[v+1])<i&&(i=u),s>o&&(o=s),u>a&&(a=u);c=0!==(c=Math.max(o-r,a-i))?1/c:0}return tt(f,d,n,r,i,c),d}function Y(t,e,n,r,i){var o,a;if(i===wt(t,e,n,r)>0)for(o=e;o<n;o+=r)a=mt(o,t[o],t[o+1],a);else for(o=n-r;o>=e;o-=r)a=mt(o,t[o],t[o+1],a);return a&&dt(a,a.next)&&(bt(a),a=a.next),a}function $(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!dt(r,r.next)&&0!==ft(r.prev,r,r.next))r=r.next;else{if(bt(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function tt(t,e,n,r,i,o,a){if(t){!a&&o&&function(t,e,n,r){var i=t;do{null===i.z&&(i.z=ut(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,o,a,s,u,c=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,r=n,s=0,e=0;e<c&&(s++,r=r.nextZ);e++);for(u=c;s>0||u>0&&r;)0!==s&&(0===u||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,u--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}o.nextZ=null,c*=2}while(a>1)}(i)}(t,r,i,o);for(var s,u,c=t;t.prev!==t.next;)if(s=t.prev,u=t.next,o?nt(t,r,i,o):et(t))e.push(s.i/n),e.push(t.i/n),e.push(u.i/n),bt(t),t=u.next,c=u.next;else if((t=u)===c){a?1===a?tt(t=rt($(t),e,n),e,n,r,i,o,2):2===a&&it(t,e,n,r,i,o):tt($(t),e,n,r,i,o,1);break}}}function et(t){var e=t.prev,n=t,r=t.next;if(ft(e,n,r)>=0)return!1;for(var i=t.next.next;i!==t.prev;){if(lt(e.x,e.y,n.x,n.y,r.x,r.y,i.x,i.y)&&ft(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function nt(t,e,n,r){var i=t.prev,o=t,a=t.next;if(ft(i,o,a)>=0)return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,u=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,c=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,h=ut(s,u,e,n,r),f=ut(c,l,e,n,r),d=t.prevZ,v=t.nextZ;d&&d.z>=h&&v&&v.z<=f;){if(d!==t.prev&&d!==t.next&&lt(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&ft(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,v!==t.prev&&v!==t.next&&lt(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&ft(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;d&&d.z>=h;){if(d!==t.prev&&d!==t.next&&lt(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&ft(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;v&&v.z<=f;){if(v!==t.prev&&v!==t.next&&lt(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&ft(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function rt(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!dt(i,o)&&vt(i,r,r.next,o)&&yt(i,o)&&yt(o,i)&&(e.push(i.i/n),e.push(r.i/n),e.push(o.i/n),bt(r),bt(r.next),r=t=o),r=r.next}while(r!==t);return $(r)}function it(t,e,n,r,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&ht(a,s)){var u=xt(a,s);return a=$(a,a.next),u=$(u,u.next),tt(a,e,n,r,i,o),void tt(u,e,n,r,i,o)}s=s.next}a=a.next}while(a!==t)}function ot(t,e){return t.x-e.x}function at(t,e){if(e=function(t,e){var n,r=e,i=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a){if(a=s,s===i){if(o===r.y)return r;if(o===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(i===a)return n;var u,c=n,l=n.x,h=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=l&&i!==r.x&&lt(o<h?i:a,o,l,h,o<h?a:i,o,r.x,r.y)&&(u=Math.abs(o-r.y)/(i-r.x),yt(r,t)&&(u<f||u===f&&(r.x>n.x||r.x===n.x&&st(n,r)))&&(n=r,f=u)),r=r.next}while(r!==c);return n}(t,e)){var n=xt(e,t);$(e,e.next),$(n,n.next)}}function st(t,e){return ft(t.prev,t,e.prev)<0&&ft(e.next,t,t.next)<0}function ut(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function ct(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function lt(t,e,n,r,i,o,a,s){return(i-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(r-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(i-a)*(r-s)>=0}function ht(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&vt(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(yt(t,e)&&yt(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(ft(t.prev,t,e.prev)||ft(t,e.prev,e))||dt(t,e)&&ft(t.prev,t,t.next)>0&&ft(e.prev,e,e.next)>0)}function ft(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function dt(t,e){return t.x===e.x&&t.y===e.y}function vt(t,e,n,r){var i=gt(ft(t,e,n)),o=gt(ft(t,e,r)),a=gt(ft(n,r,t)),s=gt(ft(n,r,e));return i!==o&&a!==s||(!(0!==i||!pt(t,n,e))||(!(0!==o||!pt(t,r,e))||(!(0!==a||!pt(n,t,r))||!(0!==s||!pt(n,e,r)))))}function pt(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function gt(t){return t>0?1:t<0?-1:0}function yt(t,e){return ft(t.prev,t,t.next)<0?ft(t,e,t.next)>=0&&ft(t,t.prev,e)>=0:ft(t,e,t.prev)<0||ft(t,t.next,e)<0}function xt(t,e){var n=new _t(t.i,t.x,t.y),r=new _t(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function mt(t,e,n,r){var i=new _t(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function bt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function _t(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function wt(t,e,n,r){for(var i=0,o=e,a=n-r;o<n;o+=r)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}K.exports=X,K.exports.default=X,X.deviation=function(t,e,n,r){var i=e&&e.length,o=i?e[0]*n:t.length,a=Math.abs(wt(t,0,o,n));if(i)for(var s=0,u=e.length;s<u;s++){var c=e[s]*n,l=s<u-1?e[s+1]*n:t.length;a-=Math.abs(wt(t,c,l,n))}var h=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,d=r[s+1]*n,v=r[s+2]*n;h+=Math.abs((t[f]-t[v])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[v+1]-t[f+1]))}return 0===a&&0===h?0:Math.abs((h-a)/a)},X.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)n.vertices.push(t[i][o][a]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n};var Mt=K.exports;function Ot(t,e,n){var r=e[0],i=e[1],o=n[0]-r,a=n[1]-i;if(0!==o||0!==a){var s=((t[0]-r)*o+(t[1]-i)*a)/(o*o+a*a);s>1?(r=n[0],i=n[1]):s>0&&(r+=o*s,i+=a*s)}return(o=t[0]-r)*o+(a=t[1]-i)*a}function St(t,e,n,r,i){for(var o,a=r,s=e+1;s<n;s++){var u=Ot(t[s],t[e],t[n]);u>a&&(o=s,a=u)}a>r&&(o-e>1&&St(t,e,o,r,i),i.push(t[o]),n-o>1&&St(t,o,n,r,i))}function At(t,e){var n=t.length-1,r=[t[0]];return St(t,0,n,e,r),r.push(t[n]),r}function jt(t,e,n){if(t.length<=2)return t;var r=void 0!==e?e*e:1;return t=At(t=n?t:function(t,e){for(var n,r,i,o,a,s=t[0],u=[s],c=1,l=t.length;c<l;c++)n=t[c],i=s,o=void 0,a=void 0,o=(r=n)[0]-i[0],a=r[1]-i[1],o*o+a*a>e&&(u.push(n),s=n);return s!==n&&u.push(n),u}(t,r),r)}function Ct(t,e){return t[0]*e[0]+t[1]*e[1]}function Tt(t,e){const n=e[0],r=e[1],i=Math.sqrt(n*n+r*r);return t[0]=n/i,t[1]=r/i,t}function Lt(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function kt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Pt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Bt(t,e){const n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);return t[0]=n/o,t[1]=r/o,t[2]=i/o,t}function zt(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2];return t[0]=i*u-o*s,t[1]=o*a-r*u,t[2]=r*s-i*a,t}const Et=[];function Vt(t,e,n,r){const i=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n),o=Math.acos(i)*r;return Lt(Et,n,e,-i),function(t,e){const n=e[0],r=e[1],i=e[2],o=Math.sqrt(n*n+r*r+i*i);t[0]=n/o,t[1]=r/o,t[2]=i/o}(Et,Et),function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}(t,e,Math.cos(o)),Lt(t,t,Et,Math.sin(o)),t}function Ut(t,e,n,r,i,o,a,s,u,c){const l=a-i,h=s-o,f=(l*(e-o)-h*(t-i))/(h*(n-t)-l*(r-e));return u&&(u[c=c||0]=t+f*(n-t),u[c+1]=e+f*(r-e)),f}function It(t,e,n){if(n-e<3)return 0;let r=0;for(let i=2*(n-1),o=2*e;o<2*n;){const e=t[i],n=t[i+1],a=t[o],s=t[o+1];i=o,o+=2,r+=e*s-a*n}return r}function Rt(t,e,n=2){return Mt(t,e,n)}const Ft=[],Gt=[],Zt=[];function Dt(t,e,n,r,i,o,a,s,u){const c=null!=a;let l,h,f,d=i,v=null;c&&(v=new Uint32Array(r-n));let p=[];for(let i=n;i<r;i++){const g=i===r-1?n:i+1,y=i===n?r-1:i-1,x=t[2*y],m=t[2*y+1],b=t[2*i],_=t[2*i+1],w=t[2*g],M=t[2*g+1];Ft[0]=b-x,Ft[1]=_-m,Gt[0]=w-b,Gt[1]=M-_,Tt(Ft,Ft),Tt(Gt,Gt),c&&(v[i]=d);let O,S,A=!1;if(s||i!==n)if(s||i!==r-1){kt(Zt,Gt,Ft);const t=Zt[1];Zt[1]=-Zt[0],Zt[0]=t,Tt(Zt,Zt);const n=Ct(Zt,Gt),r=Math.sqrt(1-n*n),i=o*Math.min(10,1/r),s=o*n<0;if(c&&1/r>a&&s){const t=b+Zt[0]*o,n=_+Zt[1]*o,i=Math.acos(r)/2,a=Math.tan(i)*Math.abs(o);e[2*d]=t+Zt[1]*a,e[2*d+1]=n-Zt[0]*a,d++,e[2*d]=t-Zt[1]*a,e[2*d+1]=n+Zt[0]*a,d++}else O=b+Zt[0]*i,S=_+Zt[1]*i,A=!0;if(A){if(u&&null!=l){const t=Ut(x,m,l,h,b,_,O,S,p,0);t>=-.01&&t<=1.01&&(e[2*f]=O=p[0],e[2*f+1]=S=p[1])}l=e[2*d]=O,h=e[2*d+1]=S,f=d,d++}}else Zt[0]=Ft[1],Zt[1]=-Ft[0],Tt(Zt,Zt),O=b+Zt[0]*o,S=_+Zt[1]*o,A=!0;else Zt[0]=Gt[1],Zt[1]=-Gt[0],Tt(Zt,Zt),l=e[2*d]=b+Zt[0]*o,h=e[2*d+1]=_+Zt[1]*o,f=d,d++}return v}function Ht(t,e,n,r,i,o,a,s){const u=null!=a;let c=i,l=null;u&&(l=new Uint32Array(r-n));for(let i=n;i<r;i++){const h=i===r-1?n:i+1,f=i===n?r-1:i-1,d=t[2*f],v=t[2*f+1],p=t[2*i],g=t[2*i+1],y=t[2*h],x=t[2*h+1];if(Ft[0]=p-d,Ft[1]=g-v,Gt[0]=y-p,Gt[1]=x-g,Tt(Ft,Ft),Tt(Gt,Gt),u&&(l[i]=c),s||i!==n)if(s||i!==r-1){kt(Zt,Gt,Ft);const t=Zt[1];Zt[1]=-Zt[0],Zt[0]=t,Tt(Zt,Zt);const n=Ct(Zt,Gt),r=Math.sqrt(1-n*n),i=o*Math.min(10,1/r),s=o*n<0;if(u&&1/r>a&&s){const t=p+Zt[0]*o,n=g+Zt[1]*o,i=Math.acos(r)/2,a=Math.tan(i)*Math.abs(o);e[2*c]=t+Zt[1]*a,e[2*c+1]=n-Zt[0]*a,c++,e[2*c]=t-Zt[1]*a,e[2*c+1]=n+Zt[0]*a,c++}else e[2*c]=p+Zt[0]*i,e[2*c+1]=g+Zt[1]*i,c++}else Zt[0]=Ft[1],Zt[1]=-Ft[0],Tt(Zt,Zt),e[2*c]=p+Zt[0]*o,e[2*c+1]=g+Zt[1]*o,c++;else Zt[0]=Gt[1],Zt[1]=-Gt[0],Tt(Zt,Zt),e[2*c]=p+Zt[0]*o,e[2*c+1]=g+Zt[1]*o,c++}return l}function Jt(t,e,n,r,i){const o=null!=r?[]:new Float32Array(t.length);if(Dt(t,o,0,e&&e.length?e[0]:t.length/2,0,n,r,i,!0),e)for(let a=0;a<e.length;a++){const s=e[a];Dt(t,o,s,e[a+1]||t.length/2,null!=r?o.length/2:s,n,r,i,!1)}return o}function Qt(t,e,n,r){for(let i=0;i<Math.floor((r-n)/2);i++)for(let o=0;o<e;o++){const a=(i+n)*e+o,s=(r-i-1)*e+o,u=t[a];t[a]=t[s],t[s]=u}return t}function Wt(t,e){let n=t.length/2,r=0,i=e&&e.length?e[0]:n;It(t,r,i)>0&&Qt(t,2,r,i);for(let o=1;o<(e?e.length:0)+1;o++)r=e[o-1],i=e[o]||n,It(t,r,i)<0&&Qt(t,2,r,i)}function qt(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothBevel=t.smoothBevel||!1,t.simplify=t.simplify||0,null==t.smoothSide&&(t.smoothSide="auto"),null==t.smoothSideThreshold&&(t.smoothSideThreshold=.9),"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let n=null==t.fitRect.x?e.x||0:t.fitRect.x,r=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(n-e.x)*t.scale[0],(r-e.y)*t.scale[1]]}}const Nt=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function Kt(t,e,n){let r=0,i=t[e],o=t[e+1];const a=i,s=o;for(let a=e+2;a<n;a+=2){const e=t[a],n=t[a+1];r+=Math.sqrt((e-i)*(e-i)+(n-o)*(n-o)),i=e,o=n}return r+=Math.sqrt((i-a)*(i-a)+(o-s)*(o-s)),r}function Xt(t,{vertices:e,topVertices:n,splittedMap:r,depth:i,rect:o},a,s,u,c){const l=s-a,h=c.smoothBevel?1:2,f=Math.min(i/2,c.bevelSize),d=c.bevelSegments,v=u.vertex,p=u.ringPerimeter,g=Math.max(o.width,o.height,i,p);function y(t){const n=(t+1)%l,r=e[2*t],i=e[2*t+1],o=e[2*n],a=e[2*n+1];return r===o&&i===a}if(f>0){const o=[0,0,1],s=[],c=[0,0,-1],p=[];let x=0,m=new Float32Array(l);for(let b=0;b<2;b++){const _=0===b?i-f:f;for(let i=0;i<=d*h;i++){let w,M,O=0;for(let S=0;S<l;S++){const A=2*(S%l+a),j=r?2*r[A/2]:A;s[0]=e[A]-n[j],s[1]=e[A+1]-n[j+1],s[2]=0;const C=Math.sqrt(s[0]*s[0]+s[1]*s[1]);s[0]/=C,s[1]/=C;const T=(Math.floor(i/h)+i%h)/d;0===b?Vt(p,o,s,T):Vt(p,s,c,T);const L=0===b?T:1-T,k=f*Math.sin(L*Math.PI/2),P=C*Math.cos(L*Math.PI/2),B=f*C/Math.sqrt(k*k+P*P),z=p[0]*B+n[j],E=p[1]*B+n[j+1],V=p[2]*B+_;if(t.position[3*u.vertex]=z,t.position[3*u.vertex+1]=E,t.position[3*u.vertex+2]=V,S>0&&(O+=Math.sqrt((w-z)*(w-z)+(M-E)*(M-E))),i>0||b>0){let e=3*(u.vertex-l),n=t.position[e],r=t.position[e+1],i=t.position[e+2];m[S]+=Math.sqrt((n-z)*(n-z)+(r-E)*(r-E)+(i-V)*(i-V))}if(t.uv[2*u.vertex]=O/g,t.uv[2*u.vertex+1]=m[S]/g,w=z,M=E,u.vertex++,!y(S)&&(h>1&&i%h||1===h&&i>=1))for(let e=0;e<6;e++){const n=(Nt[e][0]+S)%l,r=Nt[e][1]+x;t.indices[u.index++]=(r-1)*l+n+v}}x++}}}else for(let n=0;n<2;n++){const r=0===n?i-f:f;let o,s,c=0;for(let n=0;n<l;n++){const i=2*(n%l+a),h=e[i],f=e[i+1];t.position[3*u.vertex]=h,t.position[3*u.vertex+1]=f,t.position[3*u.vertex+2]=r,n>0&&(c+=Math.sqrt((o-h)*(o-h)+(s-f)*(s-f))),t.uv[2*u.vertex]=c/g,t.uv[2*u.vertex+1]=r/g,o=h,s=f,u.vertex++}}const x=f>0?d*h+1:1;for(let e=0;e<l;e++)if(!y(e))for(let n=0;n<6;n++){const r=(Nt[n][0]+e)%l,i=Nt[n][1]+x;t.indices[u.index++]=(i-1)*l+r+v}}function Yt({indices:t,topVertices:e,rect:n,depth:r},i,o,a){if(e.length<=4)return;const s=o.vertex,u=t.length;for(let e=0;e<u;e++)i.indices[o.index++]=s+t[e];const c=Math.max(n.width,n.height);for(let t=0;t<(a.excludeBottom?1:2);t++)for(let a=0;a<e.length;a+=2){const s=e[a],u=e[a+1];i.position[3*o.vertex]=s,i.position[3*o.vertex+1]=u,i.position[3*o.vertex+2]=(1-t)*r,i.uv[2*o.vertex]=(s-n.x)/c,i.uv[2*o.vertex+1]=(u-n.y)/c,o.vertex++}if(!a.excludeBottom){const n=e.length/2;for(let e=0;e<u;e+=3)for(let r=0;r<3;r++)i.indices[o.index++]=s+n+t[e+2-r]}}function $t(t,e,n,r){const i=null==n||"auto"===n;if(!0===n)return{vertices:t,holes:e};const o=[],a=e&&[],s=t.length/2,u=[],c=[],l=[];let h=0,f=0;const d=(e?e.length:0)+1;for(let n=0;n<d;n++){0===n?f=e&&e.length?e[0]:s:(h=e[n-1],f=e[n]||s);for(let e=h;e<f;e++){const n=t[2*e],a=t[2*e+1],s=e===f-1?h:e+1,d=t[2*s],v=t[2*s+1];if(i){const i=e===h?f-1:e-1,s=t[2*i],p=t[2*i+1];u[0]=s-n,u[1]=p-a,c[0]=d-n,c[1]=v-a,Tt(u,u),Tt(c,c);1-(.5*Ct(u,c)+.5)>r?(o.push(n,a),l.push(e)):(o.push(n,a,n,a),l.push(e,e))}else o.push(n,a,n,a),l.push(e,e)}n<d-1&&a&&a.push(o.length/2)}return{vertices:new Float32Array(o),splittedMap:l,holes:a}}function te(t,e){let n=0,r=0;for(let i=0;i<t.length;i++){const{indices:o,vertices:a,splittedMap:s,topVertices:u,depth:c}=t[i],l=Math.min(c/2,e.bevelSize)>0?e.bevelSegments:0,h=t[i].holes||[];n+=o.length*(e.excludeBottom?1:2),r+=u.length/2*(e.excludeBottom?1:2);const f=2+2*l;let d=0,v=0;for(let t=0;t<h.length+1;t++){0===t?v=h.length?h[0]:a.length/2:(d=h[t-1],v=h[t]||a.length/2);n+=6*((s?s[v-1]+1:v)-(s?s[d]:d))*(f-1);const i=v-d;r+=i*f+(e.smoothBevel?0:l*i*2)}}const i={position:new Float32Array(3*r),indices:new(r>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},o={vertex:0,index:0,ringPerimeter:0};for(let n=0;n<t.length;n++)Yt(t[n],i,o,e);for(let n=0;n<t.length;n++){const{holes:r,vertices:a}=t[n],s=a.length/2;let u=0,c=r&&r.length?r[0]:s;if(o.ringPerimeter=Kt(t[n].topVertices,u,c),Xt(i,t[n],u,c,o,e),r)for(let a=0;a<r.length;a++)u=r[a],c=r[a+1]||s,o.ringPerimeter=Kt(t[n].topVertices,u,c),Xt(i,t[n],u,c,o,e)}for(let t=0;t<i.uv.length;t++){const e=i.uv[t];e>0&&Math.round(e)===e?i.uv[t]=1:i.uv[t]=e%1}return i.normal=function(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}const r=[],i=[],o=[],a=[],s=[],u=[],c=t.length,l=new Float32Array(e.length);for(let h=0;h<c;){const c=3*t[h++],f=3*t[h++],d=3*t[h++];n(r,e[c],e[c+1],e[c+2]),n(i,e[f],e[f+1],e[f+2]),n(o,e[d],e[d+1],e[d+2]),Pt(a,r,i),Pt(s,i,o),zt(u,a,s);for(let t=0;t<3;t++)l[c+t]=l[c+t]+u[t],l[f+t]=l[f+t]+u[t],l[d+t]=l[d+t]+u[t]}for(var h=0;h<l.length;)n(u,l[h],l[h+1],l[h+2]),Bt(u,u),l[h++]=u[0],l[h++]=u[1],l[h++]=u[2];return l}(i.indices,i.position),i.boundingRect=t[0]&&t[0].rect,i}function ee(t,e,n){const r=n.lineWidth,i=t.length,o=new Float32Array(2*i),a=n.translate||[0,0],s=n.scale||[1,1];for(let e=0,n=0;e<i;e++)o[n++]=t[e][0]*s[0]+a[0],o[n++]=t[e][1]*s[1]+a[1];It(o,0,i)<0&&Qt(o,2,0,i);const u=[],c=[],l=n.miterLimit,h=Ht(o,c,0,i,0,-r/2,l,!1);Qt(o,2,0,i);const f=Ht(o,u,0,i,0,-r/2,l,!1),d=(u.length+c.length)/2,v=new Float32Array(2*d);let p=0;const g=c.length/2;for(let t=0;t<c.length;t++)v[p++]=c[t];for(let t=0;t<u.length;t++)v[p++]=u[t];const y=new(d>65535?Uint32Array:Uint16Array)(3*(2*(i-1)+(d-2*i)));let x=0;for(let t=0;t<i-1;t++){const e=t+1;y[x++]=g-1-h[t],y[x++]=g-1-h[t]-1,y[x++]=f[t]+1+g,y[x++]=g-1-h[t],y[x++]=f[t]+1+g,y[x++]=f[t]+g,f[e]-f[t]==2?(y[x++]=f[t]+2+g,y[x++]=f[t]+1+g,y[x++]=g-h[e]-1):h[e]-h[t]==2&&(y[x++]=f[e]+g,y[x++]=g-1-(h[t]+1),y[x++]=g-1-(h[t]+2))}const m=n.bevelSize>0?Jt(v,[],n.bevelSize,null,!0):v,b=n.boundingRect,_=$t(v,null,n.smoothSide,n.smoothSideThreshold);return{vertices:_.vertices,rawVertices:m,splittedMap:_.splittedMap,indices:y,topVertices:m,rect:{x:b.x*s[0]+a[0],y:b.y*s[1]+a[1],width:b.width*s[0],height:b.height*s[1]},depth:"function"==typeof n.depth?n.depth(e):n.depth,holes:[]}}function ne(t,e){const n=[];for(let r=0;r<t.length;r++){const i=t[r],o=[],a=i.length;let s=i[a-1][0],u=i[a-1][1],c=0;for(let t=0;t<a;t++){let n=i[t][0],r=i[t][1];const a=n-s,l=r-u;c+=Math.sqrt(a*a+l*l),c>e&&(o.push(i[t]),c=0),s=n,u=r}o.length>=3&&n.push(o)}return n.length>0?n:null}function re(t,e){const n=[];for(let r=0;r<t.length;r++){let i=t[r];i=jt(i,e,!0),i.length>=3&&n.push(i)}return n.length>0?n:null}function ie(t,e){e=Object.assign({},e);const n=[1/0,1/0],r=[-1/0,-1/0];for(let e=0;e<t.length;e++)ae(t[e][0],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},qt(e);const i=[],o=e.translate||[0,0],a=e.scale||[1,1],s=e.boundingRect,u={x:s.x*a[0]+o[0],y:s.y*a[1]+o[1],width:s.width*a[0],height:s.height*a[1]},c=Math.min(s.width,s.height)/1e5;for(let n=0;n<t.length;n++){let r=ne(t[n],c);if(!r)continue;const s=e.simplify/Math.max(a[0],a[1]);if(s>0&&(r=re(r,s)),!r)continue;const{vertices:l,holes:h,dimensions:f}=Mt.flatten(r);for(let t=0;t<l.length;)l[t]=l[t++]*a[0]+o[0],l[t]=l[t++]*a[1]+o[1];if(Wt(l,h),2!==f)throw new Error("Only 2D polygon points are supported");const d=e.bevelSize>0?Jt(l,h,e.bevelSize,null,!0):l,v=Rt(d,h,f),p=$t(l,h,e.smoothSide,e.smoothSideThreshold);i.push({indices:v,vertices:p.vertices,rawVertices:l,topVertices:d,holes:p.holes,splittedMap:p.splittedMap,rect:u,depth:"function"==typeof e.depth?e.depth(n):e.depth})}return te(i,e)}function oe(t,e){e=Object.assign({},e);const n=[1/0,1/0],r=[-1/0,-1/0];for(let e=0;e<t.length;e++)ae(t[e],n,r);e.boundingRect=e.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},qt(e);const i=e.scale||[1,1];null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const o=[];for(let n=0;n<t.length;n++){let r=t[n];const a=e.simplify/Math.max(i[0],i[1]);a>0&&(r=jt(r,a,!0)),o.push(ee(r,n,e))}return te(o,e)}function ae(t,e,n){for(let r=0;r<t.length;r++)e[0]=Math.min(t[r][0],e[0]),e[1]=Math.min(t[r][1],e[1]),n[0]=Math.max(t[r][0],n[0]),n[1]=Math.max(t[r][1],n[1])}var se=Object.freeze({__proto__:null,triangulate:Rt,flatten:function(t){return Mt.flatten(t)},offsetPolygon:Jt,extrudePolygon:ie,extrudePolyline:oe,extrudeGeoJSON:function(t,e){e=Object.assign({},e);const n=[],r=[],i=[],o=[],a=[1/0,1/0],s=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const u=t.features[e].geometry;if(u&&u.coordinates)switch(u.type){case"LineString":n.push(u.coordinates),i.push(e),ae(u.coordinates,a,s);break;case"MultiLineString":for(let t=0;t<u.coordinates.length;t++)n.push(u.coordinates[t]),i.push(e),ae(u.coordinates[t],a,s);break;case"Polygon":r.push(u.coordinates),o.push(e),ae(u.coordinates[0],a,s);break;case"MultiPolygon":for(let t=0;t<u.coordinates.length;t++)r.push(u.coordinates[t]),o.push(e),ae(u.coordinates[t][0],a,s)}}e.boundingRect=e.boundingRect||{x:a[0],y:a[1],width:s[0]-a[0],height:s[1]-a[1]};const u=e.depth;return{polyline:oe(n,Object.assign(e,{depth:function(e){return"function"==typeof u?u(t.features[i[e]]):u}})),polygon:ie(r,Object.assign(e,{depth:function(e){return"function"==typeof u?u(t.features[o[e]]):u}}))}}});function ue(t,e,n){return void 0===n&&(n={}),void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function ce(t){void 0===t&&(t=[]);for(var e=0,n=0,r=t.length,o=0;o<r;o++){var a=t[o],s=a.coordinate,u=a.lnglat,c=a.lnglats,l=a.xy,h=a.xys,f=s||u||c||l||h||t[o],d=void 0,v=void 0;Array.isArray(f)?(d=f[0],v=f[1]):f instanceof i.Coordinate&&(d=f.x,v=f.y),e+=d,n+=v}return new i.Coordinate(e/r,n/r)}function le(t,e,n,r){if(void 0===e||"number"!=typeof e||0===e)return 0;var i,a=0;if(i=t instanceof o.BufferGeometry?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position){r?(void 0===r[e]&&(r[e]=n.distanceToVector3(e,e).x),a=r[e]):a=n.distanceToVector3(e,e).x;var s=i.length;if(i[0]instanceof o.Vector3)for(var u=0;u<s;u++)i[u].z+=a;else for(var c=0;c<s;c+=3)i[c+2]+=a}return a}function he(t){for(var e=t.length,n=0,r=0;r<e;r++){n+=t[r].position.count}return new Float32Array(3*n)}function fe(t){void 0===t&&(t=[]);for(var e=t.length,n=new Float64Array(2*e),r=0;r<e;r++){var i=void 0,o=void 0,a=t[r];a.x?(i=a.x,o=a.y):(i=a[0],o=a[1]),n[2*r]=i,n[2*r+1]=o}return n.buffer}var de=new o.Color("#fff"),ve=new o.Color("#fff");function pe(t,e,n,r){var i=ge(t,e,n,r),a=i.position,s=i.normal,u=i.uv,c=i.indices,h=new Float32Array(a.length);h.fill(1,0,a.length);var f=new o.BufferGeometry;return l(f,"color",new o.BufferAttribute(h,3)),l(f,"normal",new o.BufferAttribute(s,3)),l(f,"position",new o.BufferAttribute(a,3)),l(f,"uv",new o.BufferAttribute(u,2)),f.setIndex(new o.Uint32BufferAttribute(c,1)),f}function ge(t,e,n,r,i,o){var a=xe(t,n,r,i,!1);if(!a)return null;o?(null==o[e]&&(o[e]=n.distanceToVector3(e,e).x),e=o[e]):e=n.distanceToVector3(e,e).x;var s=ie(a,{depth:e});return{position:s.position,normal:s.normal,uv:s.uv,indices:s.indices}}function ye(t,e,n,r){void 0===r&&(r=0);var i,a=t.attributes.position.array,s=a.length;if(ve.setStyle(e),de.setStyle(n),Array.isArray(r)){for(var u=0,c=0,h=r.length;c<h;c++){u+=3*r[c].position.count}i=new Float32Array(u)}else i=new Float32Array(a.length);if(Array.isArray(r))for(var f=0,d=r.length;f<d;f++)for(var v=r[f].position,p=v.middleZ,g=v.start,y=v.end,x=g;x<y;x+=3){a[x+2]>p?(i[x]=de.r,i[x+1]=de.g,i[x+2]=de.b):(i[x]=ve.r,i[x+1]=ve.g,i[x+2]=ve.b)}else for(var m=0;m<s;m+=3){a[m+2]>r?(i[m]=de.r,i[m+1]=de.g,i[m+2]=de.b):(i[m]=ve.r,i[m+1]=ve.g,i[m+2]=ve.b)}return l(t,"color",new o.BufferAttribute(i,3,!0)),i}function xe(t,e,n,r,o){if(void 0===o&&(o=!1),!t)return null;var a=[];if(t instanceof i.MultiPolygon)a=t.getGeometries().map((function(i){return me(i,e,n||t.getCenter(),r,o)}));else if(t instanceof i.Polygon){var s=me(t,e,n||t.getCenter(),r,o);a.push(s)}else if(Z(t))if(J(t))for(var u=q(t),c=0,l=u.length;c<l;c++)a.push(me(u[c],e,n||W(t),r,o));else{var h=me(t,e,n||W(t),r,o);a.push(h)}return a}function me(t,e,n,r,o){var a,s,u;if(void 0===o&&(o=!1),Z(t)){var c=Q(t);a=c[0],s=c.slice(1,c.length),n=n||W(t)}else t instanceof i.Polygon&&(a=t.getShell(),s=t.getHoles(),n=n||t.getCenter());r=r||e.coordinateToVector3(n),u=o?e.coordinatiesToGLFloatArray(a,r).positons2d:e.coordinatiesToGLArray(a,r);var l=[o?u.buffer:u];if(s&&s.length>0)for(var h=0,f=s.length;h<f;h++){var d=void 0;d=o?e.coordinatiesToGLFloatArray(s[h],r).positons2d:e.coordinatiesToGLArray(s[h],r),l.push(o?d.buffer:d)}return l}function be(t){if(!t)return null;var e=[];if(t instanceof i.MultiPolygon)e=t.getGeometries().map((function(t){return _e(t,!1)}));else if(t instanceof i.Polygon){var n=_e(t,!1);e.push(n)}else if(Z(t))if(J(t))for(var r=q(t),o=0,a=r.length;o<a;o++)e.push(_e(r[o],!0));else{var s=_e(t,!0);e.push(s)}return e}function _e(t,e){var n,r;if(e){var o=Q(t);n=o[0],r=o.slice(1,o.length)}else t instanceof i.Polygon&&(n=t.getShell(),r=t.getHoles());var a=[fe(n)];if(r&&r.length>0)for(var s=0,u=r.length;s<u;s++){var c=fe(r[s]);a.push(c)}return a}var we,Me=Object.freeze({__proto__:null,getExtrudeGeometry:pe,getExtrudeGeometryParams:ge,initVertexColors:ye,getPolygonPositions:xe,getSinglePolygonPositions:me,getPolygonArrayBuffer:be,getSinglePolygonArrayBuffer:_e});function Oe(t,e,n,r){void 0===r&&(r=!0);var a,s,u=[];if(Array.isArray(t)&&t[0]instanceof o.Vector3)for(var c=0,l=t.length;c<l;c++){var h=t[c];u.push(h)}else{Array.isArray(t)&&(t=new i.LineString(t));var f,d;G(t)?(f=Q(t),n||(d=W(t))):t instanceof i.LineString&&(f=t.getCoordinates(),n||(d=t.getCenter()));var v=e.coordinateToVector3(n||d);if(r)for(var p=0,g=f.length;p<g;p++){var y=f[p],x=e.coordinateToVector3(y,0).sub(v);u.push(x)}else{var m=e.coordinatiesToGLFloatArray(f,v);a=m.positions,s=m.positons2d}}if(!r)return{positions:a,positionsV:u,positions2d:s,arrayBuffer:s.buffer};s=new Float32Array(2*u.length),a=new Float32Array(3*u.length);for(var b=0,_=u.length;b<_;b++){var w=3*b,M=u[b];a[w]=M.x,a[w+1]=M.y,a[w+2]=M.z;var O=2*b;s[O]=M.x,s[O+1]=M.y}return{positions:a,positionsV:u,positions2d:s,arrayBuffer:s.buffer}}function Se(t,e,n,r){for(var i=[],o=[],a=[],s=0,u=t.length;s<u;s++)for(var c=t[s],l=0,h=c.length;l<h;l++){var f=c[l];if(a.length>0)f.join(",").toString()!==a[a.length-1].join(",").toString()&&a.push(f);else a.push(f)}for(var d=0,v=a.length;d<v;d++){var p=a[d],g=void 0,y=p.join(",").toString();g=n&&n[y]?n[y]:e.coordinateToVector3(p,0).sub(r),o.push(g),i.push(g.x,g.y,g.z)}return{positions:i,positionsV:o,lnglats:a}}function Ae(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);for(var o=Oe(t,r,i).positionsV,a=[],s=0,u=o.length;s<u;s++){var c=o[s];a.push([c.x,c.y])}var l=oe([a],{lineWidth:e,depth:n}),h=l.indices;return{position:l.position,normal:l.normal,indices:h,uv:l.uv}}function je(t){var e,n=[];return t instanceof i.MultiLineString?(n=t.getGeometries(),e=t.getCenter()):t instanceof i.LineString?(n.push(t),e=t.getCenter()):G(t)&&(e=W(t),J(t)?n=q(t):n.push(t)),{lineStrings:n,center:e}}function Ce(t){for(var e=new Float32Array(2*t.length-6),n=0,r=0,i=t.length/3;r<i;r++){var o=t[3*r],a=t[3*r+1],s=t[3*r+2];if(r>0&&r<i-1){var u=3*n;e[u]=o,e[u+1]=a,e[u+2]=s,n++}var c=3*n;e[c]=o,e[c+1]=a,e[c+2]=s,n++}return e}function Te(t){var e=0,n=t.length;if(1===n)return t[0];for(var r=0;r<n;r++)e+=t[r].length;for(var i=new Float32Array(e),o=0,a=0;a<n;a++)i.set(t[a],o),o+=t[a].length;return i}function Le(t){return t instanceof i.LineString?fe(t.getCoordinates()):D(t)?fe(t.geometry.coordinates):void 0}function ke(){return we||l(we=new o.BufferGeometry,"position",new o.BufferAttribute(new Float32Array(3),3)),we}var Pe,Be,ze=Object.freeze({__proto__:null,getLinePosition:Oe,getExtrudeLineGeometry:function(t,e,n,r,i){void 0===e&&(e=1),void 0===n&&(n=1);var a=Ae(t,e,n,r,i),s=a.indices,u=a.position,c=a.normal,h=a.uv,f=new o.BufferGeometry;return l(f,"position",new o.BufferAttribute(u,3)),l(f,"normal",new o.BufferAttribute(c,3)),l(f,"uv",new o.BufferAttribute(h,2)),f.setIndex(new o.BufferAttribute(s,1)),f},getChunkLinesPosition:Se,getExtrudeLineParams:Ae,LineStringSplit:je,setLineSegmentPosition:function(t,e){for(var n=0,r=e.length;n<r;n++){var i=e[n];n>0&&n<r-1&&t.push(i.x,i.y,i.z),t.push(i.x,i.y,i.z)}},getLineSegmentPosition:Ce,mergeLinePositions:Te,getLineArrayBuffer:Le,getDefaultLineGeometry:ke});function Ee(){return i.worker||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),!Be&&Pe&&(Be=new Pe("__maptalks.three__")),Be}function Ve(t,e,n){return void 0===n&&(n={}),void 0!==t&&"number"==typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]):0}function Ue(t,e,n,r,i){void 0===i&&(i=[]);var o,a,s,u=n.isMercator();if(u){var c=n.getMap();o=c.getGLRes(),a=c.getSpatialReference().getTransformation().matrix}e&&(s=n.coordinateToVector3(e));for(var l=[],h=[],f={},d=t.length,v=0;v<d;v++){var p=t[v],g=i[v]?i[v]:D(r[v])?r[v].properties:r[v].getProperties()||{};e||(s=n.coordinateToVector3(g.center));var y=g.width||1,x=g.height||1,m=g.bottomHeight||0;y=Ve(y,n,f),x=Ve(x,n,f),m=Ve(m,n,f);for(var b=[],_=0,w=p.length;_<w;_++){var M=p[_],O=void 0;O=u?Le(M):Oe(M,n,e,!1).arrayBuffer,h.push(O),b.push(O)}var S={id:g.id,data:b,height:x,width:y,bottomHeight:m};u&&(S.center=[s.x,s.y]),l.push(S)}return{datas:l,transfer:h,glRes:o,matrix:a,center:u?[s.x,s.y]:null}}function Ie(t,e,n,r,i){void 0===i&&(i=[]);var o,a,s,u=n.isMercator();if(u){var c=n.getMap();o=c.getGLRes(),a=c.getSpatialReference().getTransformation().matrix}e&&(s=n.coordinateToVector3(e));for(var l=[],h=[],f={},d=t.length,v=0;v<d;v++){var p=t[v],g=i[v]?i[v]:D(r[v])?r[v].properties:r[v].getProperties()||{};e||(s=n.coordinateToVector3(g.center));var y=g.bottomHeight||0;y=Ve(y,n,f);for(var x=[],m=0,b=p.length;m<b;m++){var _=p[m];if(u){var w=Le(_);x.push(w),x.push(w)}else{var M=Oe(_,n,e,!1).arrayBuffer;h.push(M),x.push(M)}}var O={id:g.id,data:x,bottomHeight:y};u&&(O.center=[s.x,s.y]),l.push(O)}return{datas:l,transfer:h,glRes:o,matrix:a,center:u?[s.x,s.y]:null}}function Re(t){return t.map((function(t){return t.data}))}function Fe(t){return t.map((function(t){return t.baseObject.getOptions()}))}i.worker&&(Pe=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var n=e.prototype;return n.test=function(t,e){this.send(t,null,e)},n.pushQueue=function(t){void 0===t&&(t={});var e,n=t,r=n.type,i=n.data,o=n.callback,a=n.layer,s=n.key,u=n.center,c=n.lineStrings,l=n.options,h=n.id;r.indexOf("ExtrudePolygon")>-1?e=function(t,e,n,r){void 0===t&&(t=[]);void 0===r&&(r=[]);var i,o,a,s=n.isMercator();if(s){var u=n.getMap();i=u.getGLRes(),o=u.getSpatialReference().getTransformation().matrix}e&&(a=n.coordinateToVector3(e));for(var c=t.length,l=[],h=[],f={},d=0;d<c;d++){var v=t[d],p=v,g=r[d]?r[d]:Z(p)?p.properties:p.getProperties()||{};e||(a=n.coordinateToVector3(g.center));for(var y=void 0,x=0,m=(y=s?be(v):xe(v,n,g.center||e,a,!0)).length;x<m;x++)for(var b=y[x],_=0,w=b.length;_<w;_++)h.push(b[_]);var M=g.height||1,O=g.bottomHeight||0;M=Ve(M,n,f),O=Ve(O,n,f);var S={id:g.id,data:y,height:M,bottomHeight:O};s&&(S.center=[a.x,a.y]),l.push(S),p._properties&&delete p._properties}return{datas:l,transfer:h,glRes:i,matrix:o,center:s?[a.x,a.y]:null}}(i,u,a,l):"ExtrudeLines"===r?e=Ue(i,u,a,c):"Point"===r||("Line"===r||"FatLine"===r?e=Ie(i,u,a,c,l):"Lines"===r||"FatLines"===r?e=Ie(i,u,a,c):"ExtrudeLine"===r&&(e=Ue(i,u,a,c,l))),e?this.send({type:r,datas:e.datas,glRes:e.glRes,matrix:e.matrix,center:e.center},e.transfer,(function(t,e){t&&console.error(t),e.key=s,e.id=h,o(e)})):console.error("not support '"+r+"' worker")},e}(i.worker.Actor));var Ge=function(){function t(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}var e=t.prototype;return e.getCurrentTime=function(){return i.Util.now()},e.loop=function(){this.deQueue()},e.push=function(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this},e.reset=function(){return this.time=this.getCurrentTime(),this.tempQueue=[],this},e.pushResult=function(t){var e=this;if(t)return Array.isArray(t)||(t=[t]),t.forEach((function(t){e.resultQueue.push(t)})),this},e.deQueue=function(){var t=this;if(!this.resultQueue.length)return this;var e=this.deQueueCount;return(this.resultQueue.slice(0,e)||[]).forEach((function(e){var n=e.id;if(t.queueMap[n]){var r=t.queueMap[n].baseObject;r&&r._workerLoad&&r._workerLoad(e),delete t.queueMap[n]}})),this.resultQueue.splice(0,e),this},t}(),Ze=function(t){function e(){var e;return(e=t.call(this)||this).deQueueCount=100,e}return a(e,t),e.prototype.loop=function(){var e=this;(this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length&&(Ee().pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:Re(this.tempQueue),options:Fe(this.tempQueue),callback:function(t){e.pushResult(t)}}),this.reset());t.prototype.loop.call(this)},e}(Ge),De=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.loop=function(){var e=this;if(this.tempQueue.length){var n=Ee();this.tempQueue.forEach((function(t){n.pushQueue({id:t.id,type:"ExtrudePolygons",layer:t.layer,data:t.data,key:t.key,center:t.center,callback:function(t){e.pushResult(t)}})})),this.reset()}t.prototype.loop.call(this)},e}(Ge),He=function(t){function e(){var e;return(e=t.call(this)||this).deQueueCount=100,e}return a(e,t),e.prototype.loop=function(){var e=this;(this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length&&(Ee().pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:Re(this.tempQueue),options:Fe(this.tempQueue),lineStrings:this.tempQueue.map((function(t){return t.lineString})),callback:function(t){e.pushResult(t)}}),this.reset());t.prototype.loop.call(this)},e}(Ge),Je=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.loop=function(){var e=this;if(this.tempQueue.length){var n=Ee();this.tempQueue.forEach((function(t){n.pushQueue({id:t.id,type:"ExtrudeLines",layer:t.layer,data:t.data,key:t.key,lineStrings:t.lineStrings,center:t.center,callback:function(t){e.pushResult(t)}})})),this.reset()}t.prototype.loop.call(this)},e}(Ge),Qe=function(t){function e(){var e;return(e=t.call(this)||this).deQueueCount=200,e}return a(e,t),e.prototype.loop=function(){var e=this;(this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length&&(Ee().pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:Re(this.tempQueue),options:Fe(this.tempQueue),lineStrings:this.tempQueue.map((function(t){return t.lineString})),callback:function(t){e.pushResult(t)}}),this.reset());t.prototype.loop.call(this)},e}(Ge),We=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.loop=function(){var e=this;if(this.tempQueue.length){var n=Ee();this.tempQueue.forEach((function(t){n.pushQueue({id:t.id,type:"Lines",layer:t.layer,data:t.data,key:t.key,lineStrings:t.lineStrings,center:t.center,callback:function(t){e.pushResult(t)}})})),this.reset()}t.prototype.loop.call(this)},e}(Ge),qe=function(t){function e(){var e;return(e=t.call(this)||this).deQueueCount=100,e}return a(e,t),e.prototype.loop=function(){var e=this;(this.getCurrentTime()-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length&&(Ee().pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:Re(this.tempQueue),options:Fe(this.tempQueue),lineStrings:this.tempQueue.map((function(t){return t.lineString})),callback:function(t){e.pushResult(t)}}),this.reset());t.prototype.loop.call(this)},e}(Ge),Ne=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.loop=function(){var e=this;if(this.tempQueue.length){var n=Ee();this.tempQueue.forEach((function(t){n.pushQueue({id:t.id,type:"FatLines",layer:t.layer,data:t.data,key:t.key,lineStrings:t.lineStrings,center:t.center,callback:function(t){e.pushResult(t)}})})),this.reset()}t.prototype.loop.call(this)},e}(Ge),Ke=new Ze,Xe=new De,Ye=new He,$e=new Je,tn=new Qe,en=new We,nn=new qe,rn=new Ne,on={isRunning:!1,loop:function(){Ke.loop(),Xe.loop(),Ye.loop(),$e.loop(),tn.loop(),en.loop(),nn.loop(),rn.loop(),i.Util.requestAnimFrame(on.loop)},star:function(){on.isRunning||(on.isRunning=!0,on.loop())}};function an(t){var e=[];return t&&t.length&&t.forEach((function(t){t=t instanceof o.Color?t:new o.Color(t),e.push(t.r,t.g,t.b)})),e}var sn={altitude:0,bottomHeight:0,colors:null},un=function(t){function e(e,n,r,a){var s;n=i.Util.extend({},sn,n,{layer:a,lineString:e}),(s=t.call(this)||this)._initOptions(n);var c,f=je(e),d=f.lineStrings,v=f.center;if(n.asynchronous){c=ke();var p=i.Util.GUID();s.getOptions().id=p,s.getOptions().center=v,tn.push({id:p,data:d,layer:a,key:n.key,lineString:e,baseObject:u(s)})}else{for(var g=[],y=0,x=d.length;y<x;y++){var m=Oe(d[y],a,v,!1).positions;g.push(Ce(m))}var b=Te(g);l(c=new o.BufferGeometry,"position",new o.BufferAttribute(b,3)),le(c,n.bottomHeight,a);var _=an(n.colors);_&&_.length&&(l(c,"color",new o.Float32BufferAttribute(_,3)),r.vertexColors=h())}s._createLineSegments(c,r);var w=n.altitude,M=a.distanceToVector3(w,w).x,O=a.coordinateToVector3(v,M);return s.getObject3d().position.copy(O),s.type="Line",s}return a(e,t),e.prototype._workerLoad=function(t){var e=new o.BufferGeometry;l(e,"position",new o.BufferAttribute(new Float32Array(t.position),3));var n=an(this.getOptions().colors),r=this.getObject3d(),i=r.material;n&&n.length&&(l(e,"color",new o.Float32BufferAttribute(n,3)),i.vertexColors=h()),this._computeLineDistances(e),r.geometry=e,r.material.needsUpdate=!0,this._fire("workerload",{target:this})},e}(_),cn={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"},ln=function(t){function e(e,n,r,o){var a;n=i.Util.extend({},cn,n,{layer:o,lineString:e}),(a=t.call(this)||this)._initOptions(n);var s,c=n,l=c.height,f=c.width,d=c.bottomColor,v=c.topColor,p=c.bottomHeight,g=c.altitude,y=c.asynchronous,x=o.distanceToVector3(l,l).x,m=o.distanceToVector3(f,f).x,b=je(e),_=b.lineStrings,M=b.center;if(y){s=j();var O=i.Util.GUID();a.getOptions().id=O,a.getOptions().center=M,Ye.push({id:O,data:_,layer:o,center:M,lineString:e,baseObject:u(a)})}else{for(var S=[],A=0,C={},T=0,L=_.length;T<L;T++){var k=Ae(_[T],m,x,o,M);A=le(k,p,o,C),S.push(k)}s=w(S),v&&(ye(s,d,v,A+x/2),r.vertexColors=h())}a._createMesh(s,r);var P=o.distanceToVector3(g,g).x,B=o.coordinateToVector3(M,P);return a.getObject3d().position.copy(B),a.type="ExtrudeLine",a}return a(e,t),e.prototype._workerLoad=function(t){var e=S(t),n=this.getOptions(),r=n.topColor,i=n.bottomColor,o=n.bottomHeight,a=n.height,s=this.getObject3d(),u=s.material;if(r){var c=this.getLayer();ye(e,i,r,c.distanceToVector3(o,o).x+c.distanceToVector3(a,a).x/2),u.vertexColors=h()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})},e}(_),hn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},fn=function(t){function e(e,n,r,o){var a;n=i.Util.extend({},hn,n,{layer:o,polygon:e}),(a=t.call(this)||this)._initOptions(n);var s,c=n,l=c.height,f=c.topColor,d=c.bottomColor,v=c.altitude,p=c.bottomHeight,g=c.asynchronous,y=Z(e)?W(e):e.getCenter();if(g){s=j();var x=i.Util.GUID();a.getOptions().id=x,a.getOptions().center=y,Ke.push({data:e,layer:o,id:x,baseObject:u(a)})}else{var m=le(s=pe(e,l,o),p,o);if(f)ye(s,d,f,m+o.distanceToVector3(l,l).x/2),r.vertexColors=h()}a._createMesh(s,r);var b=o.distanceToVector3(v,v).x,_=o.coordinateToVector3(y,b);return a.getObject3d().position.copy(_),a.type="ExtrudePolygon",a}return a(e,t),e.prototype._workerLoad=function(t){var e=S(t),n=this.getOptions(),r=n.topColor,i=n.bottomColor,o=n.bottomHeight,a=n.height,s=this.getObject3d(),u=s.material;if(r){var c=this.getLayer();ye(e,i,r,c.distanceToVector3(o,o).x+c.distanceToVector3(a,a).x/2),u.vertexColors=h()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})},e}(_),dn={altitude:0,coordinate:null},vn=function(t){function e(e,n,r){var o;void 0===n&&(n={}),n.coordinate||(console.warn("coordinate is null,it is important to locate the model"),n.coordinate=r.getMap().getCenter()),n=i.Util.extend({},dn,n,{layer:r,model:e}),(o=t.call(this)||this)._initOptions(n),o._createGroup(),o.getObject3d().add(e);var a=n,s=a.altitude,u=a.coordinate,c=r.distanceToVector3(s,s).x,l=r.coordinateToVector3(u,c);return o.getObject3d().position.copy(l),o.type="Model",o}return a(e,t),e}(_),pn=Math.PI/180;function gn(t){return t.getCoordinates().map((function(t){return t.toArray()}))}function yn(t){return t*pn}function xn(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());var n=yn(t[1]),r=yn(e[1]),i=n-r,o=yn(t[0])-yn(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(o/2),2))),n*=6378137,Math.round(1e5*n)/1e5}function mn(t,e){var n=t.len,r=t.c1,i=t.c2,o=i[0]-r[0],a=i[1]-r[1],s=e/n;return[r[0]+s*o,r[1]+s*a]}function bn(t,e){void 0===e&&(e=10),e=Math.max(e,1),Array.isArray(t)||(t=gn(t));for(var n=t.length,r=[],i=0,o=0;o<n-1;o++){var a=xn(t[o],t[o+1]),s=Math.floor(a);r.push({c1:t[o],len:s,c2:t[o+1]}),i+=s}if(i<=e)return r.map((function(t){return[t.c1,t.c2]}));if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];for(var u,c=r.length,l=0,h=0,f=[],d=[r[0].c1];l<c;){var v=r[l],p=v.len,g=v.c2;if((h+=p)<e&&(d.push(g),l===c-1&&f.push(d),l++),h===e&&(d.push(g),h=0,f.push(d),d=[g],l++),h>e){var y=p-h+e;u=mn(r[l],y),d.push(u),f.push(d),h=0,r[l].c1=u,r[l].len=p-y,(d=[]).push(u)}}return f}var _n=Object.freeze({__proto__:null,distance:xn,lineLength:function(t){var e=t;Array.isArray(t)||(e=gn(t));for(var n=0,r=0,i=e.length;r<i-1;r++)n+=xn(e[r],e[r+1]);return n},lineSlice:bn}),wn=1e3;function Mn(t,e,n,r){var i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;for(var o=t.attributes.position.array,a=t.attributes.normal.array,s=0;s<i;s++)o[s]=e[s],a[s]=n[s];t.index.count=r.length;for(var u=0,c=r.length;u<c;u++)t.index.array[u]=r[u]}var On={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1},Sn=function(t){function e(e,n,r,a){var s;n=i.Util.extend({},On,n,{layer:a,lineString:e}),(s=t.call(this)||this)._initOptions(n);var u,c,h=n,f=h.width,d=h.height,v=h.altitude,p=h.speed,g=h.chunkLength,y=h.trail;G(e)?(u=W(e),c=Q(e)):(u=e.getCenter(),c=e);for(var x=bn(c,g),m=a.coordinateToVector3(u),b={},_=0,w=x.length;_<w;_++)for(var M=x[_],O=0,S=M.length;O<S;O++){var A=M[O],j=A.join(",").toString();b[j]||(b[j]=a.coordinateToVector3(A).sub(m))}var C=Se(x.slice(0,1),a,b,m).positionsV,T=new o.BufferGeometry,L=new Float32Array(3e3),k=new Float32Array(3e3),P=new Uint16Array(wn);l(T,"position",new o.BufferAttribute(L,3)),l(T,"normal",new o.BufferAttribute(k,3)),T.setIndex(new o.BufferAttribute(P,1));var B=a.distanceToVector3(f,f).x,z=a.distanceToVector3(d,d).x,E=Ae(C,B,z,a);Mn(T,E.position,E.normal,E.indices),s._createMesh(T,r);var V=a.distanceToVector3(v,v).x,U=a.coordinateToVector3(u,V);return s.getObject3d().position.copy(U),s._params={index:0,chunkLines:x,geometries:[],layer:a,trail:Math.max(1,y),lineWidth:B,depth:z,speed:Math.min(1,p),idx:0,loaded:!1,positionMap:b,centerPt:m},s._init(s._params),s.type="ExtrudeLineTrail",s}a(e,t);var n=e.prototype;return n._init=function(t){for(var e=t.layer,n=t.trail,r=t.lineWidth,i=t.depth,o=t.chunkLines,a=t.positionMap,s=t.centerPt,u=o.length,c=[],l=0;l<u;l++){var h=Se(o.slice(l,l+n),e,a,s).positionsV;c.push(Ae(h,r,i,e))}this._params.geometries=c,this._params.loaded=!0},n._animation=function(){var t=this._params,e=t.index,n=t.geometries,r=t.speed,i=t.idx,o=t.chunkLines,a=t.trail,s=t.lineWidth,u=t.depth,c=t.loaded,l=t.layer,h=t.positionMap,f=t.centerPt;if(c){var d=Math.round(e);if(d>i){this._params.idx++;var v=n[d];if(!v)v=Ae(Se(o.slice(d,d+a),l,h,f).positionsV,s,u,l),n[d]=v;var p=this.getObject3d();Mn(p.geometry,v.position,v.normal,v.indices),p.geometry.attributes.position.needsUpdate=!0,p.geometry.attributes.normal.needsUpdate=!0,p.geometry.index.needsUpdate=!0}e>=o.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=r}},e}(_),An=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),jn=new o.MeshBasicMaterial;jn.vertexColors=h();var Cn=function(t){return function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var n=e.prototype;return n._initBaseObjectsEvent=function(t){if(t&&Array.isArray(t)&&t.length)for(var e=0,n=t.length;e<n;e++){var r=t[e];this._proxyEvent(r)}return this},n._proxyEvent=function(t){var e=this;t.on("add",(function(t){e._showGeometry(t.target,!0)})),t.on("remove",(function(t){e._showGeometry(t.target,!1)})),t.on("mouseout",(function(t){e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))})),t.on(An,(function(t){e.fire(t.type,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}))}))},n._getHideGeometryIndex=function(t){for(var e=[],n=0,r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}},n._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,a=0;a<i;a++)t.array[a]=r[a];var s=NaN;this.getObject3d()instanceof o.LineSegments&&(s=0);for(var u=0;u<n.length;u++)for(var c=n[u],l=this._geometriesAttributes[c][e],h=l.start,f=l.end,d=h;d<f;d++)t.array[d]=s;return this},n._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this},n.getSelectMesh=function(){var t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}},n._getIndex=function(t){return null==t&&(t=this.faceIndex||this.index),t},n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",(function(){e.add(t.pickObject3d)})),this.on("remove",(function(){e.remove(t.pickObject3d)}))},n._setPickObject3d=function(){for(var t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=n.length,i=he(n),a=0,s=0;s<r;s++){var u=e.getColor(),c=u.getHex();this._colorMap[c]=s;var h=n[s].position.count;this._datas[s].colorIndex=c;for(var f=0;f<h;f++)i[a]=u.r,i[a+1]=u.g,i[a+2]=u.b,a+=3}l(t,"color",new o.BufferAttribute(i,3,!0));var d=e.getColor().getHex(),v=new o.Mesh(t,jn);v.position.copy(this.getObject3d().position),v._colorIndex=d,this.setPickObject3d(v)},e}(t)},Tn={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},Ln=new i.Coordinate(0,0),kn=function(t){function e(e,n,r,o){var a;Array.isArray(e)||(e=[e]);var s=e.length;0===s&&console.error("polygons is empty");for(var c=1/0,l=1/0,f=-1/0,d=-1/0,v=0;v<s;v++){var p=e[v],g=p.getCenter?p.getCenter():W(p,Ln),y=void 0,x=void 0;Array.isArray(g)?(y=g[0],x=g[1]):g instanceof i.Coordinate&&(y=g.x,x=g.y),c=Math.min(c,y),l=Math.min(l,x),f=Math.max(f,y),d=Math.max(d,x)}var m,b=new i.Coordinate((c+f)/2,(l+d)/2),_=n=i.Util.extend({},Tn,n,{layer:o,polygons:e,coordinate:b}),M=_.topColor,O=_.bottomColor,S=_.altitude,A=_.asynchronous,C=[],T=[],L=[];if(a=t.call(this)||this,A)m=j(),Xe.push({id:i.Util.GUID(),layer:o,key:n.key,center:b,data:e,baseObject:u(a)});else{for(var k=o.coordinateToVector3(b),P=[],B=0,z=0,E=0,V=0,U={},I=0;I<s;I++){var R=e[I],F=Z(R)?R.properties:R.getProperties()||{},G=F.height||1,D=F.bottomHeight||0,H=ge(R,G,o,b,k,U);P.push(H);var J=le(H,D,o,U),Q=H.position,q=H.normal,N=H.uv,K=H.indices.length/3;T[I]=[B+1,B+K],B+=K;var X=Q.length/3,Y=q.length/3,$=N.length/2;L[I]={position:{middleZ:J+U[G]/2,count:X,start:z,end:z+3*X},normal:{count:Y,start:E,end:E+3*Y},uv:{count:$,start:V,end:V+2*$},hide:!1},z+=3*X,E+=3*Y,V+=2*$}m=w(P),M&&(ye(m,O,M,L),r.vertexColors=h())}a._initOptions(n),a._createMesh(m,r);var tt=o.distanceToVector3(S,S).x,et=o.coordinateToVector3(b,tt);return a.getObject3d().position.copy(et),a._faceMap=T,a._baseObjects=C,a._datas=e,a._geometriesAttributes=L,a.faceIndex=null,a._geometryCache=m.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(C),A||(a._setPickObject3d(),a._init()),a.type="ExtrudePolygons",a}a(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=Object.assign({},this.options,Z(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new fn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n.identify=function(t){return this.picked},n._workerLoad=function(t){var e=t.faceMap,n=t.geometriesAttributes;this._faceMap=e,this._geometriesAttributes=n;var r=S(t);this._geometryCache=A(r);var i=this.getOptions(),o=i.topColor,a=i.bottomColor,s=this.getObject3d(),u=s.material;(o&&(ye(r,a,o,n),u.vertexColors=h()),s.geometry=r,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd)&&this.getLayer().getPick().add(this.pickObject3d);this._fire("workerload",{target:this})},e}(Cn(_));function Pn(t,e,n){var r=t.project(n),i=e.width/2,o=e.height/2;return{x:Math.round(r.x*i+i),y:Math.round(-r.y*o+o)}}var Bn=Object.freeze({__proto__:null,vectors2Pixel:function(t,e,n,r,i){return void 0===r&&(r=0),t[0]instanceof o.Vector3||(t=function(t,e,n){void 0===e&&(e=0);for(var r=[],i={},a=0,s=t.length;a<s;a+=3){var u=t[a],c=t[a+1],l=t[a+2];e>0&&(l+=ue(e,n,i)),r.push(new o.Vector3(u,c,l))}return r}(t,r,i)),t.map((function(t){return Pn(t,e,n)}))},vector2Pixel:Pn}),zn={altitude:0,height:0,color:null},En=new o.Vector3,Vn=function(t){function e(e,n,r,a){var s;n=i.Util.extend({},zn,n,{layer:a,coordinate:e}),s=t.call(this)||this;var u=n,c=u.height,h=u.altitude,f=u.color,d=u.size,v=[],p=[];f&&(f=f instanceof o.Color?f:new o.Color(f),p.push(f.r,f.g,f.b));var g=a.distanceToVector3(c,c).x,y=a.coordinateToVector3(e,g);v.push(0,0,y.z);var x=new o.BufferGeometry;l(x,"position",new o.Float32BufferAttribute(v,3,!0)),p.length&&l(x,"color",new o.Float32BufferAttribute(p,3,!0)),void 0!==d&&l(x,"size",new o.Float32BufferAttribute([d],1,!0)),n.positions=y,s._initOptions(n),s._createPoints(x,r);var m=a.distanceToVector3(h,h).x,b=new o.Vector3(y.x,y.y,m);return s.getObject3d().position.copy(b),s.type="Point",s}return a(e,t),e.prototype.identify=function(t){var e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,o=this.getOptions().altitude,a=this.getObject3d().material.size;void 0===a&&(a=this.options.size||1);var s=this.getMap().coordToContainerPoint(t),u=e.distanceToVector3(o,o).x;En.x=i.x,En.y=i.y,En.z=i.z+u;var c=Pn(En,n,r);return Math.sqrt(Math.pow(s.x-c.x,2)+Math.pow(s.y-c.y,2))<=a/2},e}(_);function Un(t,e){var n=t.minx,r=t.miny,i=t.maxx,o=t.maxy,a=e[0],s=e[1];return n<=a&&a<=i&&r<=s&&s<=o}var In=function(){function t(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}var e=t.prototype;return e.updateBBoxPixel=function(t){var e=1/0,n=1/0,r=-1/0,o=-1/0,a=this.minlng,s=this.minlat,u=this.maxlng,c=this.maxlat;return[[a,s],[a,c],[u,s],[u,c]].map((function(t){return new i.Coordinate(t)})).map((function(e){return t.coordToContainerPoint(e)})).forEach((function(t){e=Math.min(e,t.x),n=Math.min(n,t.y),r=Math.max(r,t.x),o=Math.max(o,t.y)})),this.minx=e,this.miny=n,this.maxx=r,this.maxy=o,this},e.containsCoordinate=function(t){var e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof i.Coordinate&&(e=t.x,n=t.y);var r=this.minlng,o=this.minlat,a=this.maxlng,s=this.maxlat;return r<=e&&e<=a&&o<=n&&n<=s},e.isRecCross=function(t,e){var n=t.x,r=t.y,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},o=i.minx,a=i.miny,s=i.maxx,u=i.maxy;return!!(Un(this,[o,a])||Un(this,[o,u])||Un(this,[s,a])||Un(this,[s,u])||Un(i,[this.minx,this.miny])||Un(i,[this.minx,this.maxy])||Un(i,[this.maxx,this.miny])||Un(i,[this.maxx,this.maxy]))},t.initGrids=function(e,n,r,i){for(var o=[],a=(r-e)/30,s=(i-n)/30,u=e,c=n,l=0;l<30;l++){u=e+l*a;for(var h=0;h<30;h++){var f=new t(u,c=n+h*s,u+a,c+s);f.key=h+"-"+l,o.push(f)}}return{grids:o,averageX:a,averageY:s,ROWS:30,COLS:30}},t}(),Rn={altitude:0},Fn=new o.Vector3;function Gn(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var Zn=function(t){function e(e,n,r,a){var s;Array.isArray(e)||(e=[e]),n=i.Util.extend({},Rn,n,{layer:a,points:e});for(var u=1/0,c=1/0,h=-1/0,f=-1/0,d=0,v=e.length;d<v;d++){var p=e[d].coordinate,g=void 0,y=void 0;Array.isArray(p)?(g=p[0],y=p[1]):p instanceof i.Coordinate&&(g=p.x,y=p.y),e[d].coords=[g,y],u=Math.min(u,g),c=Math.min(c,y),h=Math.max(h,g),f=Math.max(f,y)}var x=a.coordinateToVector3([(u+h)/2,(c+f)/2]),m=In.initGrids(u,c,h,f),b=m.grids,_=m.averageX,w=m.averageY,M=m.ROWS;m.COLS,b.length;for(var O=new Float32Array(3*e.length),S=[],A=new Float32Array(3*e.length),j=new Float32Array(e.length),C=[],T=[],L={},k=0,P=!1,B=!1,z=new o.Vector3(0,0,0),E=0,V=e.length;E<V;E++){var U=e[E],I=U.coordinate,R=U.height,F=U.color,G=U.size,Z=U.coords,D=3*E;F&&(P=!0,F=F instanceof o.Color?F:new o.Color(F),A[D]=F.r,A[D+1]=F.g,A[D+2]=F.b),G&&(B=!0,j[E]=G,k=Math.max(k,G));var H=ue(R,a,L),J=a.coordinateToVector3(I,H);z.x=J.x,z.y=J.y,z.z=J.z,z.sub(x),O[D]=z.x,O[D+1]=z.y,O[D+2]=z.z,S.push(J),T[E]={position:{count:1,start:3*E,end:3*E+3},hide:!1};var Q=Gn((Z[1]-c)/w,4),W=Gn((Z[0]-u)/_,4);Q-=1,W-=1,Q=Math.max(0,Q),W=Math.max(0,W),Q=Math.ceil(Q);var q=(W=Math.ceil(W))*M+Q;b[q]&&(b[q].positions.push(J),b[q].indexs.push(E))}var N=new o.BufferGeometry;l(N,"position",new o.BufferAttribute(O,3,!0)),P&&l(N,"color",new o.BufferAttribute(A,3,!0)),B&&l(N,"size",new o.BufferAttribute(j,1,!0)),n.positions=S,(s=t.call(this)||this)._initOptions(n),s._createPoints(N,r);var K=n.altitude,X=a.distanceToVector3(K,K).x,Y=x.clone();return Y.z=X,s.getObject3d().position.copy(Y),s._baseObjects=C,s._datas=e,s.faceIndex=null,s._geometriesAttributes=T,s._geometryCache=N.clone(),s.isHide=!1,s._initBaseObjectsEvent(C),s._grids=b,s._bindMapEvents(),s.type="Points",s.maxSize=k,s}a(e,t);var n=e.prototype;return n._bindMapEvents=function(){var t=this,e=this.getMap(),n="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",(function(){t._updateGrids(),e.on(n,t._updateGrids,t)})),this.on("remove",(function(){e.off(n,t._updateGrids,t)}))},n._updateGrids=function(){var t=this.getMap();this._grids.forEach((function(e){e.indexs.length&&e.updateBBoxPixel(t)}))},n.getSelectMesh=function(){var t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=e.coordinate,r=e.height,i=e.color,o=e.size;this._baseObjects[t]=new Vn(n,{height:r,index:t,color:i,size:o},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n.identify=function(t){var e=this,n=this.getLayer(),r=this.getMap().getSize(),i=this.getLayer().getCamera(),o=this.getOptions().altitude,a=this.getMap(),s=n.distanceToVector3(o,o).x,u=this.getObject3d().material.size,c=void 0===u,l=a.coordToContainerPoint(t),h=[];if(this._grids.forEach((function(t){t.indexs.length&&t.isRecCross(l,c?e.maxSize:u)&&h.push(t)})),h.length<1)return!1;for(var f=0,d=h.length;f<d;f++)for(var v=h[f].positions.length-1;v>=0;v--){c&&(u=this._datas[h[f].indexs[v]].size||1);var p=h[f].positions[v];Fn.x=p.x,Fn.y=p.y,Fn.z=p.z+s;var g=Pn(Fn,r,i);if(Math.sqrt(Math.pow(l.x-g.x,2)+Math.pow(l.y-g.y,2))<=u/2)return this.faceIndex=h[f].indexs[v],!0}return!1},e}(Cn(_)),Dn={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"},Hn=function(t){function e(e,n,r,o){var a;Array.isArray(e)||(e=[e]);for(var s=e.length,u=ce(e),c=o.coordinateToVector3(u),l=[],f=[],d=[],v=[],p=0,g=0,y=0,x=0,m={},b=0;b<s;b++){var _=i.Util.extend({index:b},Dn,e[b]),w=_.radius,M=_.radialSegments,O=_.altitude,S=_.topColor,A=_.bottomColor,j=_.height,C=_.coordinate,T=ue(w,o,m),L=ue(j,o,m),k=ue(O,o,m),P=B({radius:T,height:L,radialSegments:M});S&&(z(P,A,S,"z",L/2),r.vertexColors=h());for(var V=o.coordinateToVector3(C).sub(c),U=P.attributes.position.array,R=0,F=U.length;R<F;R+=3)U[R+2]+=k,U[R]+=V.x,U[R+1]+=V.y,U[R+2]+=V.z;l.push(P);var G=new I(C,_,r,o);f.push(G);var Z=P.index.count/3;v[b]=[p+1,p+Z],p+=Z;var D=P.attributes.position.count,H=P.attributes.normal.count,J=P.attributes.uv.count;d[b]={position:{count:D,start:g,end:g+3*D},normal:{count:H,start:y,end:y+3*H},uv:{count:J,start:x,end:x+2*J},hide:!1},g+=3*D,y+=3*H,x+=2*J}a=t.call(this)||this,n=i.Util.extend({},{altitude:0,layer:o,points:e},n),a._initOptions(n);var Q=E(l);a._createMesh(Q,r);var W=n.altitude,q=o.distanceToVector3(W,W).x,N=c.clone();return N.z=q,a.getObject3d().position.copy(N),a._faceMap=v,a._baseObjects=f,a._datas=e,a._geometriesAttributes=d,a.faceIndex=null,a._geometryCache=Q.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(f),a._setPickObject3d(),a._init(),a.type="Bars",a}return a(e,t),e.prototype.identify=function(){return this.picked},e}(Cn(_)),Jn={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"},Qn=function(t){function e(e,n,r,o){var a;Array.isArray(e)||(e=[e]);for(var s=[],c=[],l=e.length,f=0;f<l;f++){var d=je(e[f]);s.push(d.center),c.push(d.lineStrings)}var v,p=ce(s),g=n=i.Util.extend({},Jn,n,{layer:o,lineStrings:e,coordinate:p}),y=g.altitude,x=g.topColor,m=g.bottomColor,b=g.asynchronous,_=[],O=[];if(a=t.call(this)||this,b)v=j(),$e.push({id:i.Util.GUID(),layer:o,key:n.key,center:p,data:c,lineStrings:e,baseObject:u(a)});else{for(var S=[],A=0,C=[],T=0,L=0,k={},P=0;P<l;P++){for(var B=e[P],z=i.Util.extend({},Jn,G(B)?B.properties:B.getProperties(),{index:P}),E=z.height,V=z.width,U=z.bottomHeight,I=ue(V,o,k),R=ue(E,o,k),F=c[P],Z=[],D=0,H=0,J=F.length;H<J;H++){var Q=Ae(F[H],I,R,o,p);D=le(Q,U,o,k),Z.push(Q)}var W=M(Z);S.push(W);var q=W.position,N=W.normal,K=W.indices.length/3;C[P]=[A+1,A+K],A+=K;var X=q.length/3,Y=N.length/3;O[P]={position:{middleZ:D+R/2,count:X,start:T,end:T+3*X},normal:{count:Y,start:L,end:L+3*Y},hide:!1},T+=3*X,L+=3*Y}v=w(S),x&&(ye(v,m,x,O),r.vertexColors=h())}a._initOptions(n),a._createMesh(v,r);var $=o.distanceToVector3(y,y).x,tt=o.coordinateToVector3(p,$);return a.getObject3d().position.copy(tt),a._faceMap=[],a._baseObjects=_,a._datas=e,a._geometriesAttributes=O,a.faceIndex=null,a._geometryCache=v.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(_),b||(a._setPickObject3d(),a._init()),a.type="ExtrudeLines",a}a(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=Object.assign({},this.options,D(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new ln(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n.identify=function(t){return this.picked},n._workerLoad=function(t){var e=t.faceMap,n=t.geometriesAttributes;this._faceMap=e,this._geometriesAttributes=n;var r=S(t);this._geometryCache=A(r);var i=this.getOptions(),o=i.topColor,a=i.bottomColor;i.bottomHeight,i.height;var s=this.getObject3d().material;(o&&(ye(r,a,o,n),s.vertexColors=h()),this.getObject3d().geometry=r,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd)&&this.getLayer().getPick().add(this.pickObject3d);this._fire("workerload",{target:this})},e}(Cn(_)),Wn={altitude:0,colors:null},qn=function(t){function e(e,n,r,a){var s;Array.isArray(e)||(e=[e]);for(var c=[],h=[],f=e.length,d=0;d<f;d++){var v=je(e[d]);c.push(v.center),h.push(v.lineStrings)}var p=ce(c);n=i.Util.extend({},Wn,n,{layer:a,lineStrings:e,coordinate:p}),(s=t.call(this)||this)._initOptions(n);var g,y=n.asynchronous,x=[],m={},b=0,_=[],w=[],M=0,O=[];if(y)g=ke(),en.push({id:i.Util.GUID(),layer:a,key:n.key,center:p,data:h,lineStrings:e,baseObject:u(s)});else{for(var S=0;S<f;S++){for(var A=h[S],j=0,C=0,T=A.length;C<T;C++){var L=D(A[C])?A[C].properties:A[C].getProperties()||{},k=Oe(A[C],a,p,!1).positions;le(k,L.bottomHeight,a,m),j+=k.length/3*2-2,O.push(Ce(k))}var P=j;_[S]=[b,b+P],b+=P,w[S]={position:{count:j,start:M,end:M+3*j},hide:!1},M+=3*j}var B=Te(O);l(g=new o.BufferGeometry,"position",new o.BufferAttribute(B,3))}s._createLineSegments(g,r);var z=n.altitude,E=a.distanceToVector3(z,z).x,V=a.coordinateToVector3(p,E);return s.getObject3d().position.copy(V),s._faceMap=_,s._baseObjects=x,s._datas=e,s._geometriesAttributes=w,s.faceIndex=null,s.index=null,s._geometryCache=g.clone(),s.isHide=!1,s._colorMap={},s._initBaseObjectsEvent(x),y||(s._setPickObject3d(),s._init()),s.type="Lines",s}a(e,t);var n=e.prototype;return n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=i.Util.extend({},this.getOptions(),{index:t},D(e)?e.properties:e.getProperties());this._baseObjects[t]=new un(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n._setPickObject3d=function(){for(var t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),n=this._geometriesAttributes,r=n.length,i=he(n),a=0,s=0;s<r;s++){var u=e.getColor(),c=u.getHex();this._colorMap[c]=s;var f=n[s].position.count;this._datas[s].colorIndex=c;for(var d=0;d<f;d++)i[a]=u.r,i[a+1]=u.g,i[a+2]=u.b,a+=3}l(t,"color",new o.BufferAttribute(i,3,!0));var v=this.getObject3d().material.clone();v.color.set("#fff"),v.vertexColors=h();var p=e.getColor().getHex(),g=new o.LineSegments(t,v);g.position.copy(this.getObject3d().position),g._colorIndex=p,this.setPickObject3d(g)},n.identify=function(t){return this.picked},n._workerLoad=function(t){var e=t.position,n=t.faceMap,r=t.geometriesAttributes;this._faceMap=n,this._geometriesAttributes=r;var i=new o.BufferGeometry;(l(i,"position",new o.BufferAttribute(new Float32Array(e),3)),this._computeLineDistances(i),this._geometryCache=i.clone(),this.getObject3d().geometry=i,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd)&&this.getLayer().getPick().add(this.pickObject3d);this._fire("workerload",{target:this})},e}(Cn(_)),Nn=[],Kn=[];function Xn(){return{waitingQueue:Nn,currentQueue:Kn}}function Yn(t,e){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(i){var o=i.key,a=i.callback;if(e===o)return t.splice(n,1),a}}return null}var $n=document.createElement("canvas"),tr=256;function er(t,e){void 0===e&&(e=!1);var n=$n.getContext("2d");if(n.clearRect(0,0,tr,tr),n.save(),e){n.fillStyle="red",n.strokeStyle="rgba(255,0,0,0.4)",n.lineWidth=.2;var r=t||"tile";n.font="18px sans-serif",n.rect(0,0,tr,tr),n.stroke(),n.fillText(r,15,128)}return $n.toDataURL()}function nr(t,e){var n;return void 0===t&&(t=1),void 0===e&&(e=1),"undefined"==typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}$n.width=$n.height=tr;var rr=function(t){function e(e,n){var r;return void 0===n&&(n={}),(r=t.call(this,i.Util.GUID(),i.Util.extend({urlTemplate:e},n))||this)._opts=null,r._layer=null,r.material=null,r.getMaterial=null,r._baseObjectKeys={},r._loadTiles={},r._add=null,r._layerLaodTime=(new Date).getTime(),r}a(e,t);var n=e.prototype;return n.isAsynchronous=function(){return this._opts.worker},n.getBaseObjects=function(){var t=this._loadTiles,e=[];for(var n in t){var r=this._baseObjectKeys[n];if(r&&Array.isArray(r)&&r.length)for(var i=0,o=r.length;i<o;i++)e.push(r[i])}return e},n.onSelectMesh=function(t,e){},n.formatBaseObjects=function(t,e){return[]},n.loopMessage=function(t){},n.getTileData=function(t){var e=t.key,n=t.url,r=t.callback,o=t.img;i.Ajax.getJSON(n,{},(function(t,n){t?(console.error(t),r(e,null,o)):r(e,n,o)}))},n._getCurentTileKeys=function(){for(var t=this.getTiles().tileGrids||[],e=[],n={},r=0,i=t.length;r<i;r++)for(var o=t[r].tiles||[],a=0,s=o.length;a<s;a++){var u=o[a].id;e.push(u),n[u]=!0}return{keys:e,keysMap:n}},n._isLoad=function(){var t=this._getCurentTileKeys().keys,e=Object.keys(this._renderer.tilesInView);return t.length===e.length},n._layerOnLoad=function(){var t=(new Date).getTime();if(!(t-this._layerLaodTime<20)){this._layerLaodTime=t;var e=this._renderer.tilesInView,n=this._loadTiles,r=this._layer,i=this._baseObjectKeys,o=Object.keys(e).length,a=Object.keys(n).length,s=[];if(o&&a)for(var u in n)e[u]||i[u]&&(i[u]||[]).forEach((function(t){s.push(t)}));if(s.length&&r.removeMesh(s,!1),o&&a)for(var c in e)if(!n[c])if(i[c]){var l=i[c];r.addMesh(l)}else{var h=this._getXYZOfIndex(c),f=h.x,d=h.y,v=h.z;this.getTileUrl(f,d,v)}this._loadTiles=Object.assign({},e),this._diffCache()}},n._init=function(){},n._workerLoad=function(t){var e=t.target._img;e.currentCount++,e.currentCount===e.needCount&&(e.src=er(e._key,this._opts.debug))},n._generateBaseObjects=function(t,e,n){var r=this;if(e&&n){if(!this._getCurentTileKeys().keysMap[t])return void(n.src=er(t,this._opts.debug));var i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length,n.currentCount=0;for(var o=0,a=i.length;o<a;o++){var s=i[o];s._img=n,s._vt=this,this.isVisible()||s.hide(),this._cachetile(t,s),s.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=er(t,this._opts.debug)),this.isAsynchronous()?i.filter((function(t){return t.isAsynchronous()})).forEach((function(t){t.on("workerload",r._workerLoad,r)})):n.src=er(t,this._opts.debug)}else n.src=er(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=er(t,this._opts.debug))},n._diffCache=function(){var t=this;Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max&&function(){var e=t._renderer.tileCache.data,n=t._renderer.tilesInView,r=[];for(var i in t._baseObjectKeys)e[i]||n[i]||((t._baseObjectKeys[i]||[]).forEach((function(t){t.isAdd&&r.push(t)})),t._diposeBaseObject(i),delete t._baseObjectKeys[i]);r.length&&t._layer.removeMesh(r,!1)}()},n._diposeBaseObject=function(t){var e=this._baseObjectKeys[t];e&&e.length&&e.forEach((function(t){t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();var e=t._baseObjects;e&&e.length&&e.forEach((function(t){t.getObject3d().geometry.dispose(),t=null})),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null}))},n._cachetile=function(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)},n._getXYZOfIndex=function(t){var e=t.indexOf("_")>-1?"_":"-",n=t.split(e).slice(1,4),r=n[0],i=n[1],o=n[2];return{x:parseInt(i),y:parseInt(r),z:parseInt(o)}},n._getTileExtent=function(t,e,n){var r=this.getMap()._getResolution(n);return this._getTileConfig().getTilePrjExtent(t,e,r)},n._getTileLngLatExtent=function(t,e,n){var r=this._getTileExtent(t,e,n),o=r.getMax(),a=r.getMin(),s=this.getMap().getProjection();return a=s.unproject(a),o=s.unproject(o),new i.Extent(a,o)},e}(i.TileLayer),ir={worker:!1},or=function(t){function e(e,n,r,o){var a;return void 0===n&&(n={}),(a=t.call(this,i.Util.GUID(),i.Util.extend({urlTemplate:e},ir,n))||this)._opts=n,a._layer=o,a.getMaterial=r,a._baseObjectKeys={},a._loadTiles={},a._add=null,a._layerLaodTime=(new Date).getTime(),a._init(),a}a(e,t);var n=e.prototype;return n.formatBaseObjects=function(t,e){var n=this._opts,r=[],a=this.isAsynchronous();for(var s in e){var u=e[s]||{},c=void 0;if(Array.isArray(u)?c=u:"FeatureCollection"===u.type&&(c=u.features),c&&c.length){for(var l=[],h=[],f=[],d=0,v=c.length;d<v;d++){var p=c[d];if(Z(p))l.push(p);else if(D(p))for(var g=q(p),y=0,x=g.length;y<x;y++)h.push(g[y]);else if(H(p))for(var m=q(p),b=0,_=m.length;b<_;b++)f.push(i.Util.extend({},m[b].properties,m[b],{coordinate:Q(m[b])}))}if(l.length){var w=this._getMaterial(s,l,t,u);if(w){var M=this._layer.toExtrudePolygons(l,i.Util.extend({},{topColor:"#fff",layerName:s,asynchronous:a,key:t},n),w);r.push(M)}}if(h.length){var O=this._getMaterial(s,h,t,u);if(O&&(O instanceof o.LineBasicMaterial||O instanceof o.LineDashedMaterial)){var S=this._layer.toLines(h,i.Util.extend({},{layerName:s,asynchronous:a},n),O);r.push(S)}}if(f.length){var A=this._getMaterial(s,f,t,u);if(A&&A instanceof o.PointsMaterial){var j=this._layer.toPoints(f,i.Util.extend({},{layerName:s,asynchronous:a},n),A);r.push(j)}}}}return r},n.loopMessage=function(t){Xn().currentQueue.length>0&&this.getTileData(t)},n._init=function(){var t=this;this.on("layerload",this._layerOnLoad),this.on("add",(function(){if(!1===t._add){var e=t.getBaseObjects();t._layer.addMesh(e)}t._add=!0,t.intervalId=setInterval((function(){t._isLoad()&&!t._layer.getMap().isInteracting()&&t.fire("layerload")}),1e3)})),this.on("remove",(function(){t._add=!1;var e=t.getBaseObjects();t._layer.removeMesh(e),clearInterval(t.intervalId)})),this.on("show",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.show()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.show()}))}})),this.on("hide",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.hide()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.hide()}))}})),this.on("renderercreate",(function(e){e.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},e.renderer.deleteTile=function(t){if(t&&t.image){t.image.onload=null,t.image.onerror=null;var e,n,r=t.info||{};e=r.id,(n=Yn(Nn,e))&&n(e)}},e.renderer.loadTileImage=function(e,n,r){e._key=r,function(t,e,n,r,i){var o={key:t,url:e,callback:n,img:r,vt:i};Kn.length<10?(Kn.push(o),i.loopMessage(o)):Nn.push(o)}(r,n,(function(e,n,r){t._generateBaseObjects(e,n,r),function(t,e){if(Yn(Kn,t),Nn.length){Kn.push(Nn[0]),Nn.splice(0,1);var n=Kn[Kn.length-1];e.loopMessage(n)}}(e,t)}),e,t)}}))},n._getMaterial=function(t,e,n,r){return this.getMaterial&&i.Util.isFunction(this.getMaterial)?this.getMaterial(t,e,n,r):null},e}(rr);function ar(t,e,n,r){var i=function(t,e,n,r){for(var i=t/n,o=e/r,a=-t/2,s=e/2,u=-e/2,c=(n+1)*(r+1),l=new Float32Array(3*c),h=new Float32Array(2*c),f=new Float32Array(3*c),d=new Uint32Array(10*c),v=0,p=0,g=0,y=0;y<=r;y++)for(var x=0;x<=n;x++){var m=a+i*x,b=s-o*y;l[v]=m,l[v+1]=b,l[v+2]=0,f[v]=0,f[v+1]=0,f[v+2]=1;var _=(m-a)/t,w=(b-u)/e;if(h[p]=_,h[p+1]=w,v+=3,p+=2,x<n&&y<r){var M=y*(n+1)+x,O=M+1,S=(n+1)*(y+1)+x,A=S+1;d[g]=M,d[g+1]=S,d[g+2]=O,d[g+3]=S,d[g+4]=A,d[g+5]=O,g+=6}}for(var j=new Uint32Array(g),C=0,T=j.length;C<T;C++)j[C]=d[C];return{position:l,uv:h,normal:f,indexs:j}}(t,e,n,r),a=i.position,s=i.uv,u=i.normal,c=i.indexs,h=new o.BufferGeometry;return l(h,"position",new o.BufferAttribute(a,3)),l(h,"normal",new o.BufferAttribute(u,3)),l(h,"uv",new o.BufferAttribute(s,2)),h.setIndex(new o.BufferAttribute(c,1)),h}var sr=new o.TextureLoader,ur=document.createElement("canvas");function cr(t){return t?("string"==typeof t?(e=new Image).src=t:t instanceof HTMLCanvasElement?(e=new Image).src=t.toDataURL():t instanceof Image&&((e=new Image).src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e):null;var e}var lr={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null},hr=function(t){function e(e,n,r,o){var a,s=n=i.Util.extend({},lr,n,{layer:o,extent:e}),u=s.texture,c=s.image,l=s.altitude,h=s.imageHeight,f=s.imageWidth;c||console.error("not find image"),e instanceof i.Extent||(e=new i.Extent(e));var d=e,v=d.xmin,p=d.ymin,g=d.xmax,y=d.ymax,x=1/0,m=1/0,b=-1/0,_=-1/0;[[v,p],[v,y],[g,y],[g,p]].forEach((function(t){var e=o.coordinateToVector3(t),n=e.x,r=e.y;x=Math.min(n,x),m=Math.min(r,m),b=Math.max(n,b),_=Math.max(r,_)}));var w=Math.abs(b-x),M=Math.abs(_-m),O=cr(c),S=cr(u),A=ar(w,M,f-1,h-1);(a=t.call(this)||this)._initOptions(n),a._createMesh(A,r);var j=o.distanceToVector3(l,l).x,C=o.coordinateToVector3(e.getCenter(),j);return a.getObject3d().position.copy(C),r.transparent=!0,O&&(r.opacity=0,O.onload=function(){for(var t=function(t,e,n){void 0===e&&(e=256),void 0===n&&(n=256),ur.width=e,ur.height=n;var r=ur.getContext("2d");return r.drawImage(t,0,0,e,n),r.getImageData(0,0,e,n).data}(O,f,h),e=0,n={},i=0,a=t.length;i<a;i+=4){var s=ue(.1*(256*t[i]*256+256*t[i+1]+t[i+2])-1e4,o,n);A.attributes.position.array[3*e+2]=s,e++}A.attributes.position.needsUpdate=!0,S?sr.load(S.src,(function(t){r.map=t,r.opacity=1,r.needsUpdate=!0})):r.opacity=1},O.onerror=function(){console.error("not load "+O.src)}),a.type="Terrain",a}return a(e,t),e}(_),fr={scale:1,tileDivisor:4},dr=function(t){function e(e,n,r,o){var a;return void 0===n&&(n={}),(a=t.call(this,i.Util.GUID(),i.Util.extend({urlTemplate:e},fr,n))||this)._opts=n,a._layer=o,a.material=r,a._baseObjectKeys={},a._loadTiles={},a._add=null,a._imgQueue={},a._layerLaodTime=(new Date).getTime(),a._init(),a}a(e,t);var n=e.prototype;return n.isAsynchronous=function(){return!1},n.formatBaseObjects=function(t,e){var n=this.options,r=[],i=n.scale,o=n.tileDivisor,a=this._getXYZOfIndex(t),s=a.x,u=a.y,c=a.z,l=this.getMap().getZoom(),h=this.getTileUrl(s,u,c),f=this.options.tileSize,d=f[0],v=f[1],p=this._getTileLngLatExtent(s,u,c),g=this.material.clone();if(c+1>=Math.round(l)){var y=new hr(p,{image:e,imageWidth:d/o,imageHeight:v/o,texture:h},g,this._layer);y.getObject3d().scale.set(i,i,1),r.push(y)}return r},n.loopMessage=function(t){this.getTileData(t)},n._init=function(){var t=this;this.on("layerload",this._layerOnLoad),this.on("add",(function(){if(!1===t._add){var e=t.getBaseObjects();t._layer.addMesh(e)}t._add=!0,t.intervalId=setInterval((function(){t._isLoad()&&!t._layer.getMap().isInteracting()&&t.fire("layerload")}),1e3)})),this.on("remove",(function(){t._add=!1;var e=t.getBaseObjects();t._layer.removeMesh(e),clearInterval(t.intervalId)})),this.on("show",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.show()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.show()}))}})),this.on("hide",(function(){var e=t.getBaseObjects();for(var n in e.forEach((function(t){t.hide()})),t._baseObjectKeys){(t._baseObjectKeys[n]||[]).forEach((function(t){t.hide()}))}})),this.on("renderercreate",(function(e){e.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e.width,n.height=e.height,n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t.url,t.id),n},e.renderer.deleteTile=function(e){if(e&&e.image){e.image.onload=null,e.image.onerror=null;var n=e.info||{},r=t._imgQueue[n.id];r&&(r.src="",r.onload=null,r.onerror=null,delete t._imgQueue[n.id])}},e.renderer.loadTileImage=function(e,n,r){e._key=r;var i=new Image;t._imgQueue[r]=i;var o={key:r,url:n,rgbImage:i,callback:function(e,n,r){t._generateBaseObjects(e,n,r)},img:e,vt:t};t.loopMessage(o)}}))},e}(rr);
/*!
   * Code from baidu mapv
   * License: BSD-3
   * https://github.com/huiyan-fe/mapv
   *
   */
function vr(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}function pr(t,e,n){var r=gr(n),i=function(t){return t.min||0}(n),o=r-i,a=n.range||null,s=0,u=1024;a&&2===a.length&&(s=(a[0]-i)/o*1024),a&&2===a.length&&(u=(a[1]-i)/o*1024);for(var c,l=n.maxOpacity||.8,h=n.minOpacity||0,f=3,d=t.length;f<d;f+=4)c=4*t[f],t[f]/256>l&&(t[f]=256*l),t[f]/256<h&&(t[f]=256*h),c&&c>=s&&c<=u?(t[f-3]=e[c],t[f-2]=e[c+1],t[f-1]=e[c+2]):t[f]=0}function gr(t){return t.max||100}function yr(t,e,n){var r=gr(n),i=
/*!
   * Code from baidu mapv
   * License: BSD-3
   * https://github.com/huiyan-fe/mapv
   *
   */
function(t){var e=t/2,n=t+e,r=1e4,i=nr(2*n,2*n),o=i.getContext("2d");return o.shadowBlur=e,o.shadowColor="black",o.shadowOffsetX=o.shadowOffsetY=r,o.beginPath(),o.arc(n-r,n-r,t,0,2*Math.PI,!0),o.closePath(),o.fill(),i}(n._size||n.size||13),o=i.width/2,a=i.height/2,s=e,u={};for(var c in s.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/r).toFixed(2);u[n]=u[n]||[],u[n].push(t)})),u)if(!isNaN(c)){var l=u[c];t.beginPath(),n.withoutAlpha||(t.globalAlpha=c),l.forEach((function(e){var n=e.coordinate,s=void 0===e.count?1:e.count;t.globalAlpha=s/r,t.drawImage(i,n[0]-o,n[1]-a)}))}}vr.prototype.setMax=function(t){this.max=t||100},vr.prototype.setMin=function(t){this.min=t||0},vr.prototype.setMaxSize=function(t){this.maxSize=t||35},vr.prototype.setMinSize=function(t){this.minSize=t||0},vr.prototype.initPalette=function(){var t=this.gradient,e=nr(256,1),n=this.paletteCtx=e.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in t)r.addColorStop(parseFloat(i),t[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},vr.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},vr.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,r=this.min;t>n&&(t=n),t<r&&(t=r);var i=4*Math.floor((t-r)/(n-r)*255);return[e[i],e[i+1],e[i+2],e[i+3]]},vr.prototype.getSize=function(t){var e=this.max,n=this.min,r=this.maxSize,i=this.minSize;return t>e&&(t=e),t<n&&(t=n),e>n?i+(t-n)/(e-n)*(r-i):r},vr.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,r=t.height||180,i=nr(n,r),o=i.getContext("2d"),a=o.createLinearGradient(0,r,0,0);for(var s in e)a.addColorStop(parseFloat(s),e[s]);return o.fillStyle=a,o.fillRect(0,0,n,r),i};var xr={draw:function(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var r=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+r+")";var i=nr(t.canvas.width,t.canvas.height),o=i.getContext("2d");o.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var a=new vr({gradient:n.gradient});if(yr(o,e,n),!n.absolute){var s=o.getImageData(0,0,t.canvas.width,t.canvas.height);pr(s.data,a.getImageData(),n),t.putImageData(s,0,0),t.restore()}a=null,i=null}},drawGray:yr,colorize:pr},mr={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},br=2048,_r=function(t){function e(e,n,r,a){var s;Array.isArray(e)||(e=[e]);for(var u=1/0,c=1/0,f=-1/0,d=-1/0,v=[],p=0,g=e.length;p<g;p++){var y=e[p],x=y.coordinate,m=y.lnglat,b=y.xy,_=x||m||b;if(_){var w=a.coordinateToVector3(_);v.push(w);var M=w.x,O=w.y;u=Math.min(u,M),c=Math.min(c,O),f=Math.max(f,M),d=Math.max(d,O)}else console.warn("not find coordinate")}var S=n=i.Util.extend({},mr,n,{layer:a,points:e}),A=S.gridScale,j=S.altitude,C=Math.abs(f-u),T=Math.abs(d-c),L=Math.max(C*A,T*A);L>br&&(console.warn("gridScale: "+A+" it's too big. I hope it's a smaller value,canvas max size is "+"2048* "+br),A=br/(L/A));for(var k=Math.ceil(C*A),P=Math.ceil(T*A),B=k/C,z=P/T,E=[],V=0,U=v.length;V<U;V++){var I=v[V];I.x-=u,I.y-=c,I.x*=B,I.y*=z,I.y=P-I.y,E.push({coordinate:[I.x,I.y],count:e[V].count})}var R=nr(k,P),F=R.getContext("2d");xr.drawGray(F,E,n);for(var G=F.getImageData(0,0,F.canvas.width,F.canvas.height),Z=-1/0,D=new Float32Array(G.data.length/4),H=new Float32Array(G.data.length/4),J=3,Q=G.data.length,W=0;J<Q;J+=4){var q=G.data[J];Z=Math.max(Z,q),H[W]=q,q<=0&&(D[W]=1),W++}var N=new vr({gradient:n.gradient});xr.colorize(G.data,N.getImageData(),n),R=null,F=null;for(var K=ar(C,T,k-1,P-1),X=K.getIndex().array,Y=K.attributes.position.array,$=new Float32Array(Y.length),tt=new Uint32Array(6*Y.length),et=new o.Color,nt=0,rt=0,it=Y.length,ot=0,at=X.length,st=0,ut=G.data.length,ct=0;rt<Math.max(it,at,ut);rt+=3){if(rt<it){var lt=H[ct];lt>0&&(Y[rt+2]=lt/Z)}if(ot<at){var ht=X[ot],ft=X[ot+1],dt=X[ot+2];D[ht]&&D[ft]&&D[dt]||(tt[nt]=ht,tt[nt+1]=ft,tt[nt+2]=dt,nt+=3)}if(st<ut){var vt="rgb("+G.data[st]+","+G.data[st+1]+","+G.data[st+2]+")";et.setStyle(vt),$[ot]=et.r,$[ot+1]=et.g,$[ot+2]=et.b}ot+=3,st+=4,ct++}for(var pt=new Uint32Array(nt),gt=0;gt<nt;gt++)pt[gt]=tt[gt];K.setIndex(new o.BufferAttribute(pt,1)),l(K,"color",new o.BufferAttribute($,3,!0)),r.vertexColors=h(),(s=t.call(this)||this)._initOptions(n),s._createMesh(K,r);var yt=a.distanceToVector3(j,j).x;return s.getObject3d().position.copy(new o.Vector3((u+f)/2,(c+d)/2,yt)),s.type="HeatMap",s}return a(e,t),e}(_),wr=new o.Color,Mr=1,Or=function(){function t(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new o.WebGLRenderTarget(1,1),this.pickingScene=new o.Scene}var e=t.prototype;return e.getColor=function(){return wr.setHex(Mr),Mr++,wr},e.add=function(t){if(t){var e=t._colorIndex;e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this},e.remove=function(t){if(t){var e=t._colorIndex;e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this},e.isEmpty=function(){if(0===this.pickingScene.children.length)return!0;for(var t=0,e=this.pickingScene.children.length;t<e;t++){var n=this.pickingScene.children[t];if(n){var r=n.__parent;if(r&&!0===r.getOptions().interactive)return!1}}return!0},e.pick=function(t){if(t&&!this.isEmpty()){for(var e=this.camera,n=this.renderer,r=this.pickingTexture,i=this.pickingScene,o=this.object3ds,a=this.layer,s=this.pickingScene.children.length,u=0;u<s;u++){var c=this.pickingScene.children[u];c&&c.__parent&&(c.__parent.picked=!1)}var l=a._getRenderer().canvas,h=l.width,f=l.height,d=r.width,v=r.height;h===d&&f===v||r.setSize(h,f),n.setRenderTarget(r),n.clear(),n.render(i,e);var p=new Uint8Array(4),g=t.x,y=t.y,x=window.devicePixelRatio,m=g*x,b=r.height-y*x;n.readRenderTargetPixels(r,Math.round(m),Math.round(b),1,1,p);var _=p[0]<<16|p[1]<<8|p[2],w=o[_];if(w)w.__parent&&(o[_].__parent.picked=!0);else for(var M=0;M<s;M++){var O=this.pickingScene.children[M];if(O&&O.__parent){var S=O.__parent;if(S._colorMap&&null!=S._colorMap[_]){S.picked=!0,S.index=S._colorMap[_];break}}}n.setRenderTarget(null)}},t}(),Sr={bottomHeight:0,altitude:0},Ar=function(t){function e(e,n,r,o){var a;n=i.Util.extend({},Sr,n,{layer:o,lineString:e}),(a=t.call(this)||this)._initOptions(n);var s,c=n.asynchronous,l=je(e),h=l.lineStrings,f=l.center,d=new y;if(c){var v=i.Util.GUID();a.getOptions().id=v,a.getOptions().center=f,nn.push({id:v,data:h,lineString:e,center:f,layer:o,baseObject:u(a)})}else{for(var p=[],g={},x=0,m=h.length;x<m;x++){var b=Oe(h[x],o,f,!1).positions;le(b,n.bottomHeight,o,g),p.push(Ce(b))}s=Te(p),d.setPositions(s)}a._setMaterialRes(o,r),a._createLine2(d,r);var _=n.altitude,w=o.distanceToVector3(_,_).x,M=o.coordinateToVector3(f,w);return a.getObject3d().position.copy(M),c||(a._setPickObject3d(s,r.linewidth),a._init()),a.type="FatLine",a}a(e,t);var n=e.prototype;return n._init=function(){var t=this,e=this.getLayer().getPick();this.on("add",(function(){e.add(t.pickObject3d)})),this.on("remove",(function(){e.remove(t.pickObject3d)}))},n._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},n._setPickObject3d=function(t,e){var n=new y;n.setPositions(t);for(var r=this.getLayer().getPick().getColor(),i=[],o=0,a=t.length/3;o<a;o++)i.push(r.r,r.g,r.b);n.setColors(i);var s=new p({color:"#fff",linewidth:e,vertexColors:h()});this._setMaterialRes(this.getLayer(),s);var u=r.getHex(),c=new x(n,s);c.position.copy(this.getObject3d().position),c._colorIndex=u,this.setPickObject3d(c)},n.identify=function(t){return this.picked},n.setSymbol=function(t){if(t&&t instanceof o.Material){t.needsUpdate=!0;var e=this.getMap().getSize(),n=e.width,r=e.height;t.resolution.set(n,r),this.getObject3d().material=t}return this},n._workerLoad=function(t){var e=new Float32Array(t.position),n=this.getObject3d();(n.geometry.setPositions(e),n.computeLineDistances(),this._setPickObject3d(e,n.material.linewidth),this._init(),this.isAdd)&&this.getLayer().getPick().add(this.pickObject3d);this._fire("workerload",{target:this})},e}(_),jr={altitude:0,colors:null},Cr=function(t){function e(e,n,r,o){var a;Array.isArray(e)||(e=[e]);for(var s=[],c=[],l=e.length,h=0;h<l;h++){var f=je(e[h]);s.push(f.center),c.push(f.lineStrings)}var d=ce(s);n=i.Util.extend({},jr,n,{layer:o,lineStrings:e,coordinate:d}),(a=t.call(this)||this)._initOptions(n);var v,p,g=n.asynchronous,x=new y,m=[],b={},_=0,w=[],M=[],O=0,S=[];if(g)rn.push({id:i.Util.GUID(),data:c,key:n.key,center:d,layer:o,baseObject:u(a),lineStrings:e});else{for(var A=0;A<l;A++){for(var j=c[A],C=0,T=0,L=j.length;T<L;T++){var k=D(j[T])?j[T].properties:j[T].getProperties()||{},P=Oe(j[T],o,d,!1).positions;le(P,k.bottomHeight,o,b),C+=P.length/3*2-2,S.push(Ce(P))}var B=C;w[A]=[_,_+B],_+=B,M[A]={position:{count:C,start:O,end:O+3*C},instanceStart:{count:C,start:O,end:O+3*C},instanceEnd:{count:C,start:O,end:O+3*C},hide:!1},O+=3*C}v=Te(S),x.setPositions(v)}a._setMaterialRes(o,r),a._createLine2(x,r);var z=n.altitude,E=o.distanceToVector3(z,z).x,V=o.coordinateToVector3(d,E);return a.getObject3d().position.copy(V),a._faceMap=w,a._baseObjects=m,a._datas=e,a._geometriesAttributes=M,a.faceIndex=null,a.index=null,a._geometryCache=new y,g||(p=new Float32Array(v),a._geometryCache.setPositions(p)),a._colorMap={},a.isHide=!1,a._initBaseObjectsEvent(m),g||(a._setPickObject3d(p,r.linewidth),a._init()),a.type="FatLines",a}a(e,t);var n=e.prototype;return n._setMaterialRes=function(t,e){var n=t.getMap().getSize(),r=n.width,i=n.height;e.resolution.set(r,i)},n._setPickObject3d=function(t,e){var n=this._geometryCache||new y;n.setPositions(t);for(var r=this.getLayer().getPick(),i=this._geometriesAttributes,o=he(i),a=0,s=0,u=i.length;s<u;s++){var c=r.getColor(),l=c.getHex();this._colorMap[l]=s;var f=i[s].position.count;this._datas[s].colorIndex=l;for(var d=0;d<f;d++)o[a]=c.r,o[a+1]=c.g,o[a+2]=c.b,a+=3}n.setColors(o);var v=new p({color:"#fff",linewidth:e,vertexColors:h()});this._setMaterialRes(this.getLayer(),v);var g=r.getColor().getHex(),m=new x(n,v);m.position.copy(this.getObject3d().position),m._colorIndex=g,this.setPickObject3d(m)},n.identify=function(t){return this.picked},n.setSymbol=function(t){if(t&&t instanceof o.Material){t.needsUpdate=!0;var e=this.getMap().getSize(),n=e.width,r=e.height;t.resolution.set(n,r),this.getObject3d().material=t}return this},n.getSelectMesh=function(){var t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){var e=this._datas[t],n=i.Util.extend({},this.getOptions(),{index:t},D(e)?e.properties:e.getProperties());this._baseObjects[t]=new Ar(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}},n._updateAttribute=function(t,e){for(var n=this._getHideGeometryIndex(e).indexs,r=this._geometryCache.attributes[e].array,i=r.length,o=0;o<i;o++)t.array[o]=r[o];for(var a=0;a<n.length;a++)for(var s=n[a],u=this._geometriesAttributes[s][e],c=u.start,l=u.end,h=c;h<l;h++)t.array[h]=-1e5;return this},n._showGeometry=function(t,e){var n;if(t&&(n=t.getOptions().index),null!=n){var r=this._geometriesAttributes[n];if(r.hide===e)return this;r.hide=e;var i=this.getObject3d().geometry;this._updateAttribute(i.attributes.instanceStart,"instanceStart"),this._updateAttribute(i.attributes.instanceEnd,"instanceEnd"),i.attributes.instanceStart.data.needsUpdate=!0,i.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this},n._workerLoad=function(t){var e=t.faceMap,n=t.geometriesAttributes;this._faceMap=e,this._geometriesAttributes=n;var r=this.getObject3d(),i=new Float32Array(t.position),o=new Float32Array(i);(r.geometry.setPositions(new Float32Array(i)),this._geometryCache.setPositions(o),this._setPickObject3d(o,r.material.linewidth),this._init(),this.isAdd)&&this.getLayer().getPick().add(this.pickObject3d);this._fire("workerload",{target:this})},e}(Cn(_)),Tr={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61"},Lr=function(t){function e(e,n,r,o){var a;n=i.Util.extend({},Tr,n,{layer:o,coordinate:e}),(a=t.call(this)||this)._initOptions(n);var s=n,u=s.height,c=s.radius,l=s.topColor,f=s.bottomColor,d=s.altitude,v=o.distanceToVector3(u,u).x,p=o.distanceToVector3(c,c).x,g=V().clone();g.scale(2*p,2*p,v),l&&(z(g,f,l,"z",v/2),r.vertexColors=h()),a._createMesh(g,r);var y=o.distanceToVector3(d,d).x,x=o.coordinateToVector3(e,y);return a.getObject3d().position.copy(x),a.type="Box",a}return a(e,t),e}(_),kr={radius:10,height:100,altitude:0,topColor:null,bottomColor:"#2d2f61"},Pr=function(t){function e(e,n,r,o){var a;Array.isArray(e)||(e=[e]);for(var s=e.length,u=ce(e),c=o.coordinateToVector3(u),l=[],f=[],d=[],v=[],p=0,g=0,y=0,x=0,m={},b=0;b<s;b++){var _=i.Util.extend({index:b},kr,e[b]),w=_.radius,M=_.altitude,O=_.topColor,S=_.bottomColor,A=_.height,j=_.coordinate,C=ue(w,o,m),T=ue(A,o,m),L=ue(M,o,m),k=V().clone();k.scale(2*C,2*C,T),O&&(z(k,S,O,"z",T/2),r.vertexColors=h());for(var P=o.coordinateToVector3(j).sub(c),B=k.attributes.position.array,U=0,I=B.length;U<I;U+=3)B[U+2]+=L,B[U]+=P.x,B[U+1]+=P.y,B[U+2]+=P.z;l.push(k);var R=new Lr(j,_,r,o);f.push(R);var F=k.index.count/3;v[b]=[p+1,p+F],p+=F;var G=k.attributes.position.count,Z=k.attributes.normal.count,D=k.attributes.uv.count;d[b]={position:{count:G,start:g,end:g+3*G},normal:{count:Z,start:y,end:y+3*Z},uv:{count:D,start:x,end:x+2*D},hide:!1},g+=3*G,y+=3*Z,x+=2*D}a=t.call(this)||this,n=i.Util.extend({},{altitude:0,layer:o,points:e},n),a._initOptions(n);var H=E(l);a._createMesh(H,r);var J=n.altitude,Q=o.distanceToVector3(J,J).x,W=c.clone();return W.z=Q,a.getObject3d().position.copy(W),a._faceMap=v,a._baseObjects=f,a._datas=e,a._geometriesAttributes=d,a.faceIndex=null,a._geometryCache=H.clone(),a.isHide=!1,a._colorMap={},a._initBaseObjectsEvent(f),a._setPickObject3d(),a._init(),a.type="Boxs",a}return a(e,t),e.prototype.identify=function(t){return this.picked},e}(Cn(_));var Br=Math.PI/180,zr=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],Er=["mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],Vr=new i.Coordinate(0,0),Ur=new i.Point(0,0),Ir="__webglFramebuffer",Rr=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this)._animationBaseObjectMap={},r._needsUpdate=!0,r._mousemoveTimeOut=0,r._baseObjects=[],r._delayMeshes=[],r.type="ThreeLayer",r}a(e,t);var n=e.prototype;return n.isMercator=function(){var t=this.getMap();if(!t)return!1;var e=t.getSpatialReference(),n=e._projection,r=e._resolutions;return!!(n&&"EPSG:3857"===n.code&&r&&r.length&&156543===Math.floor(r[0])&&t.getGLRes)},n.isRendering=function(){var t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())},n.prepareToDraw=function(){},n.draw=function(t,e,n,r,i,o){this.renderScene(o,this)},n.drawOnInteracting=function(t,e,n,r,i,o,a){this.renderScene(a,this)},n.coordinateToVector3=function(t,e){void 0===e&&(e=0);var n=this.getMap();if(!n)return null;var r=Array.isArray(t);r?(Vr.x=t[0],Vr.y=t[1]):t instanceof i.Coordinate||(t=new i.Coordinate(t));var a=Gr(n),s=Zr(n,r?Vr:t,a,Ur);return new o.Vector3(s.x,s.y,e)},n.coordinatiesToGLFloatArray=function(t,e){var n=this.getMap();if(!n)return null;for(var r=Gr(n),o=t.length,a=new Float32Array(2*o),s=new Float32Array(3*o),u=0;u<o;u++){var c=t[u],l=Array.isArray(c);l?(Vr.x=c[0],Vr.y=c[1]):c instanceof i.Coordinate||(c=new i.Coordinate(c));var h=Zr(n,l?Vr:c,r,Ur);h.x-=e.x,h.y-=e.y;var f=2*u;a[f]=h.x,a[f+1]=h.y;var d=3*u;s[d]=h.x,s[d+1]=h.y,s[d+2]=0}return{positions:s,positons2d:a}},n.coordinatiesToGLArray=function(t,e){var n=this.getMap();if(!n)return null;for(var r=Gr(n),o=t.length,a=new Array(o),s=0;s<o;s++){var u=t[s],c=Array.isArray(u);c?(Vr.x=u[0],Vr.y=u[1]):u instanceof i.Coordinate||(u=new i.Coordinate(u));var l=Zr(n,c?Vr:u,r,Ur);l.x-=e.x,l.y-=e.y,a[s]=[l.x,l.y]}return a},n.distanceToVector3=function(t,e,n){if(0===t&&0===e||!i.Util.isNumber(t)||!i.Util.isNumber(e))return new o.Vector3(0,0,0);var r=this.getMap(),a=Gr(r),s=n||r.getCenter();s instanceof i.Coordinate||(s=new i.Coordinate(s));var u=r.locate(s,t,e),c=Zr(r,s,a),l=Zr(r,u,a),h=Math.abs(l.x-c.x)*i.Util.sign(t),f=Math.abs(l.y-c.y)*i.Util.sign(e);return new o.Vector3(h,f,0)},n.toShape=function(t){var e=this;if(!t)return null;if(t instanceof i.MultiPolygon)return t.getGeometries().map((function(t){return e.toShape(t)}));var n=t.getCenter(),r=this.coordinateToVector3(n),a=t.getShell().map((function(t){var n=e.coordinateToVector3(t).sub(r);return new o.Vector2(n.x,n.y)})),s=new o.Shape(a),u=t.getHoles();return u&&u.length>0&&(s.holes=u.map((function(t){var n=t.map((function(t){var n=e.coordinateToVector3(t).sub(r);return new o.Vector2(n.x,n.y)}));return new o.Shape(n)}))),s},n.toExtrudeMesh=function(t,e,n,r){var a=this;if(!t)return null;if(t instanceof i.MultiPolygon)return t.getGeometries().map((function(t){return a.toExtrudeMesh(t,e,n,r)}));var s=t.getCoordinates();s.forEach((function(t){for(var e=t.length-1;e>=1;e--)t[e].equals(t[e-1])&&t.splice(e,1)})),t.setCoordinates(s);var u=this.toShape(t),c=this.coordinateToVector3(t.getCenter());r=i.Util.isNumber(r)?r:e,r=this.distanceToVector3(r,r).x;var l=this.distanceToVector3(e,e).x,h={bevelEnabled:!1,bevelSize:1};h[parseInt(o.REVISION)>=93?"depth":"amount"]=r;var f=new o.ExtrudeGeometry(u,h),d=f;o.BufferGeometry.prototype.fromGeometry&&(d=new o.BufferGeometry).fromGeometry(f);var v=new o.Mesh(d,n);return v.position.set(c.x,c.y,l-r),v},n.toExtrudePolygon=function(t,e,n){return new fn(t,e,n,this)},n.toBar=function(t,e,n){return new I(t,e,n,this)},n.toLine=function(t,e,n){return new un(t,e,n,this)},n.toExtrudeLine=function(t,e,n){return new ln(t,e,n,this)},n.toModel=function(t,e){return new vn(t,e,this)},n.toExtrudeLineTrail=function(t,e,n){return new Sn(t,e,n,this)},n.toExtrudePolygons=function(t,e,n){return new kn(t,e,n,this)},n.toPoint=function(t,e,n){return new Vn(t,e,n,this)},n.toPoints=function(t,e,n){return new Zn(t,e,n,this)},n.toBars=function(t,e,n){return new Hn(t,e,n,this)},n.toExtrudeLines=function(t,e,n){return new Qn(t,e,n,this)},n.toLines=function(t,e,n){return new qn(t,e,n,this)},n.toThreeVectorTileLayer=function(t,e,n){return new or(t,e,n,this)},n.toTerrain=function(t,e,n){return new hr(t,e,n,this)},n.toTerrainVectorTileLayer=function(t,e,n){return new dr(t,e,n,this)},n.toHeatMap=function(t,e,n){return new _r(t,e,n,this)},n.toFatLine=function(t,e,n){return new Ar(t,e,n,this)},n.toFatLines=function(t,e,n){return new Cr(t,e,n,this)},n.toBox=function(t,e,n){return new Lr(t,e,n,this)},n.toBoxs=function(t,e,n){return new Pr(t,e,n,this)},n.getBaseObjects=function(){return this.getMeshes().filter((function(t){return t instanceof _}))},n.getMeshes=function(){var t=this.getScene();if(!t)return[];for(var e=[],n=0,r=t.children.length;n<r;n++){var i=t.children[n];i instanceof o.Object3D&&!(i instanceof o.Camera)&&e.push(i.__parent||i)}return e},n.clear=function(){return this.clearMesh()},n.clearMesh=function(){var t=this.getScene();if(!t)return this;for(var e=t.children.length-1;e>=0;e--){var n=t.children[e];if(n instanceof o.Object3D&&!(n instanceof o.Camera)){t.remove(n);var r=n.__parent;r&&r instanceof _&&(r.isAdd=!1,r._fire("remove",{target:r}),delete this._animationBaseObjectMap[n.uuid])}}return this},n.lookAt=function(t){var e=this._getRenderer();return e&&e.context.lookAt(t),this},n.getCamera=function(){var t=this._getRenderer();return t?t.camera:null},n.getScene=function(){var t=this._getRenderer();return t?t.scene:null},n.renderScene=function(t,e){var n=this._getRenderer();return n&&(n.clearCanvas(),n.renderScene(t),e||n.setToRedraw()),this},n.loop=function(t){void 0===t&&(t=!1);var e=this._delayMeshes;if(e.length){var n=this.getMap();if(n&&!n.isAnimating()&&!n.isInteracting()){var r=this.options.loopRenderCount||50,i=e.slice(0,r);i&&this.addMesh(i,t),e.splice(0,r)}}},n.renderPickScene=function(){var t=this._getRenderer();if(t){var e=t.pick;e&&e.pick(this._containerPoint)}return this},n.getThreeRenderer=function(){var t=this._getRenderer();return t?t.context:null},n.getPick=function(){var t=this._getRenderer();return t?t.pick:null},n.delayAddMesh=function(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(var e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this},n.addMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();if(t.forEach((function(t){t instanceof _?(r.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t._fire("add",{target:t})),t._animation&&i.Util.isFunction(t._animation)&&(n._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof o.Object3D&&r.add(t)})),this._zoomend(),e){var a=this._getRenderer();a&&a.setToRedraw()}return this},n.removeMesh=function(t,e){var n=this;if(void 0===e&&(e=!0),!t)return this;Array.isArray(t)||(t=[t]);var r=this.getScene();if(t.forEach((function(t){if(t instanceof _){r.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t._fire("remove",{target:t})),t._animation&&i.Util.isFunction(t._animation)&&delete n._animationBaseObjectMap[t.getObject3d().uuid];var e=n._delayMeshes;if(e.length)for(var a=0,s=e.length;a<s;a++)if(e[a]===t){e.splice(a,1);break}}else t instanceof o.Object3D&&r.remove(t)})),e){var a=this._getRenderer();a&&a.setToRedraw()}return this},n._initRaycaster=function(){return this._raycaster||(this._raycaster=new o.Raycaster,this._mouse=new o.Vector2),this},n.identify=function(t,e){var n=this;if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new i.Coordinate(t)),!(t instanceof i.Coordinate))return console.error("coordinate type is error,it should be Coordinate"),[];var r=this.getMap().coordToContainerPoint(t);this._containerPoint=r;var a=r.x,s=r.y;this._initRaycaster();var u=this._raycaster,l=this._mouse,h=this.getCamera(),f=this.getScene(),d=this.getMap().getSize();if(!f)return[];var v=d.width,p=d.height;l.x=a/v*2-1,l.y=-s/p*2+1,u.setFromCamera(l,h),function(t,e){c>113?t.params.Line.threshold=e:t.linePrecision=e}(u,this._getLinePrecision(this.getMap().getResolution()));var g=[],y=[];f.children.forEach((function(t){var e=t.__parent;if(e&&e.getOptions){var n=e;n.getOptions().interactive&&n.isVisible()&&(n.identify&&i.Util.isFunction(n.identify)?y.push(n):g.push(t))}else(t instanceof o.Mesh||t instanceof o.Group)&&g.push(t)}));var x=[],m=u.intersectObjects(g,!0);m&&Array.isArray(m)&&m.length&&(x=m.map((function(t){var e=t.object,r=(e=n._recursionMesh(e)||{}).__parent||e;return r.faceIndex=t.faceIndex,r.index=t.index,r}))),this.renderPickScene(),y.length&&y.forEach((function(e){e.identify(t)&&x.push(e)}));for(var b=x.length,_=0;_<b;_++)if(x[_])for(var w=_+1;w<b;w++)x[_]===x[w]&&x.splice(w,1);var M=(e=i.Util.extend({},e)).count;return i.Util.isNumber(M)&&M>0?x.slice(0,M):x},n._recursionMesh=function(t){for(;t&&t.parent!==this.getScene();)t=t.parent;return t},n._getLinePrecision=function(t){void 0===t&&(t=10);for(var e=0,n=zr.length;e<n;e++){var r=zr[e],i=r[0],o=r[1];if(t>i)return o}return.01},n._identifyBaseObjectEvents=function(t){if(!this.options.geometryEvents)return this;var e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents)return this;var n=t.type,r=t.coordinate,o=i.Util.now();if(this._mousemoveTimeOut&&"mousemove"===n&&o-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=o,e.resetCursor("default");var a=this.options.identifyCountOnEvent,s=Math.max(0,i.Util.isNumber(a)?a:0);0===s&&(s=1/0);var u=this.identify(r,{count:s}),c=this.getScene();if(0===u.length&&c)for(var l=0,h=c.children.length;l<h;l++){var f=(c.children[l]||{}).__parent;f&&f.fire("empty",Object.assign({},t,{target:f}))}if("mousemove"===n){u.length&&e.setCursor("pointer");var d=[];this._baseObjects&&this._baseObjects.forEach((function(t){var e=!0;u.forEach((function(n){t===n&&(e=!1)})),e&&d.push(t)})),d.forEach((function(e){e&&e instanceof _&&(e.getSelectMesh?e.isHide||(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout",selectMesh:null})),e.closeToolTip()):(e._mouseover=!1,e.fire("mouseout",Object.assign({},t,{target:e,type:"mouseout"})),e.closeToolTip()))})),u.forEach((function(e){if(e instanceof _){e._mouseover||(e.fire("mouseover",Object.assign({},t,{target:e,type:"mouseover",selectMesh:e.getSelectMesh?e.getSelectMesh():null})),e._mouseover=!0),e.fire(n,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null}));var i=e.getToolTip();i&&!i._owner&&i.addTo(e),e.openToolTip(r)}})),this._baseObjects=u}else u.forEach((function(e){if(e instanceof _&&(e.fire(n,Object.assign({},t,{target:e,selectMesh:e.getSelectMesh?e.getSelectMesh():null})),"click"===n)){var i=e.getInfoWindow();i&&!i._owner&&i.addTo(e),e.openInfoWindow(r)}}));return this},n._zoomend=function(){var t=this.getScene();if(t){var e=this.getMap().getZoom();t.children.forEach((function(t){var n=t.__parent;if(n&&n.getOptions){var r=n;r.zoomChange&&i.Util.isFunction(r.zoomChange)&&r.zoomChange(e);var o=r.getMinZoom(),a=r.getMaxZoom();e<o||e>a?(r.isVisible()&&(r.getObject3d().visible=!1),r._zoomVisible=!1):o<=e&&e<=a&&(r._visible&&(r.getObject3d().visible=!0),r._zoomVisible=!0)}}))}},n.onAdd=function(){var e=this;t.prototype.onAdd.call(this);var n=this.map||this.getMap();return n?(Er.forEach((function(t){n.on(t,e._identifyBaseObjectEvents,e)})),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),n.on("zooming zoomend",this._zoomend,this),this):this},n.onRemove=function(){var e=this;t.prototype.onRemove.call(this);var n=this.map||this.getMap();return n?(Er.forEach((function(t){n.off(t,e._identifyBaseObjectEvents,e)})),n.off("zooming zoomend",this._zoomend,this),this):this},n._callbackBaseObjectAnimation=function(){var t=this;if(t._animationBaseObjectMap)for(var e in t._animationBaseObjectMap){t._animationBaseObjectMap[e]._animation()}return this},n._getFovRatio=function(){var t=this.getMap().getFov();return Math.tan(t/2*Br)},e}(i.CanvasLayer);Rr.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50});var Fr=function(t){function e(){var e;return(e=t.apply(this,arguments)||this)._renderTime=0,e._renderTarget=null,e}a(e,t);var n=e.prototype;return n.getPrepareParams=function(){return[this.scene,this.camera]},n.getDrawParams=function(){return[this.scene,this.camera]},n._drawLayer=function(){t.prototype._drawLayer.apply(this,arguments)},n.hitDetect=function(){return!1},n.createCanvas=function(){t.prototype.createCanvas.call(this),this.createContext()},n.createContext=function(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{var t=this.layer.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};t.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,t)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)},n._initThreeRenderer=function(){this.matrix4=new o.Matrix4;var t=new o.WebGLRenderer({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new o.Color(1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;var e=this.scene=new o.Scene,n=this.layer.getMap(),r=n.getFov()*Math.PI/180,i=this.camera=new o.PerspectiveCamera(r,n.width/n.height,n.cameraNear,n.cameraFar);i.matrixAutoUpdate=!1,this._syncCamera(),e.add(i),this.pick=new Or(this.layer),on.star()},n.onCanvasCreate=function(){t.prototype.onCanvasCreate.call(this)},n.resizeCanvas=function(t){if(this.canvas){var e,n=this.getMap();e=t||n.getSize();var r=n.getDevicePixelRatio?n.getDevicePixelRatio():i.Browser.retina?2:1,o=this.canvas;o.height=r*e.height,o.width=r*e.width,this.layer._canvas&&o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.context.setSize(o.width,o.height)}},n.clearCanvas=function(){this.canvas&&this.context.clear()},n.prepareCanvas=function(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null},n.renderScene=function(t){var e=i.Util.now();if(e-this._renderTime>=16&&(this.layer._callbackBaseObjectAnimation(),this._renderTime=e),this._syncCamera(),t&&t.renderTarget){var n=t.renderTarget.fbo,r=n.width,a=n.height;this._renderTarget?(this._renderTarget.viewport.set(0,0,r,a),this._renderTarget.scissor.set(0,0,r,a)):(this._renderTarget=new o.WebGLRenderTarget(r,a,{depthBuffer:!1}),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));var s=this.context.properties.get(this._renderTarget),u=s[Ir];s[Ir]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera),s[Ir]=u}else this.context.render(this.scene,this.camera);this.context.setRenderTarget(null),this.completeRender()},n.remove=function(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),t.prototype.remove.call(this)},n._syncCamera=function(){var t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements},n._createGLContext=function(t,e){for(var n=["webgl2","webgl","experimental-webgl"],r=null,i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r},e}(i.renderer.CanvasLayerRenderer);function Gr(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function Zr(t,e,n,r){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,r):t.coordinateToPoint(e,n,r)}Rr.registerRenderer("gl",Fr),i.registerWorkerAdapter&&i.registerWorkerAdapter("__maptalks.three__",'(function(e){"use strict";var t=r,n=r;function r(e,t,n){n=n||2;var r,v,h,u,l,x,c,d=t&&t.length,g=d?t[0]*n:e.length,y=i(e,0,g,n,!0),m=[];if(!y||y.next===y.prev)return m;if(d&&(y=function(e,t,n,r){var o,v,h,u=[];for(o=0,v=t.length;o<v;o++)(h=i(e,t[o]*r,o<v-1?t[o+1]*r:e.length,r,!1))===h.next&&(h.steiner=!0),u.push(p(h));for(u.sort(f),o=0;o<u.length;o++)s(u[o],n),n=a(n,n.next);return n}(e,t,y,n)),e.length>80*n){r=h=e[0],v=u=e[1];for(var M=n;M<g;M+=n)(l=e[M])<r&&(r=l),(x=e[M+1])<v&&(v=x),l>h&&(h=l),x>u&&(u=x);c=0!==(c=Math.max(h-r,u-v))?1/c:0}return o(y,m,n,r,v,c),m}function i(e,t,n,r,i){var a,o;if(i===R(e,t,n,r)>0)for(a=t;a<n;a+=r)o=A(a,e[a],e[a+1],o);else for(a=n-r;a>=t;a-=r)o=A(a,e[a],e[a+1],o);return o&&m(o,o.next)&&(z(o),o=o.next),o}function a(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!m(r,r.next)&&0!==y(r.prev,r,r.next))r=r.next;else{if(z(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function o(e,t,n,r,i,f,s){if(e){!s&&f&&function(e,t,n,r){var i=e;do{null===i.z&&(i.z=c(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,a,o,v,h,u=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,r=n,v=0,t=0;t<u&&(v++,r=r.nextZ);t++);for(h=u;v>0||h>0&&r;)0!==v&&(0===h||!r||n.z<=r.z)?(i=n,n=n.nextZ,v--):(i=r,r=r.nextZ,h--),a?a.nextZ=i:e=i,i.prevZ=a,a=i;n=r}a.nextZ=null,u*=2}while(o>1)}(i)}(e,r,i,f);for(var x,p,d=e;e.prev!==e.next;)if(x=e.prev,p=e.next,f?h(e,r,i,f):v(e))t.push(x.i/n),t.push(e.i/n),t.push(p.i/n),z(e),e=p.next,d=p.next;else if((e=p)===d){s?1===s?o(e=u(a(e),t,n),t,n,r,i,f,2):2===s&&l(e,t,n,r,i,f):o(a(e),t,n,r,i,f,1);break}}}function v(e){var t=e.prev,n=e,r=e.next;if(y(t,n,r)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(d(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&y(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function h(e,t,n,r){var i=e.prev,a=e,o=e.next;if(y(i,a,o)>=0)return!1;for(var v=i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,h=i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,u=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,l=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,f=c(v,h,t,n,r),s=c(u,l,t,n,r),x=e.prevZ,p=e.nextZ;x&&x.z>=f&&p&&p.z<=s;){if(x!==e.prev&&x!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,x.x,x.y)&&y(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,p!==e.prev&&p!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;x&&x.z>=f;){if(x!==e.prev&&x!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,x.x,x.y)&&y(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;p&&p.z<=s;){if(p!==e.prev&&p!==e.next&&d(i.x,i.y,a.x,a.y,o.x,o.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function u(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!m(i,o)&&M(i,r,r.next,o)&&S(i,o)&&S(o,i)&&(t.push(i.i/n),t.push(r.i/n),t.push(o.i/n),z(r),z(r.next),r=e=o),r=r.next}while(r!==e);return a(r)}function l(e,t,n,r,i,v){var h=e;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&g(h,u)){var l=Z(h,u);return h=a(h,h.next),l=a(l,l.next),o(h,t,n,r,i,v),void o(l,t,n,r,i,v)}u=u.next}h=h.next}while(h!==e)}function f(e,t){return e.x-t.x}function s(e,t){if(t=function(e,t){var n,r=t,i=e.x,a=e.y,o=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var v=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(v<=i&&v>o){if(o=v,v===i){if(a===r.y)return r;if(a===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===o)return n;var h,u=n,l=n.x,f=n.y,s=1/0;r=n;do{i>=r.x&&r.x>=l&&i!==r.x&&d(a<f?i:o,a,l,f,a<f?o:i,a,r.x,r.y)&&(h=Math.abs(a-r.y)/(i-r.x),S(r,e)&&(h<s||h===s&&(r.x>n.x||r.x===n.x&&x(n,r)))&&(n=r,s=h)),r=r.next}while(r!==u);return n}(e,t)){var n=Z(t,e);a(t,t.next),a(n,n.next)}}function x(e,t){return y(e.prev,e,t.prev)<0&&y(t.next,e,e.next)<0}function c(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function d(e,t,n,r,i,a,o,v){return(i-o)*(t-v)-(e-o)*(a-v)>=0&&(e-o)*(r-v)-(n-o)*(t-v)>=0&&(n-o)*(a-v)-(i-o)*(r-v)>=0}function g(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&M(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(S(e,t)&&S(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&n.next.y!==n.y&&i<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(y(e.prev,e,t.prev)||y(e,t.prev,t))||m(e,t)&&y(e.prev,e,e.next)>0&&y(t.prev,t,t.next)>0)}function y(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function m(e,t){return e.x===t.x&&e.y===t.y}function M(e,t,n,r){var i=w(y(e,t,n)),a=w(y(e,t,r)),o=w(y(n,r,e)),v=w(y(n,r,t));return i!==a&&o!==v||(!(0!==i||!b(e,n,t))||(!(0!==a||!b(e,r,t))||(!(0!==o||!b(n,e,r))||!(0!==v||!b(n,t,r)))))}function b(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function w(e){return e>0?1:e<0?-1:0}function S(e,t){return y(e.prev,e,e.next)<0?y(e,t,e.next)>=0&&y(e,e.prev,t)>=0:y(e,t,e.prev)<0||y(e,e.next,t)<0}function Z(e,t){var n=new F(e.i,e.x,e.y),r=new F(t.i,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,a.next=r,r.prev=a,r}function A(e,t,n,r){var i=new F(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function z(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function F(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(e,t,n,r){for(var i=0,a=t,o=n-r;a<n;a+=r)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}function q(e,t,n){var r=t[0],i=t[1],a=n[0]-r,o=n[1]-i;if(0!==a||0!==o){var v=((e[0]-r)*a+(e[1]-i)*o)/(a*a+o*o);v>1?(r=n[0],i=n[1]):v>0&&(r+=a*v,i+=o*v)}return(a=e[0]-r)*a+(o=e[1]-i)*o}function P(e,t,n,r,i){for(var a,o=r,v=t+1;v<n;v++){var h=q(e[v],e[t],e[n]);h>o&&(a=v,o=h)}o>r&&(a-t>1&&P(e,t,a,r,i),i.push(e[a]),n-a>1&&P(e,a,n,r,i))}function L(e,t){var n=e.length-1,r=[e[0]];return P(e,0,n,t,r),r.push(e[n]),r}function V(e,t,n){if(e.length<=2)return e;var r=void 0!==t?t*t:1;return e=L(e=n?e:function(e,t){for(var n,r,i,a,o,v=e[0],h=[v],u=1,l=e.length;u<l;u++)n=e[u],i=v,a=void 0,o=void 0,a=(r=n)[0]-i[0],o=r[1]-i[1],a*a+o*o>t&&(h.push(n),v=n);return v!==n&&h.push(n),h}(e,r),r)}function B(e,t){return e[0]*t[0]+e[1]*t[1]}function E(e,t){var n=t[0],r=t[1],i=Math.sqrt(n*n+r*r);return e[0]=n/i,e[1]=r/i,e}function U(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}function H(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function I(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function O(e,t){var n=t[0],r=t[1],i=t[2],a=Math.sqrt(n*n+r*r+i*i);return e[0]=n/a,e[1]=r/a,e[2]=i/a,e}function T(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],v=n[1],h=n[2];return e[0]=i*h-a*v,e[1]=a*o-r*h,e[2]=r*v-i*o,e}r.deviation=function(e,t,n,r){var i=t&&t.length,a=i?t[0]*n:e.length,o=Math.abs(R(e,0,a,n));if(i)for(var v=0,h=t.length;v<h;v++){var u=t[v]*n,l=v<h-1?t[v+1]*n:e.length;o-=Math.abs(R(e,u,l,n))}var f=0;for(v=0;v<r.length;v+=3){var s=r[v]*n,x=r[v+1]*n,c=r[v+2]*n;f+=Math.abs((e[s]-e[c])*(e[x+1]-e[s+1])-(e[s]-e[x])*(e[c+1]-e[s+1]))}return 0===o&&0===f?0:Math.abs((f-o)/o)},r.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var a=0;a<e[i].length;a++)for(var o=0;o<t;o++)n.vertices.push(e[i][a][o]);i>0&&(r+=e[i-1].length,n.holes.push(r))}return n},t.default=n;var W=[];function j(e,t,n,r){var i=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(t,n),a=Math.acos(i)*r;return U(W,n,t,-i),function(e,t){var n=t[0],r=t[1],i=t[2],a=Math.sqrt(n*n+r*r+i*i);e[0]=n/a,e[1]=r/a,e[2]=i/a}(W,W),function(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n}(e,t,Math.cos(a)),U(e,e,W,Math.sin(a)),e}function k(e,t,n,r,i,a,o,v,h,u){var l=o-i,f=v-a,s=(l*(t-a)-f*(e-i))/(f*(n-e)-l*(r-t));return h&&(h[u=u||0]=e+s*(n-e),h[u+1]=t+s*(r-t)),s}function _(e,t,n){if(n-t<3)return 0;for(var r=0,i=2*(n-1),a=2*t;a<2*n;){var o=e[i],v=e[i+1],h=e[a],u=e[a+1];i=a,a+=2,r+=o*u-h*v}return r}function D(e,n,r){return void 0===r&&(r=2),t(e,n,r)}var C=[],G=[],J=[];function K(e,t,n,r,i,a,o,v,h){var u,l,f,s=null!=o,x=i,c=null;s&&(c=new Uint32Array(r-n));for(var p=[],d=n;d<r;d++){var g=d===r-1?n:d+1,y=d===n?r-1:d-1,m=e[2*y],M=e[2*y+1],b=e[2*d],w=e[2*d+1],S=e[2*g],Z=e[2*g+1];C[0]=b-m,C[1]=w-M,G[0]=S-b,G[1]=Z-w,E(C,C),E(G,G),s&&(c[d]=x);var A=!1,z=void 0,F=void 0;if(v||d!==n)if(v||d!==r-1){H(J,G,C);var R=J[1];J[1]=-J[0],J[0]=R,E(J,J);var q=B(J,G),P=Math.sqrt(1-q*q),L=a*Math.min(10,1/P);if(s&&1/P>o&&a*q<0){var V=b+J[0]*a,U=w+J[1]*a,I=Math.acos(P)/2,O=Math.tan(I)*Math.abs(a);t[2*x]=V+J[1]*O,t[2*x+1]=U-J[0]*O,t[2*++x]=V-J[1]*O,t[2*x+1]=U+J[0]*O,x++}else z=b+J[0]*L,F=w+J[1]*L,A=!0;if(A){if(h&&null!=u){var T=k(m,M,u,l,b,w,z,F,p,0);T>=-.01&&T<=1.01&&(t[2*f]=z=p[0],t[2*f+1]=F=p[1])}u=t[2*x]=z,l=t[2*x+1]=F,f=x,x++}}else J[0]=C[1],J[1]=-C[0],E(J,J),z=b+J[0]*a,F=w+J[1]*a,A=!0;else J[0]=G[1],J[1]=-G[0],E(J,J),u=t[2*x]=b+J[0]*a,l=t[2*x+1]=w+J[1]*a,f=x,x++}return c}function N(e,t,n,r,i,a,o,v){var h=null!=o,u=i,l=null;h&&(l=new Uint32Array(r-n));for(var f=n;f<r;f++){var s=f===r-1?n:f+1,x=f===n?r-1:f-1,c=e[2*x],p=e[2*x+1],d=e[2*f],g=e[2*f+1],y=e[2*s],m=e[2*s+1];if(C[0]=d-c,C[1]=g-p,G[0]=y-d,G[1]=m-g,E(C,C),E(G,G),h&&(l[f]=u),v||f!==n)if(v||f!==r-1){H(J,G,C);var M=J[1];J[1]=-J[0],J[0]=M,E(J,J);var b=B(J,G),w=Math.sqrt(1-b*b),S=a*Math.min(10,1/w);if(h&&1/w>o&&a*b<0){var Z=d+J[0]*a,A=g+J[1]*a,z=Math.acos(w)/2,F=Math.tan(z)*Math.abs(a);t[2*u]=Z+J[1]*F,t[2*u+1]=A-J[0]*F,t[2*++u]=Z-J[1]*F,t[2*u+1]=A+J[0]*F,u++}else t[2*u]=d+J[0]*S,t[2*u+1]=g+J[1]*S,u++}else J[0]=C[1],J[1]=-C[0],E(J,J),t[2*u]=d+J[0]*a,t[2*u+1]=g+J[1]*a,u++;else J[0]=G[1],J[1]=-G[0],E(J,J),t[2*u]=d+J[0]*a,t[2*u+1]=g+J[1]*a,u++}return l}function Q(e,t,n,r,i){var a=null!=r?[]:new Float32Array(e.length);if(K(e,a,0,t&&t.length?t[0]:e.length/2,0,n,r,i,!0),t)for(var o=0;o<t.length;o++){var v=t[o];K(e,a,v,t[o+1]||e.length/2,null!=r?a.length/2:v,n,r,i,!1)}return a}function X(e,t,n,r){for(var i=0;i<Math.floor((r-n)/2);i++)for(var a=0;a<t;a++){var o=(i+n)*t+a,v=(r-i-1)*t+a,h=e[o];e[o]=e[v],e[v]=h}return e}function Y(e,t){var n=e.length/2,r=0,i=t&&t.length?t[0]:n;_(e,r,i)>0&&X(e,2,r,i);for(var a=1;a<(t?t.length:0)+1;a++)_(e,r=t[a-1],i=t[a]||n)<0&&X(e,2,r,i)}function $(e){e.depth=e.depth||1,e.bevelSize=e.bevelSize||0,e.bevelSegments=null==e.bevelSegments?2:e.bevelSegments,e.smoothBevel=e.smoothBevel||!1,e.simplify=e.simplify||0,null==e.smoothSide&&(e.smoothSide="auto"),null==e.smoothSideThreshold&&(e.smoothSideThreshold=.9),"number"==typeof e.depth&&(e.bevelSize=Math.min(e.bevelSegments>0?e.bevelSize:0,e.depth/2)),e.bevelSize>0||(e.bevelSegments=0),e.bevelSegments=Math.round(e.bevelSegments);var t=e.boundingRect;if(e.translate=e.translate||[0,0],e.scale=e.scale||[1,1],e.fitRect){var n=null==e.fitRect.x?t.x||0:e.fitRect.x,r=null==e.fitRect.y?t.y||0:e.fitRect.y,i=e.fitRect.width,a=e.fitRect.height;null==i?null!=a?i=a/t.height*t.width:(i=t.width,a=t.height):null==a&&(a=i/t.width*t.height),e.scale=[i/t.width,a/t.height],e.translate=[(n-t.x)*e.scale[0],(r-t.y)*e.scale[1]]}}var ee=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function te(e,t,n){for(var r=0,i=e[t],a=e[t+1],o=i,v=a,h=t+2;h<n;h+=2){var u=e[h],l=e[h+1];r+=Math.sqrt((u-i)*(u-i)+(l-a)*(l-a)),i=u,a=l}return r+=Math.sqrt((i-o)*(i-o)+(a-v)*(a-v))}function ne(e,t,n,r,i,a){var o=t.vertices,v=t.topVertices,h=t.splittedMap,u=t.depth,l=t.rect,f=r-n,s=a.smoothBevel?1:2,x=Math.min(u/2,a.bevelSize),c=a.bevelSegments,p=i.vertex,d=i.ringPerimeter,g=Math.max(l.width,l.height,u,d);function y(e){var t=(e+1)%f,n=o[2*e],r=o[2*e+1],i=o[2*t],a=o[2*t+1];return n===i&&r===a}if(x>0)for(var m=[0,0,1],M=[],b=[0,0,-1],w=[],S=0,Z=new Float32Array(f),A=0;A<2;A++)for(var z=0===A?u-x:x,F=0;F<=c*s;F++){for(var R=0,q=void 0,P=void 0,L=0;L<f;L++){var V=2*(L%f+n),B=h?2*h[V/2]:V;M[0]=o[V]-v[B],M[1]=o[V+1]-v[B+1],M[2]=0;var E=Math.sqrt(M[0]*M[0]+M[1]*M[1]);M[0]/=E,M[1]/=E;var U=(Math.floor(F/s)+F%s)/c;0===A?j(w,m,M,U):j(w,M,b,U);var H=0===A?U:1-U,I=x*Math.sin(H*Math.PI/2),O=E*Math.cos(H*Math.PI/2),T=x*E/Math.sqrt(I*I+O*O),W=w[0]*T+v[B],k=w[1]*T+v[B+1],_=w[2]*T+z;if(e.position[3*i.vertex]=W,e.position[3*i.vertex+1]=k,e.position[3*i.vertex+2]=_,L>0&&(R+=Math.sqrt((q-W)*(q-W)+(P-k)*(P-k))),F>0||A>0){var D=3*(i.vertex-f),C=e.position[D],G=e.position[D+1],J=e.position[D+2];Z[L]+=Math.sqrt((C-W)*(C-W)+(G-k)*(G-k)+(J-_)*(J-_))}if(e.uv[2*i.vertex]=R/g,e.uv[2*i.vertex+1]=Z[L]/g,q=W,P=k,i.vertex++,!y(L)&&(s>1&&F%s||1===s&&F>=1))for(var K=0;K<6;K++){var N=(ee[K][0]+L)%f,Q=ee[K][1]+S;e.indices[i.index++]=(Q-1)*f+N+p}}S++}else for(var X=0;X<2;X++)for(var Y=0===X?u-x:x,$=0,te=void 0,ne=void 0,re=0;re<f;re++){var ie=2*(re%f+n),ae=o[ie],oe=o[ie+1];e.position[3*i.vertex]=ae,e.position[3*i.vertex+1]=oe,e.position[3*i.vertex+2]=Y,re>0&&($+=Math.sqrt((te-ae)*(te-ae)+(ne-oe)*(ne-oe))),e.uv[2*i.vertex]=$/g,e.uv[2*i.vertex+1]=Y/g,te=ae,ne=oe,i.vertex++}for(var ve=x>0?c*s+1:1,he=0;he<f;he++)if(!y(he))for(var ue=0;ue<6;ue++){var le=(ee[ue][0]+he)%f,fe=ee[ue][1]+ve;e.indices[i.index++]=(fe-1)*f+le+p}}function re(e,t,n,r){var i=e.indices,a=e.topVertices,o=e.rect,v=e.depth;if(!(a.length<=4)){for(var h=n.vertex,u=i.length,l=0;l<u;l++)t.indices[n.index++]=h+i[l];for(var f=Math.max(o.width,o.height),s=0;s<(r.excludeBottom?1:2);s++)for(var x=0;x<a.length;x+=2){var c=a[x],p=a[x+1];t.position[3*n.vertex]=c,t.position[3*n.vertex+1]=p,t.position[3*n.vertex+2]=(1-s)*v,t.uv[2*n.vertex]=(c-o.x)/f,t.uv[2*n.vertex+1]=(p-o.y)/f,n.vertex++}if(!r.excludeBottom)for(var d=a.length/2,g=0;g<u;g+=3)for(var y=0;y<3;y++)t.indices[n.index++]=h+d+i[g+2-y]}}function ie(e,t,n,r){var i=null==n||"auto"===n;if(!0===n)return{vertices:e,holes:t};for(var a=[],o=t&&[],v=e.length/2,h=[],u=[],l=[],f=0,s=0,x=(t?t.length:0)+1,c=0;c<x;c++){0===c?s=t&&t.length?t[0]:v:(f=t[c-1],s=t[c]||v);for(var p=f;p<s;p++){var d=e[2*p],g=e[2*p+1],y=p===s-1?f:p+1,m=e[2*y],M=e[2*y+1];if(i){var b=p===f?s-1:p-1,w=e[2*b],S=e[2*b+1];h[0]=w-d,h[1]=S-g,u[0]=m-d,u[1]=M-g,E(h,h),E(u,u),1-(.5*B(h,u)+.5)>r?(a.push(d,g),l.push(p)):(a.push(d,g,d,g),l.push(p,p))}else a.push(d,g,d,g),l.push(p,p)}c<x-1&&o&&o.push(a.length/2)}return{vertices:new Float32Array(a),splittedMap:l,holes:o}}function ae(e,t){for(var n=0,r=0,i=0;i<e.length;i++){var a=e[i],o=a.indices,v=a.vertices,h=a.splittedMap,u=a.topVertices,l=a.depth,f=Math.min(l/2,t.bevelSize)>0?t.bevelSegments:0,s=e[i].holes||[];n+=o.length*(t.excludeBottom?1:2),r+=u.length/2*(t.excludeBottom?1:2);for(var x=2+2*f,c=0,p=0,d=0;d<s.length+1;d++){0===d?p=s.length?s[0]:v.length/2:(c=s[d-1],p=s[d]||v.length/2),n+=6*((h?h[p-1]+1:p)-(h?h[c]:c))*(x-1);var g=p-c;r+=g*x+(t.smoothBevel?0:f*g*2)}}for(var y={position:new Float32Array(3*r),indices:new(r>65535?Uint32Array:Uint16Array)(n),uv:new Float32Array(2*r)},m={vertex:0,index:0,ringPerimeter:0},M=0;M<e.length;M++)re(e[M],y,m,t);for(var b=0;b<e.length;b++){var w=e[b],S=w.holes,Z=w.vertices.length/2,A=0,z=S&&S.length?S[0]:Z;if(m.ringPerimeter=te(e[b].topVertices,A,z),ne(y,e[b],A,z,m,t),S)for(var F=0;F<S.length;F++)A=S[F],z=S[F+1]||Z,m.ringPerimeter=te(e[b].topVertices,A,z),ne(y,e[b],A,z,m,t)}for(var R=0;R<y.uv.length;R++){var q=y.uv[R];q>0&&Math.round(q)===q?y.uv[R]=1:y.uv[R]=q%1}return y.normal=function(e,t){function n(e,t,n,r){e[0]=t,e[1]=n,e[2]=r}for(var r=[],i=[],a=[],o=[],v=[],h=[],u=e.length,l=new Float32Array(t.length),f=0;f<u;){var s=3*e[f++],x=3*e[f++],c=3*e[f++];n(r,t[s],t[s+1],t[s+2]),n(i,t[x],t[x+1],t[x+2]),n(a,t[c],t[c+1],t[c+2]),I(o,r,i),I(v,i,a),T(h,o,v);for(var p=0;p<3;p++)l[s+p]=l[s+p]+h[p],l[x+p]=l[x+p]+h[p],l[c+p]=l[c+p]+h[p]}for(var d=0;d<l.length;)n(h,l[d],l[d+1],l[d+2]),O(h,h),l[d++]=h[0],l[d++]=h[1],l[d++]=h[2];return l}(y.indices,y.position),y.boundingRect=e[0]&&e[0].rect,y}function oe(e,t,n){for(var r=n.lineWidth,i=e.length,a=new Float32Array(2*i),o=n.translate||[0,0],v=n.scale||[1,1],h=0,u=0;h<i;h++)a[u++]=e[h][0]*v[0]+o[0],a[u++]=e[h][1]*v[1]+o[1];_(a,0,i)<0&&X(a,2,0,i);var l=[],f=[],s=n.miterLimit,x=N(a,f,0,i,0,-r/2,s,!1);X(a,2,0,i);for(var c=N(a,l,0,i,0,-r/2,s,!1),p=(l.length+f.length)/2,d=new Float32Array(2*p),g=0,y=f.length/2,m=0;m<f.length;m++)d[g++]=f[m];for(var M=0;M<l.length;M++)d[g++]=l[M];for(var b=new(p>65535?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i))),w=0,S=0;S<i-1;S++){var Z=S+1;b[w++]=y-1-x[S],b[w++]=y-1-x[S]-1,b[w++]=c[S]+1+y,b[w++]=y-1-x[S],b[w++]=c[S]+1+y,b[w++]=c[S]+y,c[Z]-c[S]==2?(b[w++]=c[S]+2+y,b[w++]=c[S]+1+y,b[w++]=y-x[Z]-1):x[Z]-x[S]==2&&(b[w++]=c[Z]+y,b[w++]=y-1-(x[S]+1),b[w++]=y-1-(x[S]+2))}var A=n.bevelSize>0?Q(d,[],n.bevelSize,null,!0):d,z=n.boundingRect,F=ie(d,null,n.smoothSide,n.smoothSideThreshold);return{vertices:F.vertices,rawVertices:A,splittedMap:F.splittedMap,indices:b,topVertices:A,rect:{x:z.x*v[0]+o[0],y:z.y*v[1]+o[1],width:z.width*v[0],height:z.height*v[1]},depth:"function"==typeof n.depth?n.depth(t):n.depth,holes:[]}}function ve(e,t){for(var n=[],r=0;r<e.length;r++){for(var i=e[r],a=[],o=i.length,v=i[o-1][0],h=i[o-1][1],u=0,l=0;l<o;l++){var f=i[l][0],s=i[l][1],x=f-v,c=s-h;(u+=Math.sqrt(x*x+c*c))>t&&(a.push(i[l]),u=0),v=f,h=s}a.length>=3&&n.push(a)}return n.length>0?n:null}function he(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r];(i=V(i,t,!0)).length>=3&&n.push(i)}return n.length>0?n:null}function ue(e,t,n){for(var r=0;r<e.length;r++)t[0]=Math.min(e[r][0],t[0]),t[1]=Math.min(e[r][1],t[1]),n[0]=Math.max(e[r][0],n[0]),n[1]=Math.max(e[r][1],n[1])}var le={x:0,y:0},fe={x:0,y:0};function se(e,t,n,r){for(var i=e.length,a=0;a<i;a++){var o=e[a].data;t=e[a].center||t;for(var v=0,h=o.length;v<h;v++)for(var u=o[v],l=0,f=u.length;l<f;l++)e[a].data[v][l]=xe(u[l],t,n,r)}}function xe(e,t,n,r){for(var i,a=[],o=0,v=(i=n?new Float64Array(e):new Float32Array(e)).length;o<v;o+=2){var h=i[o],u=i[o+1];if(t&&n&&r){le.x=h,le.y=u;var l=be(le,fe);le.x=l.x,le.y=l.y,h=(l=we(r,le,n,fe)).x,u=l.y,h-=t[0],u-=t[1]}a.push([h,u])}return a}function ce(e,t){void 0===t&&(t=!1);for(var n=e.length,r=[],i=[],a=[],o=0,v=0,h=0,u=0,l=0;l<n;l++){var f=t?de(e[l]):pe(e[l]),s=e[l].bottomHeight||0,x=f.position,c=f.normal,p=f.uv,d=f.indices;i.push(f);var g=d.length/3;a[l]=[o+1,o+g],o+=g;var y=x.length/3,m=c.length/3,M=p.length/2;r[l]={position:{middleZ:s+(e[l].height||0)/2,count:y,start:v,end:v+3*y},normal:{count:m,start:h,end:h+3*m},uv:{count:M,start:u,end:u+2*M},hide:!1},v+=3*y,h+=3*m,u+=2*M}var b=function(e){for(var t={},n={},r=0;r<e.length;++r){var i=e[r];for(var a in i)void 0===t[a]&&(t[a]=[],n[a]=0),t[a].push(i[a]),n[a]+=i[a].length}var o={},v=0,h=[];for(var u in t)if("indices"===u)for(var l=t[u],f=0,s=l.length;f<s;f++){for(var x=l[f],c=0,p=x.length;c<p;c++)h.push(x[c]+v);v+=t.position[f].length/3}else{var d=ge(t[u],n[u]);if(!d)return null;o[u]=d}return o.indices=new Uint32Array(h),o}(i),w=b.position,S=b.normal,Z=b.uv,A=b.indices;return{position:w.buffer,normal:S.buffer,uv:Z.buffer,indices:A.buffer,faceMap:a,geometriesAttributes:r}}function pe(e){var n=e.data,r=e.height,i=e.bottomHeight,a=function(e,n){n=Object.assign({},n);for(var r=[1/0,1/0],i=[-1/0,-1/0],a=0;a<e.length;a++)ue(e[a][0],r,i);n.boundingRect=n.boundingRect||{x:r[0],y:r[1],width:i[0]-r[0],height:i[1]-r[1]},$(n);for(var o=[],v=n.translate||[0,0],h=n.scale||[1,1],u=n.boundingRect,l={x:u.x*h[0]+v[0],y:u.y*h[1]+v[1],width:u.width*h[0],height:u.height*h[1]},f=Math.min(u.width,u.height)/1e5,s=0;s<e.length;s++){var x=ve(e[s],f);if(x){var c=n.simplify/Math.max(h[0],h[1]);if(c>0&&(x=he(x,c)),x){for(var p=t.flatten(x),d=p.vertices,g=p.holes,y=p.dimensions,m=0;m<d.length;)d[m]=d[m++]*h[0]+v[0],d[m]=d[m++]*h[1]+v[1];if(Y(d,g),2!==y)throw new Error("Only 2D polygon points are supported");var M=n.bevelSize>0?Q(d,g,n.bevelSize,null,!0):d,b=D(M,g,y),w=ie(d,g,n.smoothSide,n.smoothSideThreshold);o.push({indices:b,vertices:w.vertices,rawVertices:d,topVertices:M,holes:w.holes,splittedMap:w.splittedMap,rect:l,depth:"function"==typeof n.depth?n.depth(s):n.depth})}}}return ae(o,n)}(n,{depth:r}),o=a.position,v=a.normal,h=a.uv,u=a.indices;return ye(o,i),{position:o,normal:v,uv:h,indices:u}}function de(e){var t=e.data,n=e.height,r=e.width,i=e.bottomHeight,a=function(e,t){t=Object.assign({},t);for(var n=[1/0,1/0],r=[-1/0,-1/0],i=0;i<e.length;i++)ue(e[i],n,r);t.boundingRect=t.boundingRect||{x:n[0],y:n[1],width:r[0]-n[0],height:r[1]-n[1]},$(t);var a=t.scale||[1,1];null==t.lineWidth&&(t.lineWidth=1),null==t.miterLimit&&(t.miterLimit=2);for(var o=[],v=0;v<e.length;v++){var h=e[v],u=t.simplify/Math.max(a[0],a[1]);u>0&&(h=V(h,u,!0)),o.push(oe(h,v,t))}return ae(o,t)}(t,{lineWidth:r,depth:n}),o=a.position,v=a.normal,h=a.uv,u=a.indices;return ye(o,i),{position:o,normal:v,uv:h,indices:u}}function ge(e,t){for(var n=new Float32Array(t),r=0,i=0;i<e.length;++i)n.set(e[i],r),r+=e[i].length;return n}function ye(e,t){if(void 0!==t&&"number"==typeof t&&0!==t)for(var n=0,r=e.length;n<r;n+=3)e[n+2]+=t}var me=Math.PI/180,Me=6378137*Math.PI/180;function be(e,t){var n,r=85.0511287798,i=e.x,a=Math.max(Math.min(r,e.y),-r);n=0===a?0:Math.log(Math.tan((90+a)*me/2))/me;var o=i*Me,v=n*Me;return t?(t.x=o,t.y=v,t):{x:o,y:v}}function we(e,t,n,r){var i=e[0]*(t.x-e[2])/n,a=-e[1]*(t.y-e[3])/n;return r?(r.x=i,r.y=a,r):{x:i,y:a}}function Se(e){void 0===e&&(e=[]);for(var t=e.length,n=new Float32Array(3*t),r=0;r<t;r++){var i=e[r],a=3*r;n[a]=i[0],n[a+1]=i[1]}return n}function Ze(e){for(var t=new Float32Array(2*e.length-6),n=0,r=0,i=e.length/3;r<i;r++){var a=e[3*r],o=e[3*r+1],v=e[3*r+2];if(r>0&&r<i-1){var h=3*n;t[h]=a,t[h+1]=o,t[h+2]=v,n++}var u=3*n;t[u]=a,t[u+1]=o,t[u+2]=v,n++}return t}function Ae(e){var t=0,n=e.length;if(1===n)return e[0];for(var r=0;r<n;r++)t+=e[r].length;for(var i=new Float32Array(t),a=0,o=0;o<n;o++)i.set(e[o],a),a+=e[o].length;return i}e.initialize=function(){},e.onmessage=function(e,t){var n=e.data,r=n.type,i=n.datas,a=n.glRes,o=n.matrix,v=n.center;if("ExtrudePolygons"===r){se(i,v,a,o);var h=ce(i);t(null,h,[h.position,h.normal,h.uv,h.indices])}else if("ExtrudeLines"===r){for(var u=0,l=i.length;u<l;u++)for(var f=0,s=i[u].data.length;f<s;f++)i[u].data[f]=xe(i[u].data[f],i[u].center||v,a,o);var x=ce(i,!0);t(null,x,[x.position,x.normal,x.uv,x.indices])}else if("ExtrudePolygon"===r){var c=[],p=[];i.forEach((function(e){var t=[e];se(t,v,a,o);var n=ce(t),r=n.position,i=n.normal,h=n.uv,u=n.indices;c.push({id:e.id,position:r,normal:i,uv:h,indices:u}),p.push(r,i,h,u)})),t(null,c,p)}else if("Line"===r||"FatLine"===r){for(var d=[],g=[],y=0,m=i.length;y<m;y++){for(var M=[],b=0,w=i[y].data.length;b<w;b++){i[y].data[b]=xe(i[y].data[b],i[y].center||v,a,o);var S=Se(i[y].data[b]);M.push(Ze(S))}var Z=Ae(M);ye(Z,i[y].bottomHeight),d.push({id:i[y].id,position:Z.buffer}),g.push(Z.buffer)}t(null,d,g)}else if("Lines"===r||"FatLines"===r){for(var A=0,z=[],F=[],R=0,q=[],P=0,L=i.length;P<L;P++){for(var V=0,B=0,E=i[P].data.length;B<E;B++){i[P].data[B]=xe(i[P].data[B],i[P].center||v,a,o);var U=Se(i[P].data[B]);ye(U,i[P].bottomHeight),V+=U.length/3*2-2,q.push(Ze(U))}var H=V;z[P]=[A,A+H],A+=H,F[P]={position:{count:V,start:R,end:R+3*V},hide:!1},"FatLines"===r&&(F[P].instanceStart={count:V,start:R,end:R+3*V},F[P].instanceEnd={count:V,start:R,end:R+3*V}),R+=3*V}var I=Ae(q);t(null,{id:i.id,position:I.buffer,geometriesAttributes:F,faceMap:z},[I.buffer])}else if("ExtrudeLine"===r){for(var O=0,T=i.length;O<T;O++)for(var W=0,j=i[O].data.length;W<j;W++)i[O].data[W]=xe(i[O].data[W],i[O].center||v,a,o);var k=[],_=[];i.forEach((function(e){var t=ce([e],!0),n=t.position,r=t.normal,i=t.uv,a=t.indices;k.push({id:e.id,position:n,normal:r,uv:i,indices:a}),_.push(n,r,i,a)})),t(null,k,_)}},Object.defineProperty(e,"__esModule",{value:!0})})'),t.BaseObject=_,t.ExtrudeUtil=Me,t.GeoJSONUtil=N,t.GeoUtil=_n,t.IdentifyUtil=Bn,t.LineMaterial=p,t.LineUtil=ze,t.MergeGeometryUtil=C,t.MergedMixin=Cn,t.ThreeLayer=Rr,t.ThreeRenderer=Fr,t.geometryExtrude=se,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.three v0.20.0")}));
