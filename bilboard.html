<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>bilboardTest</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.6/build/dat.gui.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks/dist/maptalks.css">
    <script type="text/javascript" src="/js/maptalks/maptalks_0.49.4.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.104.0/build/three.min.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks.three@latest/dist/maptalks.three.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/three@0.104.0/examples/js/libs/stats.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/zrender@4.3.1/dist/zrender.min.js"></script>

    <style>
        html,
        body {
            margin: 0px;
            height: 100%;
            width: 100%;
        }

        #map,
        #zr {
            width: 100%;
            height: 100%;
            background-color: #000;
        }
    </style>
</head>

<body>
    
    <div id="map"></div>
    <script>

        function initData(scene) {
           
            let canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;

            var bw = 400;
            var bh = 400;
            var p = 10;
            var cw = bw + (p*2) + 1;
            var ch = bh + (p*2) + 1;
            var context = canvas.getContext("2d");
            function drawBoard(){
                for (var x = 0; x <= bw; x += 40) {
                    context.moveTo(0.5 + x + p, p);
                    context.lineTo(0.5 + x + p, bh + p);
                }
                for (var x = 0; x <= bh; x += 40) {
                    context.moveTo(p, 0.5 + x + p);
                    context.lineTo(bw + p, 0.5 + x + p);
                }
                context.strokeStyle = "red";
                context.stroke();
            }
            drawBoard();
            return context;
        }

        

        var map = new maptalks.Map("map", {
            center: [129.15158, 35.15361],
            zoom: 15,
            pitch: 70,
            bearing: 180,

            centerCross: true,
            doubleClickZoom: false,
            baseLayer: new maptalks.TileLayer('tile', {
                urlTemplate: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
                subdomains: ['a', 'b', 'c', 'd'],
                attribution: '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>'
            })
        });

        map.on('click', e => {
            console.log(e.coordinate.toArray());
        });
        
        var threeLayer = new maptalks.ThreeLayer('t', {
            forceRenderOnMoving: true,
            forceRenderOnRotating: true,
            // animation: true
        });


        threeLayer.prepareToDraw = function (gl, scene, camera) {
            stats = new Stats();
            stats.domElement.style.zIndex = 100;
            document.getElementById('map').appendChild(stats.domElement);

            var light = new THREE.DirectionalLight(0xffffff);
            light.position.set(0, -10, 10).normalize();
            scene.add(light);

            let context = initData(scene);

            const texture = new THREE.CanvasTexture(context.canvas);

            const material = new THREE.MeshBasicMaterial({
            map: texture,
            });

            const geometry = new THREE.BoxGeometry(1, 0.0001, 1);
            const cube = new THREE.Mesh(geometry, material);
            let coord = [129.15158, 35.15361];
            let ccoord = threeLayer.coordinateToVector3(new maptalks.Coordinate(coord));
            cube.position.x = ccoord.x;
            cube.position.y = ccoord.y;
            cube.position.z = 1;

            scene.add(cube);


        };
        threeLayer.addTo(map);


        function animation() {
            // layer animation support Skipping frames
            threeLayer._needsUpdate = !threeLayer._needsUpdate;
            if (threeLayer._needsUpdate) {
                threeLayer.renderScene();
            }
            stats.update();
            requestAnimationFrame(animation);
        }


    </script>
</body>

</html>